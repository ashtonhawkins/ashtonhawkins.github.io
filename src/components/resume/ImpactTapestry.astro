---
interface TapestryItem {
  label: string;
  value: string;
  timeseries?: number[];
}

const { items } = Astro.props as { items: TapestryItem[] };
const hasData = items.length > 0;
const methodologyBody = `Sparklines show relative movement for each outcome across the observed program window. Values are normalized to the first data point and rendered without vertical exaggeration.`;
---
{hasData && (
  <section class="flex flex-col gap-6" data-band data-motion>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-col gap-1">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Impact tapestry</span>
        <h2 class="text-lg font-semibold text-[color:var(--ink)]">Program indicators</h2>
      </div>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-[color:var(--keyline)] bg-[color:color-mix(in_lab,var(--surface) 94%, transparent)] px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)] transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] hover:text-[color:var(--ink)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-methodology-trigger
      >
        Methodology
      </button>
    </div>
    <div class="grid gap-3 md:grid-cols-2" role="list">
      {items.map((item) => (
        <div
          class="relative flex flex-col gap-3 overflow-hidden rounded-[var(--radius-3)] border border-[color:color-mix(in_lab,var(--ink) 10%, transparent)] bg-[color:color-mix(in_lab,var(--surface) 92%, transparent)] p-4"
          role="listitem"
        >
          <div class="flex items-center justify-between gap-3">
            <span class="text-sm font-semibold text-[color:var(--ink)]">{item.label}</span>
            <span class="text-base font-semibold text-[color:var(--ink)]">{item.value}</span>
          </div>
          {item.timeseries && item.timeseries.length > 1 ? (
            <div
              class="h-16 text-[color:var(--accent)]"
              data-sparkline
              data-width="160"
              data-height="48"
              data-points={JSON.stringify(item.timeseries)}
              data-label={`${item.label} trend`}
            ></div>
          ) : null}
        </div>
      ))}
    </div>
    <dialog
      data-methodology-dialog
      aria-labelledby="methodology-title"
      aria-describedby="methodology-body"
      class="backdrop:bg-[rgba(15,23,42,0.35)] backdrop:backdrop-blur-sm border-none bg-transparent p-0"
    >
      <form method="dialog" class="pointer-events-auto flex flex-col gap-4 rounded-[var(--radius-3)] border border-[color:var(--keyline)] bg-[color:var(--surface-alt)] p-6 text-sm text-[color:var(--ink-2)]">
        <div class="flex items-center justify-between gap-4">
          <h3 id="methodology-title" class="text-base font-semibold text-[color:var(--ink)]">Methodology</h3>
          <button type="submit" class="text-sm font-semibold text-[color:var(--accent)]">Close</button>
        </div>
        <p id="methodology-body" class="leading-relaxed">{methodologyBody}</p>
      </form>
    </dialog>
  </section>
)}
<script type="module">
  import { bootSparklines } from "../ui/Sparkline";

  const initSparklines = () => bootSparklines();

  const initDialog = () => {
    const trigger = document.querySelector<HTMLButtonElement>("[data-methodology-trigger]");
    const dialog = document.querySelector<HTMLDialogElement>("[data-methodology-dialog]");
    if (!trigger || !dialog) return;
    const close = () => {
      if (dialog.open) dialog.close();
      trigger.focus();
    };
    if (!dialog.dataset.bound) {
      dialog.dataset.bound = "true";
      dialog.addEventListener("cancel", (event) => {
        event.preventDefault();
        close();
      });
      dialog.addEventListener("click", (event) => {
        if (event.target === dialog) {
          close();
        }
      });
    }
    if (!trigger.dataset.bound) {
      trigger.dataset.bound = "true";
      trigger.addEventListener("click", () => {
        dialog.showModal();
        const focusable = dialog.querySelector<HTMLElement>("button[type='submit']");
        focusable?.focus();
      });
    }
  };

  initSparklines();
  initDialog();
  document.addEventListener("astro:page-load", () => {
    initSparklines();
    initDialog();
  });
</script>
