---
import { Sparkline } from "../ui/Sparkline";

interface TapestryItem {
  label: string;
  value: string;
  timeseries?: number[];
}

const { items } = Astro.props as { items: TapestryItem[] };
---
<section class="flex flex-col gap-4">
  <div class="flex flex-col gap-2">
    <h2 class="text-lg font-semibold text-[color:var(--ink)]">Impact Tapestry</h2>
    <p class="text-sm text-[color:var(--ink-2)]">Continuous telemetry stitched from experimentation, analytics, and operational instrumentation.</p>
  </div>
  <div class="relative">
    <div class="-mx-4 overflow-x-auto px-4" data-tapestry-scroll>
      <div class="flex snap-x snap-mandatory gap-3 pb-2">
        {items.map((item, index) => (
          <div
            class="snap-start rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_94%,transparent)] px-4 py-3 min-w-[12rem]"
            data-tapestry-chip
          >
            <div class="flex items-center justify-between gap-2 text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
              <span>{item.label}</span>
              <span class="text-[color:var(--accent)] font-semibold">{item.value}</span>
            </div>
            {item.timeseries && (
              <div class="mt-3 h-12 text-[color:var(--accent)]" aria-hidden="true">
                <div set:html={Sparkline({ values: item.timeseries, width: 160, height: 40 })}></div>
              </div>
            )}
          </div>
        ))}
        <button
          type="button"
          class="snap-start inline-flex min-w-[10rem] items-center justify-center gap-2 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_96%,transparent)] px-4 py-3 text-sm font-semibold text-[color:var(--ink)]"
          data-methodology-trigger
        >
          Methodology
          <span aria-hidden="true">?</span>
        </button>
      </div>
    </div>
    <dialog class="max-w-lg rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:var(--surface)] p-6 text-sm text-[color:var(--ink)] shadow-[0_24px_64px_-36px_rgba(12,20,32,0.6)]" data-methodology-dialog>
      <form method="dialog" class="flex flex-col gap-4">
        <h3 class="text-lg font-semibold">Methodology</h3>
        <p>Signals are normalized across analytics, CRM, and operational sources. Confidence gates enforce sample sizes above 1k sessions or stakeholder attestation.</p>
        <p>Each chip pairs a current indicator with a trailing sparkline to contextualize momentum. Values refresh weekly.</p>
        <button type="submit" class="self-end rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-4 py-2 text-sm font-semibold text-[color:var(--ink)]">Close</button>
      </form>
    </dialog>
  </div>
</section>
<script type="module">
const dialog = document.querySelector<HTMLDialogElement>('[data-methodology-dialog]');
const trigger = document.querySelector<HTMLButtonElement>('[data-methodology-trigger]');
if (trigger && dialog) {
  trigger.addEventListener('click', () => {
    if (typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  });
  dialog.addEventListener('cancel', (event) => {
    event.preventDefault();
    dialog.close();
  });
}
</script>
