---
interface TapestryItem {
  label: string;
  value: string;
  timeseries?: number[];
}

const { items } = Astro.props as { items: TapestryItem[] };

const buildSparklinePath = (values: number[]) => {
  if (!values || values.length === 0) return "";
  const width = 100;
  const height = 24;
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;
  const step = values.length > 1 ? width / (values.length - 1) : width;
  return values
    .map((value, index) => {
      const x = index * step;
      const normalized = (value - min) / range;
      const y = height - normalized * height;
      return `${index === 0 ? "M" : "L"}${x.toFixed(2)} ${y.toFixed(2)}`;
    })
    .join(" ");
};

const methodologyId = "impact-tapestry-methodology";
---

<section class="flex flex-col gap-4 rounded-3xl border border-border/60 bg-[color:var(--resume-surface-even)] p-6 shadow-soft">
  <div class="flex items-start justify-between gap-6">
    <div class="flex flex-col gap-1">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Impact Tapestry</span>
      <h2 class="text-lg font-semibold text-text-primary">Operating signals</h2>
    </div>
    <button
      type="button"
      class="shrink-0 rounded-full border border-border px-3 py-1 text-xs font-semibold text-text-secondary transition hover:border-accent hover:text-text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
      data-methodology-trigger
      aria-controls={methodologyId}
    >
      Methodology
    </button>
  </div>
  <div class="relative">
    <div class="flex snap-x snap-mandatory gap-3 overflow-x-auto pb-2">
      {items.map((item) => {
        const path = item.timeseries ? buildSparklinePath(item.timeseries) : "";
        return (
          <div class="snap-start rounded-2xl border border-border/50 bg-surface/70 px-4 py-3 shadow-soft">
            <div class="flex items-center justify-between gap-3">
              <span class="text-xs font-semibold uppercase tracking-[0.24em] text-text-muted">{item.label}</span>
              <span class="text-sm font-semibold text-text-primary">{item.value}</span>
            </div>
            {item.timeseries && (
              <svg class="mt-2 h-10 w-32" viewBox="0 0 100 24" role="img" aria-hidden="true">
                <path d={path} fill="none" stroke="currentColor" stroke-width="2" class="text-accent/70" />
              </svg>
            )}
          </div>
        );
      })}
    </div>
  </div>
  <dialog
    id={methodologyId}
    data-methodology-dialog
    class="max-w-md rounded-3xl border border-border bg-background p-6 text-left shadow-soft"
  >
    <div class="flex items-start justify-between gap-4">
      <div class="flex flex-col gap-2">
        <h3 class="text-base font-semibold text-text-primary">Signal sourcing</h3>
        <p class="text-sm text-text-secondary">
          Metrics reflect experimentation telemetry, analytics coverage, and governance readiness sampled quarterly.
          Confidence intervals indicate audit or PMO attestation.
        </p>
      </div>
      <button
        type="button"
        class="rounded-full border border-border px-3 py-1 text-xs font-semibold text-text-secondary transition hover:border-accent hover:text-text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
        data-methodology-close
      >
        Close
      </button>
    </div>
  </dialog>
</section>

<script type="module">
const bindMethodologyDialog = () => {
  const trigger = document.querySelector('[data-methodology-trigger]');
  const dialog = document.querySelector('[data-methodology-dialog]');
  const close = dialog?.querySelector('[data-methodology-close]');
  if (!dialog || !trigger || trigger.dataset.bound === 'true') return;
  trigger.dataset.bound = 'true';
  trigger.addEventListener('click', () => {
    if (typeof dialog.showModal === 'function') {
      dialog.showModal();
    }
  });
  close?.addEventListener('click', () => {
    dialog.close();
  });
  dialog.addEventListener('cancel', (event) => {
    event.preventDefault();
    dialog.close();
  });
};

bindMethodologyDialog();
document.addEventListener('astro:page-load', bindMethodologyDialog);
</script>
