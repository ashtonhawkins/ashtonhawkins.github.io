---
import { getSparklineData } from "../ui/Sparkline";

interface TapestryItem {
  label: string;
  value: string;
  timeseries?: number[];
}

const { items } = Astro.props as { items: TapestryItem[] };
---
<section class="flex flex-col gap-6" id="impact-tapestry">
  <div class="flex flex-col gap-2">
    <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Proof</span>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h2 class="text-lg font-semibold text-[color:var(--ink)]">Impact Tapestry</h2>
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_90%,transparent)] px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-methodology-open
      >
        Methodology
      </button>
    </div>
    <p class="max-w-3xl text-sm text-[color:var(--ink-2)]">Scroll-snap signals from acquisition, performance, and measurement pillars. Each sparkline is normalized to its own baseline.</p>
  </div>
  <div class="relative overflow-hidden rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_94%,transparent)]">
    <div class="absolute inset-0 -z-10 bg-[conic-gradient(from_90deg_at_1px_1px,rgba(12,20,32,0.04)_0deg,rgba(12,20,32,0.04)_90deg,transparent_90deg,transparent_180deg)] bg-[length:38px_38px]"></div>
    <div class="flex snap-x snap-mandatory gap-4 overflow-x-auto p-4" data-tapestry-track>
      {items.map((item) => {
        const spark = item.timeseries ? getSparklineData(item.timeseries, { width: 120, height: 32 }) : null;
        return (
          <div
            class="min-w-[220px] snap-start rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_92%,transparent)] px-4 py-3 text-sm shadow-[0_16px_40px_-36px_rgba(12,20,32,0.6)]"
          >
            <div class="flex items-baseline justify-between gap-2">
              <span class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">{item.label}</span>
              <span class="text-sm font-semibold text-[color:var(--ink)]">{item.value}</span>
            </div>
            {spark && (
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox={`0 0 ${spark.width} ${spark.height}`}
                width={spark.width}
                height={spark.height}
                role="img"
                aria-label={`${item.label} trend`}
                class="mt-2 text-[color:var(--accent)]"
              >
                <polyline
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  points={spark.points}
                />
              </svg>
            )}
          </div>
        );
      })}
    </div>
  </div>
  <div
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-6"
    role="none"
    data-methodology-dialog
  >
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="methodology-title"
      aria-describedby="methodology-copy"
      class="relative max-w-lg rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_18%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_96%,transparent)] p-6 shadow-[0_48px_120px_-60px_rgba(12,20,32,0.68)]"
    >
      <div class="flex items-center justify-between gap-4">
        <h3 id="methodology-title" class="text-base font-semibold text-[color:var(--ink)]">Measurement methodology</h3>
        <button
          type="button"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] text-sm text-[color:var(--ink)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-methodology-close
          aria-label="Close methodology dialog"
        >
          âœ•
        </button>
      </div>
      <div id="methodology-copy" class="mt-4 space-y-3 text-sm text-[color:var(--ink-2)]">
        <p>Signals span organic acquisition, experimentation, consent resilience, and performance hardening. Each data point is normalized by baseline to surface slope over absolute value.</p>
        <p>Inputs combine GA4 modeled conversions, Optimizely statistics, and platform telemetry. Confidential mode redacts sensitive cohorts but preserves directional lift.</p>
        <p class="confidential-only">Receipts and charts referencing protected programs are generalized when confidential mode is enabled.</p>
      </div>
    </div>
  </div>
</section>
<script type="module">
import { prefersReducedMotion } from "../../utils/motion";

const dialog = document.querySelector<HTMLElement>("[data-methodology-dialog]");
const openBtn = document.querySelector<HTMLButtonElement>("[data-methodology-open]");
const closeBtn = document.querySelector<HTMLButtonElement>("[data-methodology-close]");
let lastFocused: HTMLElement | null = null;

const focusable = () => (dialog ? Array.from(dialog.querySelectorAll<HTMLElement>("button, [href], input, select, textarea, [tabindex]:not([tabindex='-1'])")) : []);

const trapFocus = (event: KeyboardEvent) => {
  if (event.key !== "Tab" || !dialog) return;
  const items = focusable();
  if (!items.length) return;
  const first = items[0];
  const last = items[items.length - 1];
  if (event.shiftKey && document.activeElement === first) {
    event.preventDefault();
    last.focus();
  } else if (!event.shiftKey && document.activeElement === last) {
    event.preventDefault();
    first.focus();
  }
};

const openDialog = () => {
  if (!dialog) return;
  lastFocused = document.activeElement instanceof HTMLElement ? document.activeElement : null;
  dialog.classList.remove("hidden");
  document.body.style.overflow = "hidden";
  document.addEventListener("keydown", trapFocus);
  document.addEventListener("keydown", handleEscape, { once: true });
  setTimeout(() => {
    const items = focusable();
    if (items[0]) items[0].focus();
  }, prefersReducedMotion() ? 0 : 40);
};

const closeDialog = () => {
  if (!dialog) return;
  dialog.classList.add("hidden");
  document.body.style.overflow = "";
  document.removeEventListener("keydown", trapFocus);
  if (lastFocused) lastFocused.focus();
};

const handleEscape = (event: KeyboardEvent) => {
  if (event.key === "Escape") {
    closeDialog();
  } else {
    document.addEventListener("keydown", handleEscape, { once: true });
  }
};

const bind = () => {
  if (openBtn && openBtn.dataset.bound !== "true") {
    openBtn.dataset.bound = "true";
    openBtn.addEventListener("click", openDialog);
  }
  if (closeBtn && closeBtn.dataset.bound !== "true") {
    closeBtn.dataset.bound = "true";
    closeBtn.addEventListener("click", closeDialog);
  }
};

bind();

if (dialog) {
  dialog.addEventListener("click", (event) => {
    if (event.target === dialog) {
      closeDialog();
    }
  });
}

document.addEventListener("astro:page-load", bind);
</script>
