---
interface TapestryItem {
  label: string;
  value: string;
  timeseries?: number[];
  methodology?: string;
}

const { items } = Astro.props as { items: TapestryItem[] };
const formatter = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
const describeSeries = (series?: number[]) => {
  if (!series || series.length < 2) return "";
  const first = formatter.format(series[0]);
  const last = formatter.format(series[series.length - 1]);
  return `Trend from ${first} to ${last}`;
};
---
<section class="flex flex-col gap-6" id="impact-tapestry">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="flex flex-col gap-2">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Impact tapestry</span>
      <p class="max-w-2xl text-sm text-[color:var(--ink-2)]">
        Portfolio signals across experimentation, growth, and analytics programs.
      </p>
    </div>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_92%,transparent)] px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_28%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-methodology-trigger
    >
      Methodology
    </button>
  </div>
  <div class="rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_10%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_97%,transparent)] p-5 shadow-[inset_0_1px_0_0_color-mix(in_srgb,var(--ink)_10%,transparent)]">
    <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
      {items.map((item) => (
        <article
          class="flex flex-col gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_94%,transparent)] p-4 text-sm text-[color:var(--ink-2)]"
          data-motion
        >
          <div class="flex items-center justify-between gap-2">
            <span class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">{item.label}</span>
            {item.timeseries && (
              <span
                class="text-[10px] uppercase tracking-[0.28em] text-[color:var(--ink-2)]"
              >
                {item.timeseries.length} pts
              </span>
            )}
          </div>
          <div class="flex items-end gap-2">
            <span class="text-xl font-semibold text-[color:var(--ink)]">{item.value}</span>
            {item.timeseries && <span class="sr-only">{describeSeries(item.timeseries)}</span>}
          </div>
          {item.timeseries && (
            <div
              class="h-8 text-[color:var(--accent)]"
              data-sparkline
              data-points={JSON.stringify(item.timeseries)}
              data-width="120"
              data-height="32"
              data-label={`Sparkline for ${item.label}: ${describeSeries(item.timeseries)}`}
            ></div>
          )}
        </article>
      ))}
    </div>
  </div>
  <dialog
    class="w-[min(90vw,420px)] rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_98%,transparent)] p-5 text-sm text-[color:var(--ink-2)] shadow-[0_40px_120px_-80px_rgba(12,20,32,0.55)]"
    data-methodology-dialog
    aria-labelledby="methodology-title"
    aria-describedby="methodology-body"
  >
    <div class="flex items-start justify-between gap-4">
      <h3 id="methodology-title" class="text-base font-semibold text-[color:var(--ink)]">Methodology</h3>
      <button
        type="button"
        class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-methodology-close
      >
        Close
      </button>
    </div>
    <div id="methodology-body" class="mt-4 space-y-3 leading-relaxed">
      <p>
        Signals consolidated from audited programs with sample sizes meeting statistical confidence. All KPIs use two-tailed significance and were validated by independent analysts.
      </p>
      <p>
        Sparklines represent indexed performance with seasonality smoothed; bullet markers indicate baseline reference.
      </p>
    </div>
  </dialog>
</section>
<script type="module">
import { bootSparklines } from "../ui/Sparkline";

const dialog = document.querySelector<HTMLDialogElement>("[data-methodology-dialog]");
const trigger = document.querySelector<HTMLButtonElement>("[data-methodology-trigger]");
const closeBtn = document.querySelector<HTMLButtonElement>("[data-methodology-close]");
const focusableSelector = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';

const trapFocus = (event: KeyboardEvent) => {
  if (!dialog || !dialog.open || event.key !== "Tab") return;
  const focusable = Array.from(dialog.querySelectorAll<HTMLElement>(focusableSelector));
  if (!focusable.length) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];
  if (event.shiftKey && document.activeElement === first) {
    event.preventDefault();
    last.focus();
  } else if (!event.shiftKey && document.activeElement === last) {
    event.preventDefault();
    first.focus();
  }
};

const openDialog = () => {
  if (!dialog) return;
  dialog.showModal();
  dialog.addEventListener("keydown", trapFocus);
  const focusTarget = dialog.querySelector<HTMLElement>(focusableSelector);
  focusTarget?.focus();
};

const closeDialog = () => {
  if (!dialog) return;
  dialog.removeEventListener("keydown", trapFocus);
  dialog.close();
  trigger?.focus();
};

trigger?.addEventListener("click", openDialog);
trigger?.addEventListener("keydown", (event) => {
  if (event.key === "Enter" || event.key === " ") {
    event.preventDefault();
    openDialog();
  }
});

closeBtn?.addEventListener("click", closeDialog);
closeBtn?.addEventListener("keydown", (event) => {
  if (event.key === "Enter" || event.key === " ") {
    event.preventDefault();
    closeDialog();
  }
});

dialog?.addEventListener("cancel", (event) => {
  event.preventDefault();
  closeDialog();
});

dialog?.addEventListener("click", (event) => {
  if (!dialog) return;
  const rect = dialog.getBoundingClientRect();
  const isInDialog =
    event.clientX >= rect.left &&
    event.clientX <= rect.right &&
    event.clientY >= rect.top &&
    event.clientY <= rect.bottom;
  if (!isInDialog) {
    closeDialog();
  }
});

bootSparklines();
document.addEventListener("astro:page-load", bootSparklines);
</script>
