---
import { meetsMetricGate } from "../../utils/filters";

interface Scope {
  team: string;
  budget: string;
  surfaces: string;
}

interface CaseStudyLink {
  id: string;
  title: string;
  url: string;
  sensitive?: boolean;
}

interface ExperienceMetric {
  label: string;
  delta_pct: number;
  baseline?: number;
  sample?: number;
  confidence?: string;
  note?: string;
}

interface ArtifactLink {
  label: string;
  url: string;
  sensitive?: boolean;
}

interface ExperienceWithComputed {
  id: string;
  org_public: string;
  org_confidential: string;
  role_public: string;
  role_confidential: string;
  start?: string | null;
  end?: string | null;
  scope: Scope;
  impacts: string[];
  metrics: ExperienceMetric[];
  budget_band: string;
  stack: string[];
  tags: string[];
  artifacts?: ArtifactLink[];
  caseStudies: CaseStudyLink[];
  rangePublic: string;
  rangeConfidential: string;
}

const { experience } = Astro.props as {
  experience: ExperienceWithComputed;
};

const scopeLine = [experience.scope.team, experience.scope.budget, experience.scope.surfaces]
  .filter(Boolean)
  .join(" â€¢ ");

const gatedMetrics = experience.metrics.filter((metric) => meetsMetricGate(metric));

const formatDelta = (value: number) => {
  const formatter = new Intl.NumberFormat("en", { maximumFractionDigits: 1 });
  const formatted = formatter.format(Math.abs(value));
  if (value > 0) return `+${formatted}%`;
  if (value < 0) return `-${formatted}%`;
  return `${formatted}%`;
};

const formatBaseline = (value?: number) => {
  if (typeof value !== "number") return null;
  const formatter = new Intl.NumberFormat("en", { maximumFractionDigits: 1 });
  return `${formatter.format(value)}%`;
};

const formatSample = (value?: number) => {
  if (typeof value !== "number") return null;
  if (value < 1000) return value.toString();
  return new Intl.NumberFormat("en", { notation: "compact", compactDisplay: "short" }).format(value);
};

const stackLabel = experience.stack.join(", ");
---

<details
  class="group flex flex-col gap-4 rounded-3xl border border-border/70 bg-background/85 p-6 shadow-soft transition-transform duration-100 ease-out open:shadow-ring hover:-translate-y-1 hover:shadow-ring"
  data-experience-card
  data-tags={experience.tags.join(",")}
  data-case-ids={experience.caseStudies.map((link) => link.id).join(",")}
>
  <summary class="flex cursor-pointer list-none flex-col gap-3 text-left outline-none">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
      <div class="flex flex-col">
        <p class="text-sm font-medium text-text-secondary">
          <span class="confidential-only">{experience.org_confidential}</span>
          <span class="public-only">{experience.org_public}</span>
        </p>
        <p class="text-xl font-semibold text-text-primary">
          <span class="confidential-only">{experience.role_confidential}</span>
          <span class="public-only">{experience.role_public}</span>
        </p>
      </div>
      <p class="text-sm font-medium text-text-muted">
        <span class="confidential-only">{experience.rangeConfidential}</span>
        <span class="public-only">{experience.rangePublic}</span>
      </p>
    </div>
    <p class="text-sm text-text-secondary">{scopeLine}</p>
    <div class="flex flex-wrap gap-2 text-xs text-text-muted">
      <span class="inline-flex items-center gap-2 rounded-full bg-surface/70 px-3 py-1">
        <span class="font-semibold uppercase tracking-[0.2em] text-text-muted">Team</span>
        <span>{experience.scope.team}</span>
      </span>
      <span class="inline-flex items-center gap-2 rounded-full bg-surface/70 px-3 py-1">
        <span class="font-semibold uppercase tracking-[0.2em] text-text-muted">Budget</span>
        <span>{experience.budget_band}</span>
      </span>
      <span class="inline-flex items-center gap-2 rounded-full bg-surface/70 px-3 py-1">
        <span class="font-semibold uppercase tracking-[0.2em] text-text-muted">Surfaces</span>
        <span>{experience.scope.surfaces}</span>
      </span>
      <span class="inline-flex items-center gap-2 rounded-full bg-surface/70 px-3 py-1">
        <span class="font-semibold uppercase tracking-[0.2em] text-text-muted">Stack</span>
        <span>{stackLabel}</span>
      </span>
    </div>
  </summary>
  <div class="flex flex-col gap-5 border-t border-border/60 pt-4">
    {gatedMetrics.length > 0 && (
      <div class="flex flex-col gap-3" aria-label="Key metrics">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Metrics</span>
        <div class="grid gap-3 md:grid-cols-2">
          {gatedMetrics.map((metric) => {
            const baseline = formatBaseline(metric.baseline);
            const sample = formatSample(metric.sample);
            return (
              <div class="flex flex-col gap-1 rounded-2xl border border-border/50 bg-surface/70 p-3 shadow-soft">
                <div class="flex items-center justify-between gap-2">
                  <span class="text-sm font-semibold text-text-primary">{metric.label}</span>
                  <span class="text-sm font-semibold text-accent">{formatDelta(metric.delta_pct)}</span>
                </div>
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-text-muted">
                  {baseline && <span>Baseline {baseline}</span>}
                  {sample && <span>n={sample}</span>}
                  {metric.confidence && <span>{metric.confidence}</span>}
                  {metric.note && <span>{metric.note}</span>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    )}
    <div class="flex flex-col gap-2">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Impact highlights</span>
      <ul class="flex list-disc flex-col gap-2 pl-5 text-sm text-text-secondary">
        {experience.impacts.map((impact) => (
          <li>{impact}</li>
        ))}
      </ul>
    </div>
    {experience.caseStudies.length > 0 && (
      <div class="flex flex-col gap-2" aria-label="Linked case studies">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Case studies</span>
        <div class="flex flex-wrap gap-2">
          {experience.caseStudies.map((caseStudy) => {
            const isSensitive = caseStudy.sensitive === true;
            return (
              <div class="contents">
                <a
                  href={caseStudy.url}
                  data-astro-transition="animate"
                  class={`inline-flex items-center rounded-full border border-border px-3 py-1 text-xs font-semibold text-text-secondary transition hover:border-accent hover:text-text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent ${isSensitive ? "public-only" : ""}`}
                >
                  {caseStudy.title}
                </a>
                {isSensitive && (
                  <span class="confidential-only inline-flex items-center rounded-full border border-dashed border-border/70 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-text-muted">
                    Confidential case study
                  </span>
                )}
              </div>
            );
          })}
        </div>
      </div>
    )}
    {Array.isArray(experience.artifacts) && experience.artifacts.length > 0 && (
      <div class="flex flex-col gap-2" aria-label="Artifacts">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Artifacts</span>
        <div class="flex flex-wrap gap-2">
          {experience.artifacts.map((artifact) => {
            const isSensitive = artifact.sensitive === true;
            return (
              <div class="contents">
                <a
                  href={artifact.url}
                  data-astro-transition="animate"
                  class={`inline-flex items-center rounded-full border border-border px-3 py-1 text-xs font-semibold text-text-secondary transition hover:border-accent hover:text-text-primary focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent ${isSensitive ? "public-only" : ""}`}
                >
                  {artifact.label}
                </a>
                {isSensitive && (
                  <span class="confidential-only inline-flex items-center rounded-full border border-dashed border-border/70 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-text-muted">
                    Confidential artifact
                  </span>
                )}
              </div>
            );
          })}
        </div>
      </div>
    )}
  </div>
</details>
