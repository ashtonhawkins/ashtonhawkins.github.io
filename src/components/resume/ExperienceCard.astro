---
import { formatPreciseRange, formatApproxDuration } from "../../utils/dates";
import { formatDelta, formatSample, formatBaseline } from "../../utils/metrics";
import { meetsMetricGate } from "../../utils/metrics";

interface MetricItem {
  label: string;
  delta_pct: number;
  baseline?: number;
  sample?: number;
  confidence?: string;
  note?: string;
}

interface ArtifactItem {
  label: string;
  url: string;
  sensitive?: boolean;
}

interface CaseStudyRef {
  id: string;
  title: string;
  sensitive?: boolean;
}

interface ExperienceItem {
  id: string;
  org_public: string;
  org_confidential: string;
  role_public: string;
  role_confidential: string;
  start: string;
  end: string;
  team_size?: number;
  budget_band?: string;
  surfaces?: string;
  stack?: string[];
  metrics: MetricItem[];
  impacts: string[];
  artifacts: ArtifactItem[];
  caseStudies?: CaseStudyRef[];
  tags?: string[];
}

const { experience } = Astro.props as { experience: ExperienceItem };
const preciseRange = formatPreciseRange(experience.start, experience.end);
const approxRange = formatApproxDuration(experience.start, experience.end);
const gatedMetrics = experience.metrics.filter((metric) => meetsMetricGate(metric));
const metaParts = [
  experience.team_size ? `Team ${experience.team_size}` : null,
  experience.budget_band ? experience.budget_band : null
].filter(Boolean) as string[];
---
<details
  class="group overflow-hidden rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_96%,transparent)] shadow-[0_32px_80px_-64px_rgba(12,20,32,0.7)]"
  data-experience-card
  data-tags={experience.tags?.join(",") ?? ""}
  data-filter-item
  data-motion
>
  <summary class="flex cursor-pointer flex-col gap-3 px-5 py-4 text-left text-sm text-[color:var(--ink-2)] outline-none transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] focus-visible:bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-col gap-1 text-base font-semibold text-[color:var(--ink)]">
        <span>
          <span class="confidential-only">{experience.org_confidential}</span>
          <span class="public-only">{experience.org_public}</span>
        </span>
        <span class="text-sm font-normal text-[color:var(--ink-2)]">
          <span class="confidential-only">{experience.role_confidential}</span>
          <span class="public-only">{experience.role_public}</span>
        </span>
      </div>
      <div class="flex flex-col items-end gap-1 text-xs uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
        <span class="public-only">{preciseRange}</span>
        <span class="confidential-only">{approxRange}</span>
        {metaParts.length > 0 && <span>{metaParts.join(" â€¢ ")}</span>}
      </div>
    </div>
    {experience.tags && experience.tags.length > 0 && (
      <div class="flex flex-wrap gap-2 text-[10px] uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
        {experience.tags.map((tag) => (
          <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_10%,transparent)] px-3 py-1">{tag}</span>
        ))}
      </div>
    )}
  </summary>
  <div class="flex flex-col gap-5 px-5 pb-6 pt-2 text-sm text-[color:var(--ink-2)]">
    <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
      {experience.surfaces && <span>Surfaces: {experience.surfaces}</span>}
      {experience.stack && experience.stack.length > 0 && <span>Stack: {experience.stack.join(", ")}</span>}
    </div>
    {gatedMetrics.length > 0 && (
      <div class="grid gap-3 sm:grid-cols-3">
        {gatedMetrics.map((metric) => (
          <div class="flex flex-col gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_94%,transparent)] p-4">
            <div class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">{metric.label}</div>
            <div class="text-lg font-semibold text-[color:var(--ink)]">
              {formatDelta(metric.delta_pct)}
              {metric.label.toLowerCase().includes("pp") ? " pp" : "%"}
            </div>
            <div class="text-xs text-[color:var(--ink-2)]">
              {metric.confidence && <span>{metric.confidence}</span>}
              {metric.sample && <span class="block">{formatSample(metric.sample)}</span>}
              {metric.baseline && <span class="block">{formatBaseline(metric.baseline)}</span>}
              {metric.note && <span class="block">{metric.note}</span>}
            </div>
          </div>
        ))}
      </div>
    )}
    <div class="flex flex-col gap-3">
      <h4 class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Impact</h4>
      <ul class="flex list-disc flex-col gap-2 pl-5 text-sm text-[color:var(--ink-2)]">
        {experience.impacts.map((impact) => (
          <li>{impact}</li>
        ))}
      </ul>
    </div>
    {experience.caseStudies && experience.caseStudies.length > 0 && (
      <div class="flex flex-col gap-2">
        <h4 class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Case studies</h4>
        <ul class="flex flex-wrap gap-2 text-sm">
          {experience.caseStudies.map((caseStudy) => (
            <li class="flex items-center gap-2">
              {caseStudy.sensitive && (
                <span class="confidential-only inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-[color:var(--ink-2)]">Confidential</span>
              )}
              <a
                href={`#case-${caseStudy.id}`}
                class={`inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_28%,transparent)] ${caseStudy.sensitive ? "public-only" : ""}`}
              >
                {caseStudy.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
    {experience.artifacts.length > 0 && (
      <div class="flex flex-col gap-2">
        <h4 class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Artifacts</h4>
        <div class="flex flex-wrap gap-2">
          {experience.artifacts.map((artifact) => (
            <div class="flex items-center gap-2">
              {artifact.sensitive && (
                <span class="confidential-only inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-[color:var(--ink-2)]">Confidential</span>
              )}
              <a
                href={artifact.url}
                target="_blank"
                rel="noreferrer"
                class={`inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_28%,transparent)] ${artifact.sensitive ? "public-only" : ""}`}
              >
                {artifact.label}
              </a>
            </div>
          ))}
        </div>
      </div>
    )}
  </div>
</details>
