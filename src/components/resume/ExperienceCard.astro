---
import { formatPreciseRange, formatApproxDuration } from "../../utils/dates";
import { formatDelta, formatSample, formatBaseline, meetsMetricGate } from "../../utils/metrics";

interface MetricItem {
  label: string;
  delta_pct: number;
  baseline?: number;
  sample?: number;
  confidence?: string;
  note?: string;
}

interface ArtifactItem {
  label: string;
  url: string;
  sensitive?: boolean;
}

interface CaseStudyRef {
  id: string;
  title: string;
  sensitive?: boolean;
}

interface ExperienceItem {
  id: string;
  org_public: string;
  org_confidential: string;
  role_public: string;
  role_confidential: string;
  start: string;
  end: string;
  team_size?: number;
  budget_band?: string;
  surfaces?: string;
  stack?: string[];
  metrics: MetricItem[];
  impacts: string[];
  artifacts: ArtifactItem[];
  caseStudies?: CaseStudyRef[];
  tags?: string[];
}

const { experience } = Astro.props as { experience: ExperienceItem };
const preciseRange = formatPreciseRange(experience.start, experience.end);
const approxRange = formatApproxDuration(experience.start, experience.end);
const metrics = experience.metrics.filter((metric) => meetsMetricGate(metric));
const meta: string[] = [];
if (experience.team_size) meta.push(`Team ${experience.team_size}`);
if (experience.budget_band) meta.push(experience.budget_band);
if (experience.surfaces) meta.push(experience.surfaces);
if (experience.stack && experience.stack.length) meta.push(experience.stack.join(" Â· "));
---
<details
  class="group overflow-hidden rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_96%,transparent)] shadow-[0_32px_80px_-60px_rgba(12,20,32,0.45)]"
  data-experience-card
  data-tags={experience.tags?.join(",") ?? ""}
  data-filter-item
  data-motion
>
  <summary class="flex cursor-pointer flex-col gap-3 px-5 py-4 text-left outline-none transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] focus-visible:bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-col gap-1">
        <span class="text-base font-semibold text-[color:var(--ink)]">
          <span class="confidential-only">{experience.org_confidential}</span>
          <span class="public-only">{experience.org_public}</span>
        </span>
        <span class="text-sm text-[color:var(--ink-2)]">
          <span class="confidential-only">{experience.role_confidential}</span>
          <span class="public-only">{experience.role_public}</span>
        </span>
      </div>
      <div class="flex flex-col items-end gap-1 text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
        <span class="public-only">{preciseRange}</span>
        <span class="confidential-only">{approxRange}</span>
      </div>
    </div>
    {experience.tags && experience.tags.length > 0 && (
      <div class="flex flex-wrap gap-2 text-[10px] font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
        {experience.tags.map((tag) => (
          <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_10%,transparent)] px-3 py-1">{tag}</span>
        ))}
      </div>
    )}
  </summary>
  <div class="flex flex-col gap-5 px-5 pb-6 pt-2 text-sm leading-relaxed text-[color:var(--ink-2)]">
    {meta.length > 0 && (
      <div class="flex flex-wrap items-center gap-2 text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
        {meta.map((item) => (
          <span class="inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1">{item}</span>
        ))}
      </div>
    )}
    {metrics.length > 0 && (
      <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
        {metrics.map((metric) => (
          <div class="flex flex-col gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_94%,transparent)] p-4">
            <span class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">{metric.label}</span>
            <span class="text-lg font-semibold text-[color:var(--ink)]">
              {formatDelta(metric.delta_pct)}
              {metric.label.toLowerCase().includes("pp") ? " pp" : "%"}
            </span>
            <div class="flex flex-col gap-1 text-xs text-[color:var(--ink-2)]">
              {metric.confidence && <span>{metric.confidence}</span>}
              {metric.sample && <span>{formatSample(metric.sample)}</span>}
              {metric.baseline && <span>{formatBaseline(metric.baseline)}</span>}
              {metric.note && <span>{metric.note}</span>}
            </div>
          </div>
        ))}
      </div>
    )}
    <div class="flex flex-col gap-2">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Outcomes</span>
      <ul class="flex list-disc flex-col gap-2 pl-5">
        {experience.impacts.map((impact) => (
          <li>{impact}</li>
        ))}
      </ul>
    </div>
    {experience.caseStudies && experience.caseStudies.length > 0 && (
      <div class="flex flex-col gap-2">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Case studies</span>
        <div class="flex flex-wrap gap-2">
          {experience.caseStudies.map((caseStudy) => (
            <a
              href={`#case-${caseStudy.id}`}
              class={`inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_28%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)] ${caseStudy.sensitive ? "public-only" : ""}`}
            >
              {caseStudy.title}
            </a>
          ))}
          {experience.caseStudies.some((caseStudy) => caseStudy.sensitive) && (
            <span class="confidential-only inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
              Confidential
            </span>
          )}
        </div>
      </div>
    )}
    {experience.artifacts.length > 0 && (
      <div class="flex flex-col gap-2">
        <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Artifacts</span>
        <div class="flex flex-wrap gap-2">
          {experience.artifacts.map((artifact) => (
            <a
              href={artifact.url}
              target="_blank"
              rel="noreferrer"
              class={`inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_28%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)] ${artifact.sensitive ? "public-only" : ""}`}
            >
              {artifact.label}
            </a>
          ))}
          {experience.artifacts.some((artifact) => artifact.sensitive) && (
            <span class="confidential-only inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
              Confidential
            </span>
          )}
        </div>
      </div>
    )}
  </div>
</details>
