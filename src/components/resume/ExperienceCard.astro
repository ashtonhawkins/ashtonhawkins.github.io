---
interface Metric {
  label: string;
  delta_pct: number;
  baseline?: number;
  sample?: number;
  confidence?: string;
  note?: string;
}

interface Artifact {
  label: string;
  url: string;
  sensitive?: boolean;
}

interface CaseStudyRef {
  id: string;
  title: string;
  sensitive?: boolean;
}

interface ExperienceItem {
  id: string;
  org_public: string;
  org_confidential: string;
  role_public: string;
  role_confidential: string;
  rangePublic: string;
  rangeConfidential: string;
  team_size: string;
  budget_band: string;
  surfaces: string;
  stack: string[];
  metrics: Metric[];
  impacts: string[];
  artifacts: Artifact[];
  caseStudies: CaseStudyRef[];
}

const compactFormatter = new Intl.NumberFormat("en-US", {
  notation: "compact",
  maximumFractionDigits: 1
});

const { experience } = Astro.props as { experience: ExperienceItem };
const allCaseSensitive = experience.caseStudies.length > 0 && experience.caseStudies.every((item) => item.sensitive);
const allArtifactSensitive = experience.artifacts.length > 0 && experience.artifacts.every((artifact) => artifact.sensitive);
const toDelta = (value: number) => {
  const prefix = value > 0 ? "+" : "";
  const decimals = Math.abs(value) < 10 && Math.round(value * 10) !== value * 10 ? 1 : 0;
  return `${prefix}${value.toFixed(decimals)}%`;
};
---
<li class="relative pl-8" data-experience-item>
  <span class="absolute left-1 top-4 h-3 w-3 -translate-x-full rounded-full border border-[color:var(--accent)] bg-[color:var(--surface)]"></span>
  <article class="flex flex-col gap-4 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_94%,transparent)] p-5 shadow-[0_18px_48px_-32px_rgba(12,20,32,0.55)]">
    <header class="flex flex-col gap-3">
      <div class="flex flex-col gap-2">
        <span class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
          <span class="public-only">{experience.rangePublic}</span>
          <span class="confidential-only">{experience.rangeConfidential}</span>
        </span>
        <h3 class="text-xl font-semibold text-[color:var(--ink)]">
          <span class="public-only">{experience.org_public}</span>
          <span class="confidential-only">{experience.org_confidential}</span>
        </h3>
        <p class="text-sm text-[color:var(--ink-2)]">
          <span class="public-only">{experience.role_public}</span>
          <span class="confidential-only">{experience.role_confidential}</span>
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-2 text-xs text-[color:var(--ink-2)]">
        <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1">{experience.team_size}</span>
        <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1">{experience.budget_band}</span>
        <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1">{experience.surfaces}</span>
        <span class="rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1">{experience.stack.join(" â€¢ ")}</span>
      </div>
    </header>
    <ul class="flex flex-col gap-2 text-sm text-[color:var(--ink-2)]">
      {experience.impacts.map((impact) => (
        <li class="relative pl-5">
          <span class="absolute left-0 top-2 h-1.5 w-1.5 rounded-full bg-[color:var(--accent)]"></span>
          <span>{impact}</span>
        </li>
      ))}
    </ul>
    {experience.caseStudies.length > 0 && (
      <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
        <span>Stories</span>
        {experience.caseStudies.map((caseStudy) => (
          <a
            href={`#case-${caseStudy.id}`}
            class={`rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] px-3 py-1 text-[color:var(--ink)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] ${caseStudy.sensitive ? "public-only" : ""}`}
            data-astro-transition="animate"
          >
            {caseStudy.title}
          </a>
        ))}
        {allCaseSensitive && <span class="confidential-only">Hidden</span>}
      </div>
    )}
    <details class="rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_96%,transparent)] p-4" data-experience-details>
      <summary class="cursor-pointer text-sm font-semibold text-[color:var(--ink)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">Evidence stack</summary>
      <div class="mt-4 flex flex-col gap-4">
        <div class="grid gap-3 md:grid-cols-3">
          {experience.metrics.map((metric) => (
            <div class="flex flex-col gap-1 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_98%,transparent)] p-3">
              <span class="text-xs font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)]">{metric.label}</span>
              <span class="text-xl font-semibold text-[color:var(--ink)]">{toDelta(metric.delta_pct)}</span>
              <span class="text-xs text-[color:var(--ink-2)]">
                {metric.baseline !== undefined && <span>Baseline {metric.baseline} </span>}
                {metric.sample && <span>Â· {compactFormatter.format(metric.sample)} sample </span>}
                {metric.confidence && <span>Â· {metric.confidence}</span>}
              </span>
              {metric.note && <span class="text-xs text-[color:var(--ink-2)]">{metric.note}</span>}
            </div>
          ))}
        </div>
        {experience.artifacts.length > 0 && (
          <div class="flex flex-wrap items-center gap-3 text-sm text-[color:var(--ink)]">
            {experience.artifacts.map((artifact) => (
              <a
                href={artifact.url}
                class={`inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] ${artifact.sensitive ? "public-only" : ""}`}
                target="_blank"
                rel="noreferrer"
              >
                <span aria-hidden="true">ðŸ“Ž</span>
                {artifact.label}
              </a>
            ))}
            {allArtifactSensitive && <span class="confidential-only text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">Artifacts secured</span>}
          </div>
        )}
      </div>
    </details>
  </article>
</li>
