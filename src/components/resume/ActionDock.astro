---
interface ActionDockProps {
  email: string;
  bio: string;
  jsonExport: Record<string, unknown>;
  textExport: string;
}

const props = Astro.props as ActionDockProps;
---
<div class="contents" data-action-root>
  <aside class="pointer-events-none hidden md:block">
    <div
      class="pointer-events-auto fixed top-28 right-[clamp(1rem,5vw,6rem)] flex w-52 flex-col gap-3 rounded-[var(--radius-3)] border border-[color:var(--keyline)] bg-[color:color-mix(in_lab,var(--surface) 94%, transparent)] p-4 shadow-[0_32px_80px_-60px_rgba(15,23,42,0.45)]"
      data-action-dock
      data-state="hidden"
    >
      <span class="text-[11px] font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">Action dock</span>
      <div class="flex flex-col gap-2 text-sm text-[color:var(--ink)]">
        <a
          href={`mailto:${props.email}`}
          class="inline-flex items-center gap-2 rounded-[var(--radius-2)] border border-[color:var(--keyline)] px-3 py-2 transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-action-email
        >
          âœ‰ï¸ Email
        </a>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-[var(--radius-2)] border border-[color:var(--keyline)] px-3 py-2 text-left transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-action-print
        >
          ğŸ–¨ï¸ Download PDF
        </button>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-[var(--radius-2)] border border-[color:var(--keyline)] px-3 py-2 text-left transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-action-copy
        >
          ğŸ“‹ Copy bio
        </button>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-[var(--radius-2)] border border-[color:var(--keyline)] px-3 py-2 text-left transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-action-json
        >
          ğŸ—‚ï¸ Export JSON
        </button>
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-[var(--radius-2)] border border-[color:var(--keyline)] px-3 py-2 text-left transition-[border,background,color] duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_lab,var(--accent) 40%, transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
          data-action-text
        >
          ğŸ“ Export TXT
        </button>
      </div>
    </div>
  </aside>
  <div class="fixed inset-x-0 bottom-4 z-40 flex justify-center md:hidden">
    <div
      class="flex items-center gap-3 rounded-full border border-[color:var(--keyline)] bg-[color:color-mix(in_lab,var(--surface) 94%, transparent)] px-4 py-2 text-sm text-[color:var(--ink)] shadow-[0_24px_60px_-48px_rgba(15,23,42,0.45)]"
      data-action-pill
      data-state="hidden"
      role="group"
      aria-label="Quick actions"
    >
      <a
        href={`mailto:${props.email}`}
        class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-action-email
      >
        âœ‰ï¸<span class="sr-only">Email</span>
      </a>
      <button
        type="button"
        class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-action-print
        aria-label="Download PDF"
      >
        ğŸ–¨ï¸
      </button>
      <button
        type="button"
        class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-action-copy
        aria-label="Copy bio"
      >
        ğŸ“‹
      </button>
      <button
        type="button"
        class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-action-json
        aria-label="Export JSON"
      >
        ğŸ—‚ï¸
      </button>
      <button
        type="button"
        class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
        data-action-text
        aria-label="Export text"
      >
        ğŸ“
      </button>
    </div>
  </div>
</div>
<script type="application/json" id="resume-bio">{JSON.stringify(props.bio)}</script>
<script type="application/json" id="resume-export-json">{JSON.stringify(props.jsonExport)}</script>
<script type="application/json" id="resume-export-text">{JSON.stringify(props.textExport)}</script>
<script type="module">
  import { Toast } from "../ui/Toast";
  import { bindVisibilityState } from "../../utils/motion";

  const root = document.querySelector("[data-action-root]");
  const dock = root?.querySelector<HTMLElement>("[data-action-dock]");
  const pill = root?.querySelector<HTMLElement>("[data-action-pill]");
  const hero = document.querySelector("[data-hero-sentinel]");
  const toast = new Toast(document.querySelector<HTMLElement>("[data-toast-root]"));

  const bioNode = document.getElementById("resume-bio");
  const jsonNode = document.getElementById("resume-export-json");
  const textNode = document.getElementById("resume-export-text");
  const bioPayload = bioNode ? JSON.parse(bioNode.textContent || "\"\"") : "";
  const jsonPayload = jsonNode ? JSON.parse(jsonNode.textContent || "{}") : {};
  const textPayload = textNode ? JSON.parse(textNode.textContent || "\"\"") : "";

  bindVisibilityState(hero, dock, 0.5);
  bindVisibilityState(hero, pill, 0.5);
  if (!hero) {
    dock?.setAttribute("data-state", "visible");
    pill?.setAttribute("data-state", "visible");
  }

  const triggerDownload = (content: string, type: string, filename: string) => {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement("a");
    anchor.href = url;
    anchor.download = filename;
    document.body.append(anchor);
    anchor.click();
    anchor.remove();
    window.setTimeout(() => URL.revokeObjectURL(url), 1200);
  };

  const copyBio = async () => {
    try {
      await navigator.clipboard.writeText(bioPayload);
      toast.show("Bio copied");
    } catch (error) {
      toast.show("Copy unavailable");
    }
  };

  const bindAction = (selector: string, handler: () => void) => {
    root?.querySelectorAll<HTMLButtonElement | HTMLAnchorElement>(selector).forEach((node) => {
      if (node.dataset.bound === "true") return;
      node.dataset.bound = "true";
      node.addEventListener("click", (event) => {
        if (node instanceof HTMLAnchorElement) return;
        event.preventDefault();
        handler();
      });
      node.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handler();
        }
      });
    });
  };

  bindAction('[data-action-print]', () => window.print());
  bindAction('[data-action-copy]', copyBio);
  bindAction('[data-action-json]', () => triggerDownload(JSON.stringify(jsonPayload, null, 2), "application/json", "resume.json"));
  bindAction('[data-action-text]', () => triggerDownload(textPayload, "text/plain", "resume.txt"));

  document.addEventListener("astro:page-load", () => {
    bindAction('[data-action-print]', () => window.print());
    bindAction('[data-action-copy]', copyBio);
    bindAction('[data-action-json]', () => triggerDownload(JSON.stringify(jsonPayload, null, 2), "application/json", "resume.json"));
    bindAction('[data-action-text]', () => triggerDownload(textPayload, "text/plain", "resume.txt"));
  });
</script>
