---
interface ActionDockProps {
  email: string;
  bio: string;
  jsonExport: Record<string, unknown>;
  textExport: string;
}

const props = Astro.props as ActionDockProps;
const { email } = props;
---
<div
  class="fixed right-[clamp(1rem,8vw,6rem)] top-6 z-40 hidden flex-col gap-3 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_94%,transparent)] p-4 shadow-[0_24px_80px_-56px_rgba(12,20,32,0.7)] sm:flex"
  data-action-dock
  data-state="hidden"
>
  <span class="text-[11px] font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Actions</span>
  <div class="flex flex-col gap-2 text-sm text-[color:var(--ink)]">
    <a
      href={`mailto:${email}`}
      class="inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-action-email
    >
      âœ‰ï¸ Email
    </a>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 text-left transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-action-print
    >
      ğŸ–¨ï¸ Download PDF
    </button>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 text-left transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-action-copy
    >
      ğŸ“‹ Copy bio
    </button>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 text-left transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-action-json
    >
      ğŸ—‚ï¸ Export JSON
    </button>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-[var(--r-2)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-3 py-2 text-left transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-action-text
    >
      ğŸ“ Export TXT
    </button>
  </div>
</div>
<div
  class="fixed inset-x-0 bottom-4 z-40 flex justify-center sm:hidden"
  data-action-pill
  data-state="hidden"
>
  <div class="flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_94%,transparent)] px-4 py-2 text-sm shadow-[0_24px_60px_-48px_rgba(12,20,32,0.7)]">
    <a href={`mailto:${email}`} class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">âœ‰ï¸</a>
    <button type="button" data-action-print class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">ğŸ–¨ï¸</button>
    <button type="button" data-action-copy class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">ğŸ“‹</button>
    <button type="button" data-action-json class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">ğŸ—‚ï¸</button>
    <button type="button" data-action-text class="rounded-full px-2 py-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]">ğŸ“</button>
  </div>
</div>
<script type="application/json" id="resume-bio">{JSON.stringify(props.bio)}</script>
<script type="application/json" id="resume-export-json">{JSON.stringify(props.jsonExport)}</script>
<script type="application/json" id="resume-export-text">{JSON.stringify(props.textExport)}</script>
<script type="module">
import { Toast } from "../ui/Toast";

const hero = document.querySelector("[data-hero-anchor]");
const dock = document.querySelector<HTMLElement>("[data-action-dock]");
const pill = document.querySelector<HTMLElement>("[data-action-pill]");
const toast = new Toast(document.querySelector<HTMLElement>("[data-toast-root]"));

const updateState = (visible: boolean) => {
  const state = visible ? "hidden" : "visible";
  if (dock) dock.dataset.state = state;
  if (pill) pill.dataset.state = state;
};

if (hero) {
  const observer = new IntersectionObserver(
    (entries) => {
      const entry = entries[0];
      if (!entry) return;
      updateState(entry.isIntersecting && entry.intersectionRatio > 0.5);
    },
    { threshold: [0, 0.5, 1] }
  );
  observer.observe(hero);
}

const bioNode = document.getElementById("resume-bio");
const jsonNode = document.getElementById("resume-export-json");
const textNode = document.getElementById("resume-export-text");
const bioPayload = bioNode ? JSON.parse(bioNode.textContent || "\"\"") : "";
const jsonPayload = jsonNode ? JSON.parse(jsonNode.textContent || "{}") : {};
const textPayload = textNode ? JSON.parse(textNode.textContent || "\"\"") : "";

const triggerDownload = (content: string, type: string, filename: string) => {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const anchor = document.createElement("a");
  anchor.href = url;
  anchor.download = filename;
  document.body.append(anchor);
  anchor.click();
  anchor.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
};

const bindAction = (selector: string, handler: () => void) => {
  document.querySelectorAll<HTMLButtonElement | HTMLAnchorElement>(selector).forEach((node) => {
    if (node.dataset.bound === "true") return;
    node.dataset.bound = "true";
    node.addEventListener("click", (event) => {
      if (node.tagName === "A") return;
      event.preventDefault();
      handler();
    });
  });
};

bindAction('[data-action-print]', () => window.print());
const copyHandler = async () => {
  try {
    await navigator.clipboard.writeText(bioPayload);
    toast.show("Bio copied");
  } catch (error) {
    toast.show("Copy unavailable");
  }
};
bindAction('[data-action-copy]', copyHandler);
bindAction('[data-action-json]', () => triggerDownload(JSON.stringify(jsonPayload, null, 2), "application/json", "resume.json"));
bindAction('[data-action-text]', () => triggerDownload(textPayload, "text/plain", "resume.txt"));

document.addEventListener("astro:page-load", () => {
  bindAction('[data-action-print]', () => window.print());
  bindAction('[data-action-copy]', copyHandler);
  bindAction('[data-action-json]', () => triggerDownload(JSON.stringify(jsonPayload, null, 2), "application/json", "resume.json"));
  bindAction('[data-action-text]', () => triggerDownload(textPayload, "text/plain", "resume.txt"));
});
</script>
