---
interface ActionDockProps {
  email: string;
  bio: string;
  jsonExport: Record<string, unknown>;
  textExport: string;
}

const { email, bio, jsonExport, textExport } = Astro.props as ActionDockProps;
const jsonLiteral = JSON.stringify(jsonExport);
---
<div
  class="pointer-events-none"
  data-action-dock
  data-email={email}
  data-bio={bio}
  data-json={jsonLiteral}
  data-text={textExport}
>
  <div class="hidden flex-col gap-3 lg:flex">
    <div class="rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_96%,transparent)] p-4 shadow-[0_20px_56px_-34px_rgba(12,20,32,0.55)]">
      <span class="text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">Action Dock</span>
      <div class="mt-3 flex flex-col gap-2">
        <button type="button" class="flex items-center justify-between gap-3 rounded-[var(--r-2)] border border-transparent px-4 py-2 text-sm font-semibold text-[color:var(--ink)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:-translate-y-0.5 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)]" data-action-email>
          Email
          <span aria-hidden="true">‚Üó</span>
        </button>
        <button type="button" class="flex items-center justify-between gap-3 rounded-[var(--r-2)] border border-transparent px-4 py-2 text-sm font-semibold text-[color:var(--ink)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:-translate-y-0.5 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)]" data-action-print>
          Download PDF
          <span aria-hidden="true">‚á©</span>
        </button>
        <button type="button" class="flex items-center justify-between gap-3 rounded-[var(--r-2)] border border-transparent px-4 py-2 text-sm font-semibold text-[color:var(--ink)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:-translate-y-0.5 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)]" data-action-copy>
          Copy short bio
          <span aria-hidden="true">‚ßâ</span>
        </button>
        <button type="button" class="flex items-center justify-between gap-3 rounded-[var(--r-2)] border border-transparent px-4 py-2 text-sm font-semibold text-[color:var(--ink)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:-translate-y-0.5 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)]" data-action-export-json>
          Export JSON
          <span aria-hidden="true">‚á©</span>
        </button>
        <button type="button" class="flex items-center justify-between gap-3 rounded-[var(--r-2)] border border-transparent px-4 py-2 text-sm font-semibold text-[color:var(--ink)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] hover:-translate-y-0.5 hover:border-[color:color-mix(in_srgb,var(--accent)_32%,transparent)]" data-action-export-text>
          Export TXT
          <span aria-hidden="true">‚á©</span>
        </button>
      </div>
    </div>
  </div>
  <div class="lg:hidden" data-mobile-dock>
    <div class="fixed inset-x-0 bottom-4 mx-auto flex max-w-lg items-center justify-center">
      <div class="flex w-full items-center justify-around rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_96%,transparent)] px-4 py-3 text-sm font-semibold text-[color:var(--ink)] shadow-[0_24px_64px_-36px_rgba(12,20,32,0.6)]">
        <button type="button" class="flex flex-col items-center gap-1" data-action-email>
          <span aria-hidden="true">‚úâÔ∏è</span>
          Email
        </button>
        <button type="button" class="flex flex-col items-center gap-1" data-action-print>
          <span aria-hidden="true">üñ®Ô∏è</span>
          PDF
        </button>
        <button type="button" class="flex flex-col items-center gap-1" data-action-copy>
          <span aria-hidden="true">üìã</span>
          Copy
        </button>
      </div>
    </div>
  </div>
</div>
<style is:inline>
[data-action-dock] {
  position: fixed;
  top: 1.5rem;
  right: clamp(1rem, 6vw, 6rem);
  z-index: 40;
  opacity: 0;
  transform: translateY(-16px);
  transition: opacity 200ms cubic-bezier(.2,.8,.2,1), transform 200ms cubic-bezier(.2,.8,.2,1);
  pointer-events: none;
}
[data-action-dock][data-visible="true"] {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}
@media (max-width: 1023px) {
  [data-action-dock] {
    position: static;
    opacity: 1;
    transform: none;
    pointer-events: auto;
  }
}
@media print {
  [data-action-dock] {
    display: none !important;
  }
}
</style>
<script type="module">
import { showToast } from "../ui/Toast";

const dock = document.querySelector<HTMLElement>('[data-action-dock]');
const hero = document.querySelector<HTMLElement>('[data-hero-anchor]');

const reveal = (visible: boolean) => {
  if (!dock) return;
  dock.setAttribute('data-visible', visible ? 'true' : 'false');
};

if (dock && hero) {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      reveal(!entry.isIntersecting || entry.intersectionRatio < 0.5);
    });
  }, { threshold: [0.5] });
  observer.observe(hero);
}

const email = dock?.getAttribute('data-email') ?? '';
const bio = dock?.getAttribute('data-bio') ?? '';
let jsonData: unknown = {};
try {
  jsonData = dock?.getAttribute('data-json') ? JSON.parse(dock.getAttribute('data-json') as string) : {};
} catch (error) {
  jsonData = {};
}
const textData = dock?.getAttribute('data-text') ?? '';

const bind = (selector: string, handler: (button: HTMLElement) => void) => {
  document.querySelectorAll<HTMLElement>(selector).forEach((element) => {
    if (element.dataset.bound === 'true') return;
    element.dataset.bound = 'true';
    handler(element);
  });
};

bind('[data-action-email]', (button) => {
  button.addEventListener('click', () => {
    if (email) {
      window.location.href = `mailto:${email}`;
    }
  });
});

bind('[data-action-print]', (button) => {
  button.addEventListener('click', () => {
    window.print();
    showToast('Generating PDF');
  });
});

bind('[data-action-copy]', (button) => {
  button.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(bio);
      showToast('Short bio copied');
    } catch (error) {
      showToast('Unable to copy');
    }
  });
});

const downloadBlob = (payload: BlobPart, filename: string, type: string) => {
  const blob = new Blob([payload], { type });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
};

bind('[data-action-export-json]', (button) => {
  button.addEventListener('click', () => {
    downloadBlob(JSON.stringify(jsonData, null, 2), 'resume.json', 'application/json');
    showToast('JSON export ready');
  });
});

bind('[data-action-export-text]', (button) => {
  button.addEventListener('click', () => {
    downloadBlob(textData, 'resume.txt', 'text/plain');
    showToast('TXT export ready');
  });
});
</script>
