---
import type resumeData from "../../data/resume.json";
import { buildSparkPath } from "../ui/Sparkline";
import { bulletMetrics } from "../ui/BulletGraph";
import { meetsEvidenceThreshold } from "../../utils/metrics";
const { experiments } = Astro.props as { experiments: typeof resumeData.experiments };
---
<section class="rounded-3xl border border-[color-mix(in_srgb,var(--ink)_10%,transparent)] bg-[var(--surface-alt)] p-8 shadow-lg shadow-black/10">
  <div class="flex flex-col gap-6">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold text-[var(--ink)]">Experiment Gallery</h2>
      <span class="text-xs text-[var(--ink-2)]">Signals with evidence</span>
    </div>
    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
      {experiments.map((exp) => {
        const evidence = meetsEvidenceThreshold(exp.sample, exp.confidence);
        const chart = exp.chart.type === "spark"
          ? { type: "spark", path: buildSparkPath(exp.chart.values) }
          : { type: "bullet", metrics: bulletMetrics(exp.chart.values) };
        return (
          <article class="card flex flex-col gap-4 rounded-2xl border border-[color-mix(in_srgb,var(--ink)_10%,transparent)] bg-[color-mix(in_srgb,var(--surface)_96%,var(--accent)_4%)] p-6 shadow-inner shadow-black/5" key={exp.id}>
            <div class="flex flex-col gap-2">
              <h3 class="text-lg font-semibold text-[var(--ink)]">{exp.title}</h3>
              <div class="flex flex-wrap gap-2 text-[11px] uppercase tracking-wide text-[var(--ink-2)]">
                <span class="rounded-full bg-[color-mix(in_srgb,var(--ink)_6%,transparent)] px-2 py-1">Problem</span>
                <span class="rounded-full bg-[color-mix(in_srgb,var(--ink)_6%,transparent)] px-2 py-1">Bet</span>
                <span class="rounded-full bg-[color-mix(in_srgb,var(--ink)_6%,transparent)] px-2 py-1">Outcome</span>
              </div>
            </div>
            <div class="space-y-3 text-sm text-[var(--ink-2)]">
              <p><span class="font-medium text-[var(--ink)]">Problem:</span> {exp.problem}</p>
              <p><span class="font-medium text-[var(--ink)]">Bet:</span> {exp.bet}</p>
              <p><span class="font-medium text-[var(--ink)]">Outcome:</span> {exp.outcome}</p>
            </div>
            <div class="flex items-center justify-between">
              {chart.type === "spark" ? (
                <svg viewBox="0 0 100 100" class="h-16 w-32 text-[var(--accent)]">
                  <polyline points={chart.path.replace(/M|L/g, "").replace(/ /g, " ")} fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              ) : (
                <div class="flex h-16 w-full flex-col justify-center gap-2">
                  <div class="relative h-2 w-full overflow-hidden rounded-full bg-[color-mix(in_srgb,var(--ink)_8%,transparent)]">
                    <span style={{ width: `${chart.metrics.baseline}%` }} class="absolute inset-y-0 left-0 rounded-full bg-[color-mix(in_srgb,var(--ink)_20%,transparent)]"></span>
                    <span style={{ width: `${chart.metrics.variant}%` }} class="absolute inset-y-0 left-0 rounded-full bg-[var(--accent)]"></span>
                  </div>
                  <div class="text-xs text-[var(--ink-2)]">Baseline vs Variant</div>
                </div>
              )}
              {evidence ? (
                <div class="ml-auto flex flex-col items-end text-xs text-[var(--ink-2)]">
                  {exp.sample ? <span>{exp.sample.toLocaleString()} sample</span> : null}
                  {exp.confidence ? <span>{exp.confidence}</span> : null}
                </div>
              ) : (
                <span class="text-xs text-[var(--ink-2)]">Directional</span>
              )}
            </div>
          </article>
        );
      })}
    </div>
  </div>
</section>
