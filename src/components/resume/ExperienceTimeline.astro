---
import ExperienceCard from "./ExperienceCard.astro";

interface ExperienceItem {
  id: string;
  org_public: string;
  org_confidential: string;
  role_public: string;
  role_confidential: string;
  start: string;
  end: string;
  team_size?: number;
  budget_band?: string;
  surfaces?: string;
  stack?: string[];
  metrics: {
    label: string;
    delta_pct: number;
    baseline?: number;
    sample?: number;
    confidence?: string;
    note?: string;
  }[];
  impacts: string[];
  artifacts: {
    label: string;
    url: string;
    sensitive?: boolean;
  }[];
  caseStudies?: {
    id: string;
    title: string;
    sensitive?: boolean;
  }[];
  tags?: string[];
}

const { experiences } = Astro.props as { experiences: ExperienceItem[] };
---
<section class="flex flex-col gap-6" id="experience">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div class="flex flex-col gap-2">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Experience</span>
      <h2 class="text-lg font-semibold text-[color:var(--ink)]">Timeline</h2>
      <p class="max-w-3xl text-sm text-[color:var(--ink-2)]">Outcome-first narrative across portfolios, SaaS commerce, DTC health, and independent engagements.</p>
    </div>
    <button
      type="button"
      class="inline-flex items-center gap-2 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink)] transition-colors duration-150 ease-[cubic-bezier(.2,.8,.2,1)] hover:border-[color:color-mix(in_srgb,var(--accent)_30%,transparent)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
      data-expand-all
    >
      Expand all
    </button>
  </div>
  <div class="flex flex-col gap-4" data-experience-list>
    {experiences.map((experience) => (
      <ExperienceCard experience={experience} />
    ))}
  </div>
</section>
<script type="module">
const button = document.querySelector<HTMLButtonElement>("[data-expand-all]");
const list = document.querySelector("[data-experience-list]");

const expand = () => {
  if (!list) return;
  const cards = Array.from(list.querySelectorAll<HTMLDetailsElement>("[data-experience-card]"));
  if (!cards.length) return;
  cards.forEach((card) => {
    card.open = true;
  });
  const firstSummary = cards[0].querySelector<HTMLSummaryElement>("summary");
  if (firstSummary) firstSummary.focus();
};

if (button && button.dataset.bound !== "true") {
  button.dataset.bound = "true";
  button.addEventListener("click", expand);
  button.addEventListener("keydown", (event) => {
    if (event.key === "Enter" || event.key === " ") {
      event.preventDefault();
      expand();
    }
  });
}

document.addEventListener("astro:page-load", () => {
  if (!button || button.dataset.bound === "true") return;
  button.dataset.bound = "true";
  button.addEventListener("click", expand);
  button.addEventListener("keydown", (event) => {
    if (event.key === "Enter" || event.key === " ") {
      event.preventDefault();
      expand();
    }
  });
});
</script>
