---
interface BeforeAfterItem {
  id: string;
  title: string;
  beforeImg: string;
  afterImg: string;
  note?: string;
}

const { items } = Astro.props as { items: BeforeAfterItem[] };
---
<section class="flex flex-col gap-6" id="before-after">
  <div class="flex flex-col gap-2">
    <span class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Proof</span>
    <h2 class="text-lg font-semibold text-[color:var(--ink)]">Before / After</h2>
    <p class="max-w-2xl text-sm text-[color:var(--ink-2)]">Draggable slices reveal program shifts across checkout, navigation, and search.</p>
  </div>
  <div class="grid gap-6 lg:grid-cols-3">
    {items.map((item) => (
      <article
        class="group relative flex flex-col gap-3 overflow-hidden rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_94%,transparent)] p-4 shadow-[0_20px_48px_-40px_rgba(12,20,32,0.6)]"
        data-before-after
        data-motion
      >
        <div class="relative h-56 overflow-hidden rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)]">
          <img src={item.afterImg} alt="After state for {item.title}" class="h-full w-full object-cover" loading="lazy" />
          <div class="absolute inset-0" data-before-mask>
            <img src={item.beforeImg} alt="Before state for {item.title}" class="h-full w-full object-cover" loading="lazy" />
          </div>
          <input
            type="range"
            min="0"
            max="100"
            value="50"
            class="absolute inset-x-0 bottom-3 mx-auto h-1 w-11/12 appearance-none rounded-full bg-white/20 [--tw-shadow:0_0_0_1px_rgba(12,20,32,0.25)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[color:var(--accent)]"
            aria-label={`Adjust before and after for ${item.title}`}
            data-before-slider
          />
          <div class="pointer-events-none absolute inset-y-0 left-1/2 flex h-full w-0.5 -translate-x-1/2 items-center justify-center bg-white/60" data-before-handle>
            <span class="flex h-8 w-8 items-center justify-center rounded-full bg-[color:var(--accent)] text-white shadow-lg">â†”</span>
          </div>
        </div>
        <div class="flex flex-col gap-2 text-sm text-[color:var(--ink-2)]">
          <h3 class="text-base font-semibold text-[color:var(--ink)]">{item.title}</h3>
          {item.note && <p>{item.note}</p>}
        </div>
      </article>
    ))}
  </div>
</section>
<script type="module">
import { prefersReducedMotion } from "../../utils/motion";

const clamp = (value: number) => Math.min(100, Math.max(0, value));

const init = () => {
  document.querySelectorAll<HTMLElement>("[data-before-after]").forEach((card) => {
    const mask = card.querySelector<HTMLElement>("[data-before-mask]");
    const slider = card.querySelector<HTMLInputElement>("[data-before-slider]");
    const handle = card.querySelector<HTMLElement>("[data-before-handle]");
    if (!mask || !slider || !handle) return;
    const setValue = (value: number) => {
      const clamped = clamp(value);
      mask.style.clipPath = `inset(0 ${100 - clamped}% 0 0)`;
      handle.style.left = `${clamped}%`;
      slider.value = clamped.toString();
    };
    setValue(Number(slider.value));
    const updateFromPointer = (event: PointerEvent) => {
      const rect = card.getBoundingClientRect();
      const percentage = ((event.clientX - rect.left) / rect.width) * 100;
      setValue(percentage);
    };
    slider.addEventListener("input", () => setValue(Number(slider.value)));
    card.addEventListener("pointerdown", (event) => {
      if (prefersReducedMotion()) return;
      card.setPointerCapture(event.pointerId);
      updateFromPointer(event);
      const move = (moveEvent: PointerEvent) => updateFromPointer(moveEvent);
      const up = (upEvent: PointerEvent) => {
        card.releasePointerCapture(upEvent.pointerId);
        card.removeEventListener("pointermove", move);
        card.removeEventListener("pointerup", up);
      };
      card.addEventListener("pointermove", move);
      card.addEventListener("pointerup", up);
    });
  });
};

init();
document.addEventListener("astro:page-load", init);
</script>
