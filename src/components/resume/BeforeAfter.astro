---
interface BeforeAfterItem {
  id: string;
  title: string;
  beforeImg: string;
  afterImg: string;
  note?: string;
}

const { items } = Astro.props as { items: BeforeAfterItem[] };
---
<section class="flex flex-col gap-6">
  <div class="flex flex-col gap-3">
    <h2 class="text-lg font-semibold text-[color:var(--ink)]">Proof Modules · Before → After</h2>
    <p class="text-sm text-[color:var(--ink-2)]">Drag the seam to inspect shifts from the original state into the shipped experience.</p>
  </div>
  <div class="grid gap-6 md:grid-cols-3">
    {items.map((item) => (
      <figure
        class="flex flex-col gap-3 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_90%,transparent)] p-4"
      >
        <div
          class="relative h-64 overflow-hidden rounded-[var(--r-3)]"
          data-before-after-root
          style={`--position:50%;--before:${item.beforeImg};--after:${item.afterImg};`}
        >
          <div class="absolute inset-0" aria-hidden="true">
            <div class="absolute inset-0 bg-[image:var(--after)] bg-cover bg-center"></div>
            <div class="absolute inset-0 bg-[image:var(--before)] bg-cover bg-center" data-before-pane style="width:var(--position);"></div>
            <span class="absolute left-4 top-4 rounded-full bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] px-2 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)]">Before</span>
            <span class="absolute right-4 top-4 rounded-full bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] px-2 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)]">After</span>
          </div>
          <button
            type="button"
            class="group absolute inset-y-0 flex w-10 translate-x-[-50%] items-center justify-center"
            data-before-handle
            aria-label={`Drag to reveal ${item.title}`}
            role="slider"
            aria-valuemin="0"
            aria-valuemax="100"
            aria-valuenow="50"
            style="left:var(--position);"
          >
            <span class="pointer-events-none flex h-14 w-14 items-center justify-center rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_96%,transparent)] shadow-[0_10px_30px_-20px_rgba(12,20,32,0.6)] transition-transform duration-200 ease-[cubic-bezier(.2,.8,.2,1)] group-hover:scale-105">
              <span class="flex items-center gap-1 text-xs font-semibold text-[color:var(--ink)]">
                <span aria-hidden="true">↔</span>
              </span>
            </span>
          </button>
        </div>
        <figcaption class="flex flex-col gap-2">
          <span class="text-sm font-semibold text-[color:var(--ink)]">{item.title}</span>
          {item.note && <span class="text-sm text-[color:var(--ink-2)]">{item.note}</span>}
        </figcaption>
      </figure>
    ))}
  </div>
</section>
<style is:inline>
[data-before-after-root] {
  --position: 50%;
}
@media (prefers-reduced-motion: reduce) {
  [data-before-handle] span {
    transition: none;
  }
}
</style>
<script type="module">
const attach = (root: HTMLElement) => {
  if (root.dataset.bound === 'true') return;
  root.dataset.bound = 'true';
  const pane = root.querySelector<HTMLElement>('[data-before-pane]');
  const handle = root.querySelector<HTMLButtonElement>('[data-before-handle]');
  if (!pane || !handle) return;
  let active = false;
  const setPosition = (percent: number) => {
    const clamped = Math.min(Math.max(percent, 0), 100);
    root.style.setProperty('--position', `${clamped}%`);
    pane.style.width = `${clamped}%`;
    handle.style.left = `${clamped}%`;
    handle.setAttribute('aria-valuenow', String(Math.round(clamped)));
  };
  const positionFromEvent = (event: PointerEvent) => {
    const rect = root.getBoundingClientRect();
    const x = event.clientX - rect.left;
    setPosition((x / rect.width) * 100);
  };
  handle.addEventListener('pointerdown', (event) => {
    active = true;
    handle.setPointerCapture(event.pointerId);
  });
  window.addEventListener('pointerup', (event) => {
    if (!active) return;
    active = false;
    handle.releasePointerCapture(event.pointerId);
  });
  root.addEventListener('pointermove', (event) => {
    if (!active) return;
    positionFromEvent(event);
  });
  handle.addEventListener('keydown', (event) => {
    if (event.key === 'ArrowLeft') {
      event.preventDefault();
      const value = Number(handle.getAttribute('aria-valuenow') ?? '50') - 5;
      setPosition(value);
    }
    if (event.key === 'ArrowRight') {
      event.preventDefault();
      const value = Number(handle.getAttribute('aria-valuenow') ?? '50') + 5;
      setPosition(value);
    }
  });
};

document.querySelectorAll<HTMLElement>('[data-before-after-root]').forEach((root) => attach(root));
document.addEventListener('astro:page-load', () => {
  document.querySelectorAll<HTMLElement>('[data-before-after-root]').forEach((root) => attach(root));
});
</script>
