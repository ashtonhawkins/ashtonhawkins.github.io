---
import { meetsMetricGate, formatSample, inferSuffix, formatKpiValue } from "../../utils/metrics";

interface KpiItem {
  key: string;
  label: string;
  value: number;
  suffix?: string;
  sample?: number;
  confidence?: string;
}

const { items } = Astro.props as { items: KpiItem[] };
const filtered = items.filter((item) => meetsMetricGate(item));
---
{filtered.length > 0 && (
  <section class="flex flex-col gap-5" aria-labelledby="kpi-heading">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <span id="kpi-heading" class="text-xs font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">
        Signature Outcomes
      </span>
      <span class="text-[11px] uppercase tracking-[0.24em] text-[color:var(--ink-2)]">Audited programs</span>
    </div>
    <div class="grid gap-3 sm:grid-cols-3">
      {filtered.map((item) => {
        const suffix = inferSuffix(item);
        const formatted = formatKpiValue(item.value, suffix);
        const sample = formatSample(item.sample);
        return (
          <article
            class="relative flex flex-col gap-4 rounded-[var(--radius-3)] border border-[color:var(--keyline)] bg-[color:color-mix(in_lab,var(--surface) 92%, transparent)] p-5"
            data-motion
          >
            <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
              <span>{item.label}</span>
              {item.confidence && (
                <span class="inline-flex items-center gap-1 rounded-full border border-[color:var(--keyline)] bg-[color:color-mix(in_lab,var(--surface) 90%, transparent)] px-2 py-0.5 text-[10px] font-semibold text-[color:var(--ink-2)]">
                  {item.confidence}
                </span>
              )}
            </div>
            <div class="flex items-end gap-2">
              <span
                class="text-4xl font-semibold tracking-tight text-[color:var(--ink)]"
                data-kpi
                data-final={item.value}
                data-suffix={suffix}
                data-animated="0"
              >
                {formatted}
              </span>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-xs text-[color:var(--ink-2)]">
              {sample && <span>{sample}</span>}
            </div>
          </article>
        );
      })}
    </div>
  </section>
)}
<script type="module">
  import { onceVisible, animateCounter, durations } from "../../utils/motion";
  import { formatKpiValue } from "../../utils/metrics";

  const hydrate = () => {
    const nodes = document.querySelectorAll<HTMLElement>("[data-kpi]");
    if (!nodes.length) return;
    onceVisible(nodes, (node) => {
      if (node.dataset.animated === "1") return;
      const finalValue = Number(node.dataset.final ?? "0");
      const suffix = node.dataset.suffix ?? "";
      node.dataset.animated = "1";
      animateCounter(node, finalValue, {
        duration: durations.slow,
        formatter: (value) => formatKpiValue(value, suffix)
      });
    }, 0.5);
  };

  hydrate();
  document.addEventListener("astro:page-load", hydrate);
</script>
