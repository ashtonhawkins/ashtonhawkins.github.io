---

interface KpiItem {
  key: string;
  label: string;
  value: number;
  suffix?: string;
  sample?: number;
  confidence?: string;
}

const { items } = Astro.props as { items: KpiItem[] };
const compactFormatter = new Intl.NumberFormat("en-US", {
  notation: "compact",
  maximumFractionDigits: 1
});
const eligible = items
  .filter((item) => (item.sample ?? 0) >= 1000 || !!item.confidence)
  .slice(0, 3);
const toSampleText = (sample?: number) => {
  if (!sample) return "";
  return `${compactFormatter.format(sample)} sample`;
};
const toDecimals = (value: number) => {
  const [, decimals] = value.toString().split(".");
  return Math.min(decimals ? decimals.length : 0, 2);
};
---
{eligible.length === 3 && (
  <section class="flex flex-col gap-6" data-scoreboard>
    <div class="flex items-center gap-3">
      <h2 class="text-sm font-semibold tracking-[0.32em] uppercase text-[color:var(--ink-2)]">Signature Outcomes</h2>
      <div class="flex items-center gap-1 rounded-full border border-[color:var(--ink-2)]/20 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
        <span>Reel</span>
      </div>
    </div>
    <div class="grid gap-4 sm:grid-cols-3">
      {eligible.map((item) => (
        <article
          class="group relative flex flex-col gap-4 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_12%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_92%,transparent)] p-4 shadow-[0_12px_32px_-24px_rgba(12,20,32,0.45)]"
          data-kpi-tile
        >
          <div class="flex items-center justify-between gap-2 text-xs uppercase tracking-[0.24em] text-[color:var(--ink-2)]">
            <span>{item.label}</span>
            {item.confidence && (
              <span class="rounded-full border border-[color:var(--accent)]/50 bg-[color:color-mix(in_srgb,var(--accent)_16%,transparent)] px-2 py-1 text-[0.6rem] font-semibold text-[color:var(--accent)]">
                CI
              </span>
            )}
          </div>
          <div class="flex items-baseline gap-2">
            <span
              class="text-4xl font-semibold tracking-tight text-[color:var(--ink)]"
              data-kpi-value
              data-value={item.value}
              data-suffix={item.suffix ?? ""}
              data-decimals={toDecimals(item.value)}
            >
              0
            </span>
          </div>
          <div class="flex items-center justify-between text-xs text-[color:var(--ink-2)]">
            <span>{toSampleText(item.sample)}</span>
            {item.confidence && <span>{item.confidence}</span>}
          </div>
        </article>
      ))}
    </div>
  </section>
)}
<script type="module">
import { animate } from "motion";
import { motion as motionConfig, prefersReducedMotion as prefers } from "../../utils/motion";

const run = () => {
  if (prefers()) return;
  document.querySelectorAll('[data-kpi-value]').forEach((el) => {
    const target = Number(el.getAttribute('data-value') ?? '0');
    const suffix = el.getAttribute('data-suffix') ?? '';
    const decimals = Number(el.getAttribute('data-decimals') ?? '0');
    animate(0, target, {
      duration: motionConfig.durations.slow,
      easing: motionConfig.easing,
      onUpdate: (value) => {
        el.textContent = value.toFixed(decimals) + suffix;
      }
    });
  });
};
run();
document.addEventListener('astro:page-load', run);
</script>
