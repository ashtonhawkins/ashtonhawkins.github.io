---
import { meetsMetricGate, formatSample } from "../../utils/metrics";

interface KpiItem {
  key: string;
  label: string;
  value: number;
  suffix?: string;
  sample?: number;
  confidence?: string;
}

const { items } = Astro.props as { items: KpiItem[] };
const filtered = items.filter((item) => meetsMetricGate(item)).slice(0, 3);
const decimals = (value: number) => {
  const [, fractional] = value.toString().split(".");
  return fractional ? Math.min(2, fractional.length) : 0;
};
const suffixFor = (item: KpiItem) => {
  if (item.suffix) return item.suffix;
  const label = item.label.toLowerCase();
  if (label.includes("pp")) return " pp";
  if (label.includes("%") || label.includes("lift") || label.includes("Î”") || label.includes("rate")) return "%";
  return "";
};
---
{filtered.length === 3 && (
  <section class="flex flex-col gap-5" data-scoreboard>
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h2 class="text-sm font-semibold uppercase tracking-[0.32em] text-[color:var(--ink-2)]">Signature Outcomes</h2>
      <span class="text-xs uppercase tracking-[0.28em] text-[color:var(--ink-2)]">Audited programs</span>
    </div>
    <div class="grid gap-4 sm:grid-cols-3">
      {filtered.map((item) => (
        <article
          class="group relative flex flex-col gap-4 rounded-[var(--r-3)] border border-[color:color-mix(in_srgb,var(--ink)_14%,transparent)] bg-[color:color-mix(in_srgb,var(--surface)_92%,transparent)] p-5 shadow-[0_24px_60px_-48px_rgba(12,20,32,0.65)]"
          data-motion
          data-motion-delay="0"
        >
          <div class="flex items-center justify-between text-xs uppercase tracking-[0.28em] text-[color:var(--ink-2)]">
            <span>{item.label}</span>
            {item.confidence && (
              <span class="inline-flex items-center gap-1 rounded-full border border-[color:color-mix(in_srgb,var(--ink)_16%,transparent)] bg-[color:color-mix(in_srgb,var(--surface-alt)_84%,transparent)] px-2 py-1 text-[10px] font-semibold text-[color:var(--ink-2)]">
                CI
              </span>
            )}
          </div>
          <div class="flex items-baseline gap-2">
            <span
              class="text-4xl font-semibold tracking-tight text-[color:var(--ink)]"
              data-kpi-value
              data-value={item.value}
              data-decimals={decimals(item.value)}
              data-suffix={suffixFor(item)}
            >
              0
            </span>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-2 text-xs text-[color:var(--ink-2)]">
            <span>{formatSample(item.sample)}</span>
            {item.confidence && <span>{item.confidence}</span>}
          </div>
        </article>
      ))}
    </div>
  </section>
)}
<script type="module">
import { animate } from "motion";
import { onceVisible, prefersReducedMotion, durations, easing } from "../../utils/motion";

const storeKey = "resume_kpi_animated";
const runAnimation = () => {
  const nodes = document.querySelectorAll<HTMLElement>("[data-kpi-value]");
  if (!nodes.length) return;
  if (prefersReducedMotion() || sessionStorage.getItem(storeKey) === "true") {
    nodes.forEach((node) => {
      const target = Number(node.dataset.value ?? "0");
      const suffix = node.dataset.suffix ?? "";
      const decimals = Number(node.dataset.decimals ?? "0");
      node.textContent = target.toFixed(decimals) + suffix;
    });
    sessionStorage.setItem(storeKey, "true");
    return;
  }
  onceVisible(nodes, (node) => {
    const target = Number(node.dataset.value ?? "0");
    const suffix = node.dataset.suffix ?? "";
    const decimals = Number(node.dataset.decimals ?? "0");
    animate(0, target, {
      duration: durations.slow,
      easing,
      onUpdate: (value) => {
        node.textContent = value.toFixed(decimals) + suffix;
      },
      onComplete: () => {
        node.textContent = target.toFixed(decimals) + suffix;
        sessionStorage.setItem(storeKey, "true");
      }
    });
  }, 0.4);
};

runAnimation();
document.addEventListener("astro:page-load", runAnimation);
</script>
