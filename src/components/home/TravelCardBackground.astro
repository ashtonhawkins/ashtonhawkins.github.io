---
import landmarks from '@data/travel-landmarks.json';
const map = landmarks as Record<string, { landmark: string; path: string }>;
---
<div class="travel-bg" data-travel-bg data-landmarks={JSON.stringify(map)}>
  <canvas data-travel-grid></canvas>
  <svg viewBox="0 0 200 220" class="travel-landmark" data-travel-landmark aria-hidden="true">
    <path d="" data-landmark-path></path>
  </svg>
</div>

<style>
  .travel-bg { position:absolute; inset:0; }
  .travel-bg canvas,.travel-landmark { position:absolute; inset:0; width:100%; height:100%; }
  .travel-landmark path { fill:none; stroke:color-mix(in srgb,var(--accent-primary) 40%, transparent); stroke-width:1.4; stroke-linecap:round; stroke-linejoin:round; }
</style>

<script>
  // @ts-nocheck
  const bg = document.querySelector('[data-travel-bg]');
  const canvas = document.querySelector('[data-travel-grid]');
  const pathEl = document.querySelector('[data-landmark-path]');
  if (bg instanceof HTMLElement && canvas instanceof HTMLCanvasElement && pathEl instanceof SVGPathElement) {
    const ctx = canvas.getContext('2d');
    if (ctx instanceof CanvasRenderingContext2D) {
    const landmarks = JSON.parse(bg.dataset.landmarks ?? '{}');
    let w = 0; let h = 0;

    const resize = () => {
      const r = canvas.getBoundingClientRect(); w = r.width; h = r.height;
      canvas.width = Math.floor(w * devicePixelRatio); canvas.height = Math.floor(h * devicePixelRatio);
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    };

    const seededRand = (seed) => {
      let s = seed;
      return () => {
        s = (s * 1664525 + 1013904223) % 4294967296;
        return s / 4294967296;
      };
    };

    const drawGrid = (city) => {
      let seed = 0;
      [...city].forEach((c) => { seed += c.charCodeAt(0); });
      const rand = seededRand(seed || 1);
      ctx.clearRect(0, 0, w, h);
      ctx.strokeStyle = 'color-mix(in srgb, var(--border) 20%, transparent)';
      ctx.globalAlpha = 0.25;
      for (let i = 0; i < 26; i += 1) {
        ctx.beginPath();
        let x = rand() * w; let y = rand() * h;
        ctx.moveTo(x, y);
        for (let j = 0; j < 8; j += 1) {
          x += (rand() - 0.5) * 48;
          y += (rand() - 0.5) * 36;
          ctx.lineTo(x, y);
        }
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
    };

    const setCity = (city) => {
      resize();
      drawGrid(city);
      const landmark = landmarks[city];
      pathEl.setAttribute('d', landmark?.path ?? 'M40,180 L160,180');
      const len = pathEl.getTotalLength();
      pathEl.style.strokeDasharray = `${len}`;
      pathEl.style.strokeDashoffset = `${len}`;
      pathEl.animate([{ strokeDashoffset: len }, { strokeDashoffset: 0 }], { duration: 3400, easing: 'ease-out' });
    };

    bg.addEventListener('travel-city-change', (event) => setCity(event.detail.city));
    setCity('Tokyo');
    window.addEventListener('resize', () => setCity((document.querySelector('[data-travel-city]')?.textContent || 'Tokyo').trim()));
    }
  }
</script>
