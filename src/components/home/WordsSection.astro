---
import SectionHeader from '@components/ui/SectionHeader.astro';
import WritingDrift from '@components/home/WritingDrift.astro';
import site from '@data/site.json';

const xUrl = site.social?.x ?? 'https://x.com/ashtin';
const screenName = xUrl.split('/').filter(Boolean).pop() ?? 'ashtin';
---
<section id="words" class="words-section" data-x-screen-name={screenName}>
  <SectionHeader label="Words" />
  <div class="words-section__grid">
    <div class="words-section__drift">
      <WritingDrift />
    </div>
    <aside class="words-section__x-feed">
      <h3 class="x-feed__header"><span class="section-prefix">//</span><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="x-feed__logo" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></h3>
      <div class="words__x-feed-embed" id="x-feed-embed">
        <div class="words__x-feed-fallback" id="x-feed-fallback">
          <a href={xUrl} target="_blank" rel="noopener noreferrer">@{screenName} →</a>
        </div>
      </div>
    </aside>
  </div>
  <p class="writing__footer"><a href="/writing">VIEW ALL POSTS →</a></p>
</section>

<script is:inline>
  const section = document.querySelector('.words-section');
  const xContainer = document.getElementById('x-feed-embed');
  const fallback = document.getElementById('x-feed-fallback');
  const screenName = section?.getAttribute('data-x-screen-name') ?? 'ashtin';

  const showFallback = () => {
    if (fallback) {
      fallback.style.display = 'flex';
    }
  };

  const hideFallback = () => {
    if (fallback) {
      fallback.style.display = 'none';
    }
  };

  const ensureTwitterScript = () => {
    if (document.querySelector('script[data-twitter-widget="true"]')) {
      return;
    }

    const script = document.createElement('script');
    script.async = true;
    script.src = 'https://platform.twitter.com/widgets.js';
    script.setAttribute('data-twitter-widget', 'true');
    document.head.appendChild(script);
  };

  const renderTimeline = () => {
    if (!xContainer) {
      return;
    }

    hideFallback();
    xContainer.querySelectorAll('iframe, a.twitter-timeline').forEach((node) => node.remove());

    const theme = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
    const anchor = document.createElement('a');
    anchor.className = 'twitter-timeline';
    anchor.href = `https://twitter.com/${screenName}`;
    anchor.textContent = 'Loading posts...';
    anchor.setAttribute('data-theme', theme);
    anchor.setAttribute('data-chrome', 'noheader nofooter noborders transparent');
    anchor.setAttribute('data-height', '300');
    anchor.setAttribute('data-width', '100%');
    anchor.setAttribute('data-tweet-limit', '3');
    xContainer.prepend(anchor);

    ensureTwitterScript();

    if (window.twttr?.widgets?.load) {
      window.twttr.widgets.load(xContainer);
    }

    window.setTimeout(() => {
      const hasEmbed = Boolean(xContainer.querySelector('iframe'));
      if (!hasEmbed) {
        showFallback();
      }
    }, 5000);
  };

  renderTimeline();

  const observer = new MutationObserver((entries) => {
    for (const entry of entries) {
      if (entry.type === 'attributes' && entry.attributeName === 'data-theme') {
        renderTimeline();
      }
    }
  });

  observer.observe(document.documentElement, { attributes: true });
</script>
<style>
.words-section__grid { display:grid; grid-template-columns:1fr 1fr; gap:0; }
.words-section__drift { border:1px solid var(--border); border-right:none; position:relative; overflow:hidden; min-height:200px; }
.words-section__x-feed{border:1px solid var(--border);padding:1rem;background:var(--surface-primary)}
.x-feed__header{margin:0 0 .6rem;display:flex;align-items:center;gap:.4rem;font:700 .76rem 'IBM Plex Mono',monospace;letter-spacing:.08em}
.section-prefix{color:var(--text-tertiary)}
.x-feed__logo{display:block}
.words__x-feed-embed { max-height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.1) transparent; }
.words__x-feed-embed iframe { border: none !important; border-radius: 4px; }
.words__x-feed-fallback { display: none; min-height: 120px; padding: 16px; align-items: center; justify-content: center; text-align: center; }
.words__x-feed-fallback a,.writing__footer a{text-decoration:none;font:.72rem 'IBM Plex Mono',monospace;color:var(--text-secondary);letter-spacing:.08em}
.words__x-feed-fallback a:hover,.writing__footer a:hover{color:var(--accent-primary)}
@media (max-width: 768px) { .words-section__grid { grid-template-columns:1fr; } .words-section__drift { border-right:1px solid var(--border); } }
</style>
