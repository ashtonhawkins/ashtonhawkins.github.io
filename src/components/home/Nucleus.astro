---
import NucleusCanvas from '@components/home/NucleusCanvas.astro';
---

<div class="nucleus-wrapper container-shell max-wide">
  <section class="nucleus" aria-label="Nucleus">
    <div class="nucleus__frame" data-nucleus>
      <NucleusCanvas />
      <div class="nucleus__caption" id="nucleus-caption">
        <a href="#cycling" class="nucleus__caption-link" id="nucleus-link">
          <span class="nucleus__caption-label" id="nucleus-label">CYCLING</span>
          <span class="nucleus__caption-detail" id="nucleus-detail">Last Ride: 23 mi / 1,400 ft</span>
          <span class="nucleus__caption-arrow">→</span>
        </a>
      </div>

      <nav class="nucleus-track" id="nucleus-track" aria-label="Carousel navigation">
        <div class="nucleus-track__segments" id="nucleus-track-segments"></div>
        <span class="nucleus-track__label" aria-live="polite"></span>
      </nav>

      <div class="nucleus__progress" id="nucleus-progress"></div>
    </div>
  </section>
</div>

<style is:global>
  .nucleus-wrapper {
    position: relative;
  }

  .nucleus {
    height: clamp(180px, 22vh, 320px);
    width: 100%;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border);
    margin-top: 1rem;
    margin-bottom: 0;
    background: var(--surface-primary);
  }

  .nucleus__frame {
    position: relative;
    height: 100%;
    width: 100%;
    background: var(--surface-primary);
  }

  .nucleus__caption {
    position: absolute;
    bottom: 12px;
    left: 16px;
    z-index: 10;
    background: rgba(var(--surface-primary-rgb), 0.65);
    backdrop-filter: blur(6px);
    padding: 8px 14px;
    border-radius: 4px;
    border: 1px solid var(--border);
  }

  .nucleus__caption-link {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: var(--text-primary);
  }

  .nucleus__caption-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent-primary);
    padding: 2px 6px;
    border: 1px solid var(--accent-primary);
    border-radius: 3px;
  }

  .nucleus__caption-detail {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: var(--text-secondary);
  }

  .nucleus__caption-arrow {
    font-size: 14px;
    color: var(--accent-primary);
  }

  .nucleus-track {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    z-index: 10;
    pointer-events: auto;
  }

  .nucleus-track__segments {
    display: flex;
    gap: 3px;
    align-items: center;
  }

  .nucleus-track__segment {
    /* Reset */
    appearance: none;
    -webkit-appearance: none;
    border: none;
    background: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    box-sizing: content-box;

    /* Visual segment: 32px wide, 3px tall bar */
    width: 32px;
    height: 3px;
    border-radius: 1.5px;
    position: relative;
    overflow: hidden;
    background: var(--border, #334155);
    opacity: 0.4;

    /* Enlarged hit target without affecting visual size */
    padding-top: 10px;
    padding-bottom: 10px;
    margin-top: -10px;
    margin-bottom: -10px;
    background-clip: content-box;

    transition: opacity 0.3s ease, width 0.3s ease;
  }

  .nucleus-track__segment:hover {
    opacity: 0.7;
  }

  .nucleus-track__segment:focus-visible {
    outline: 2px solid var(--accent-primary, #60a5fa);
    outline-offset: 4px;
    border-radius: 2px;
  }

  /* Active segment — wider, full opacity, transparent bg so the fill span shows through */
  .nucleus-track__segment[aria-current='true'] {
    width: 48px;
    opacity: 1;
    background-color: transparent;
    background-clip: content-box;
  }

  /* Give inactive segments a visible bar background via content-box clipping */
  .nucleus-track__segment[aria-current='false'] {
    background-color: var(--border, #334155);
    background-clip: content-box;
  }

  /* Fill bar inside active segment — animates left to right to show auto-advance progress */
  .nucleus-track__fill {
    position: absolute;
    left: 0;
    width: 0%;
    border-radius: 1.5px;
    background: var(--accent-primary, #60a5fa);
    animation: track-fill var(--slide-duration, 9s) linear forwards;
    /* Ensure fill sits within the content-box area, not the padded hit target */
    top: 10px;
    height: 3px;
  }

  /* Only show fill on active segment */
  .nucleus-track__segment[aria-current='false'] .nucleus-track__fill {
    display: none;
  }

  .nucleus-track__segment[aria-current='true'] .nucleus-track__fill {
    animation: track-fill var(--slide-duration, 9s) linear forwards;
  }

  @keyframes track-fill {
    from { width: 0%; }
    to { width: 100%; }
  }

  .nucleus-track__segment[data-mode='listening'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-listening, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='watching'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-watching, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='reading'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-reading, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='travel'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-travel, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='cycling'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-cycling, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='writing'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-writing, var(--accent-primary));
  }

  .nucleus-track__segment[data-mode='biometrics'][aria-current='true'] .nucleus-track__fill {
    background: var(--accent-biometrics, var(--accent-primary));
  }

  /* Mode label below the track */
  .nucleus-track__label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-tertiary, #64748b);
    opacity: 0;
    transition: opacity 0.3s ease;
    white-space: nowrap;
    user-select: none;
  }

  /* Label appears on hover */
  .nucleus-track:hover .nucleus-track__label {
    opacity: 1;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .nucleus-track__segment[aria-current='true'] .nucleus-track__fill {
      animation: none;
      width: 100%;
    }

    .nucleus-track__segment {
      transition: none;
    }
  }

  @media (max-height: 400px) {
    .nucleus-track {
      bottom: 8px;
    }

    .nucleus-track__label {
      display: none;
    }
  }

  .nucleus__progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2px;
    width: 0%;
    background: var(--accent-primary);
    z-index: 5;
    transition: none;
    opacity: 0;
  }

  .nucleus__progress--filling {
    width: 100%;
    transition: width 9s linear, opacity 1s ease 0.5s;
    opacity: 0.35;
  }
</style>