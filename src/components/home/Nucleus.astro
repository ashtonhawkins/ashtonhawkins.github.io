---
import NoiseTexture from '@components/ui/NoiseTexture.astro';
import NucleusGraphic from '@components/home/NucleusGraphic.astro';
import quotes from '@data/quotes.json';

const quote = quotes[Math.floor(Math.random() * quotes.length)] ?? quotes[0];
---

<section class="nucleus container-shell max-wide" aria-label="Nucleus">
  <div class="nucleus__frame" data-nucleus data-quotes={JSON.stringify(quotes)}>
    <NucleusGraphic />
    <NoiseTexture opacity={0.04} />

    <ul class="nucleus__fragments" aria-hidden="true">
      <li style="--x:6%; --y:14%; --dur:18s; --delay:-3s;">Marin County</li>
      <li style="--x:68%; --y:18%; --dur:24s; --delay:-8s;">Director, CRO</li>
      <li style="--x:12%; --y:62%; --dur:28s; --delay:-6s;">Cyclist</li>
      <li style="--x:73%; --y:66%; --dur:20s; --delay:-10s;">Travel Obsessive</li>
      <li style="--x:34%; --y:26%; --dur:26s; --delay:-14s;">Building Things</li>
      <li style="--x:42%; --y:76%; --dur:30s; --delay:-16s;">Optimizing Everything</li>
    </ul>

    <blockquote class="nucleus__quote" data-nucleus-quote>
      <p data-quote-text>“{quote.text}”</p>
      <footer data-quote-author>— {quote.author}</footer>
    </blockquote>

    <div class="nucleus__counter" data-live-counter>
      <p class="nucleus__seconds" data-seconds>0</p>
      <p class="nucleus__label">SECONDS LIVE</p>
    </div>
  </div>
</section>

<style>
  .nucleus {
    margin-bottom: 2rem;
  }

  .nucleus__frame {
    position: relative;
    overflow: hidden;
    min-height: clamp(400px, 55vh, 700px);
    border: 1px solid var(--border);
    background: var(--bg-primary);
  }

  .nucleus__fragments {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nucleus__fragments li {
    position: absolute;
    z-index: 2;
    top: var(--y);
    left: var(--x);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.69rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: color-mix(in srgb, var(--text-tertiary) 60%, transparent);
    animation: drift var(--dur) ease-in-out infinite;
    animation-delay: var(--delay);
  }

  .nucleus__quote {
    position: absolute;
    inset: 0;
    z-index: 3;
    display: grid;
    place-content: center;
    text-align: center;
    padding: 2rem;
    margin: 0;
  }

  .nucleus__quote p {
    margin: 0;
    font-size: clamp(1rem, 2vw, 1.2rem);
    font-style: italic;
    max-width: 55ch;
  }

  .nucleus__quote footer {
    margin-top: 0.7rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-secondary);
  }

  .nucleus__counter {
    position: absolute;
    left: 50%;
    bottom: 1.5rem;
    transform: translateX(-50%);
    z-index: 4;
    text-align: center;
  }

  .nucleus__seconds {
    margin: 0;
    font-family: 'IBM Plex Mono', monospace;
    font-size: clamp(1.2rem, 2.5vw, 1.7rem);
    font-weight: 700;
    color: var(--accent-primary);
  }

  .nucleus__label {
    margin: 0;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.66rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }

  [data-nucleus-quote] {
    transition: opacity 500ms ease;
  }

  [data-nucleus-quote].is-fading {
    opacity: 0;
  }

  @media (width < 48rem) {
    .nucleus__fragments li:nth-child(n + 5) {
      display: none;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .nucleus__fragments li,
    [data-nucleus-quote] {
      animation: none;
      transition: none;
    }
  }

  @keyframes drift {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(8px);
    }
  }
</style>

<script>
  const launchDate = new Date('2025-02-19T00:00:00Z').getTime();
  const nucleus = document.querySelector('[data-nucleus]');
  const secondsEl = document.querySelector('[data-seconds]');
  const quoteWrap = document.querySelector('[data-nucleus-quote]');
  const quoteText = document.querySelector('[data-quote-text]');
  const quoteAuthor = document.querySelector('[data-quote-author]');

  const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (secondsEl instanceof HTMLElement) {
    const renderSeconds = () => {
      const seconds = Math.max(0, Math.floor((Date.now() - launchDate) / 1000));
      secondsEl.textContent = seconds.toLocaleString();
    };

    renderSeconds();
    window.setInterval(renderSeconds, reduced ? 60000 : 1000);
  }

  if (
    !reduced &&
    nucleus instanceof HTMLElement &&
    quoteWrap instanceof HTMLElement &&
    quoteText instanceof HTMLElement &&
    quoteAuthor instanceof HTMLElement
  ) {
    const pool = JSON.parse(nucleus.dataset.quotes ?? '[]');
    let index = Math.floor(Math.random() * pool.length);

    const rotateQuote = () => {
      if (pool.length < 2) return;
      quoteWrap.classList.add('is-fading');
      window.setTimeout(() => {
        index = (index + 1) % pool.length;
        quoteText.textContent = `“${pool[index].text}”`;
        quoteAuthor.textContent = `— ${pool[index].author}`;
        quoteWrap.classList.remove('is-fading');
      }, 500);
    };

    window.setInterval(rotateQuote, 20000);
  }
</script>
