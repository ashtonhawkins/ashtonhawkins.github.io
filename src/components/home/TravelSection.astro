---
import SectionHeader from '@components/ui/SectionHeader.astro';
import NoiseTexture from '@components/ui/NoiseTexture.astro';
import travelData from '@data/travel.json';
import superlativesData from '@data/travel-superlatives.json';

const photos = travelData.flatMap((trip) => trip.photos?.map((photo) => ({ ...photo, place: trip.place })) ?? []);
const firstPhoto = photos[0];
---

<section class="travel" data-travel data-photos={JSON.stringify(photos)}>
  <SectionHeader label="Travel" />
  <p class="travel__strip">
    {travelData.map((entry, index) => (
      <>
        <span>{entry.place.toUpperCase()} ×{entry.visits}</span>
        {index < travelData.length - 1 && <span class="sep">·</span>}
      </>
    ))}
  </p>

  <div class="travel__photo-frame" data-photo-frame>
    <img src={firstPhoto?.src} alt={firstPhoto?.alt ?? 'Travel placeholder'} data-photo-image />
    <NoiseTexture opacity={0.02} />
  </div>

  <ul class="travel__supers">
    {superlativesData.superlatives.slice(0, 2).map((item) => (
      <li>
        <a href="/writing">{item.category.toUpperCase()} {superlativesData.year}: {item.value} — {item.place}</a>
      </li>
    ))}
  </ul>
</section>

<style>
  .travel__strip,
  .travel__supers {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-secondary);
  }
  .travel__strip { display: flex; flex-wrap: wrap; gap: 0.45rem; margin: 0 0 1rem; }
  .sep { color: var(--text-tertiary); }
  .travel__photo-frame { position: relative; aspect-ratio: 16/9; border: 1px solid var(--border); overflow: hidden; margin-bottom: 1rem; }
  .travel__photo-frame img { width: 100%; height: 100%; object-fit: cover; display: block; transition: opacity 500ms ease; }
  .travel__photo-frame img.is-fading { opacity: 0; }
  .travel__supers { list-style: none; margin: 0; padding: 0; display: grid; gap: 0.4rem; }
  .travel__supers a { color: inherit; text-decoration: none; }
  .travel__supers a:hover { color: var(--accent-primary); }
</style>

<script>
  const travelRoot = document.querySelector('[data-travel]');
  const image = document.querySelector('[data-photo-image]');
  const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (travelRoot instanceof HTMLElement && image instanceof HTMLImageElement && !reduced) {
    const photos = JSON.parse(travelRoot.dataset.photos ?? '[]');
    let index = 0;
    window.setInterval(() => {
      if (photos.length < 2) return;
      image.classList.add('is-fading');
      window.setTimeout(() => {
        index = (index + 1) % photos.length;
        image.src = photos[index].src;
        image.alt = photos[index].alt;
        image.classList.remove('is-fading');
      }, 400);
    }, 15000);
  }
</script>
