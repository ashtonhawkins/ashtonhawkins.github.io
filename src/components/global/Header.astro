---
import ThemeToggle from '@components/global/ThemeToggle.astro';
import Cursor from '@components/ui/Cursor.astro';
import NoiseTexture from '@components/ui/NoiseTexture.astro';
import AnalogClock from '@components/ui/AnalogClock.astro';
import feedCache from '@data/feeds-cache.json';
import siteStats from '@data/site-stats.json';
import commitStats from '@data/commit-stats.json';
import buildWeight from '@data/build-weight.json';

const pathname = Astro.url.pathname;
const links = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { href: '/work', label: 'Work' },
  { href: '/ventures', label: 'Ventures' },
  { href: '/travel', label: 'Travel' }
];

const mobileLinks = [
  ...links,
  { href: '/now', label: 'Now' },
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const nowFlyoutLinks = [
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  return pathname === href || pathname.startsWith(`${href}/`);
};

const DEPLOY_DATE = new Date();
const LAUNCH_EPOCH = '2025-01-20T00:00:00.000Z';
const feedStatus = {
  letterboxd: ((feedCache as any)?.items?.letterboxd?.length ?? 0) > 0,
  lastfm: ((feedCache as any)?.items?.lastfm?.length ?? 0) > 0,
  strava: Array.isArray((feedCache as any)?.items?.strava) ? ((feedCache as any)?.items?.strava?.length ?? 0) > 0 : false,
  oura: ((feedCache as any)?.items?.oura?.length ?? 0) > 0,
  goodreads: ((feedCache as any)?.items?.goodreads?.length ?? 0) > 0,
  github: true
};
const signalStatus = Object.fromEntries(
  Object.entries(feedStatus).map(([name, synced]) => [name, synced ? 'synced' : 'awaiting'])
);

const codebaseValue = `${(siteStats.lines / 1000).toFixed(1)}K lines · ${siteStats.components} modules`;
const footprintValue = `${Number(buildWeight.kb || 0).toLocaleString()} KB`;
---

<a href="#content" class="skip-link">Skip to content</a>
<header class="site-header" data-header>
  <NoiseTexture opacity={0.02} />
  <div class="header__nav-row header-inner container-shell max-wide">
    <a href="/" class="logotype" aria-label="Ashton Hawkins home" style="view-transition-name: logo-ashton-hawkins;">
      <span class="logotype__text">ASHTON HAWKINS</span>
      <Cursor class="logotype__cursor" />
    </a>

    <nav aria-label="Primary" class="desktop-nav">
      <ul>
        {links.map((link) => (
          <li>
            <a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined} class={isActive(link.href) ? 'active' : undefined}>{link.label}</a>
          </li>
        ))}
        <li class="nav__item nav__item--dropdown">
          <a href="/now" class={`nav__link ${isActive('/now') ? 'active' : ''}`.trim()} aria-current={isActive('/now') ? 'page' : undefined}>NOW</a>
          <div class="nav__flyout" aria-label="Now links">
            {nowFlyoutLinks.map((link) => (
              <a href={link.href} class="nav__flyout-link">{link.label}</a>
            ))}
          </div>
        </li>
      </ul>
    </nav>

    <div class="header__instruments">
      <div class="header__gauge-slot" id="gauge-slot" aria-label="Site vitals">
        <div class="header__gauge" data-gauge="updated" data-deploy-ts={DEPLOY_DATE.toISOString()}>
          <div class="header__gauge-viz" aria-hidden="true">
            <svg class="gauge-viz gauge-viz--ping" width="24" height="24" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="2.5" fill="var(--accent-primary)" />
              <circle cx="12" cy="12" r="2.5" fill="none" stroke="var(--accent-primary)" stroke-width="1" opacity="0">
                <animate attributeName="r" values="2.5;11" dur="2s" begin="0s" repeatCount="indefinite" />
                <animate attributeName="opacity" values="0.6;0" dur="2s" begin="0s" repeatCount="indefinite" />
              </circle>
            </svg>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">UPDATED</span><span class="header__gauge-value" id="gauge-updated">just now</span></div>
        </div>

        <div class="header__gauge" data-gauge="uptime" data-launch-epoch={LAUNCH_EPOCH}>
          <div class="header__gauge-viz gauge-viz--odometer" aria-hidden="true">
            <div class="odometer-group">
              <span class="odometer-digit" data-odometer-yr>0</span><span class="odometer-unit">y</span>
              <span class="odometer-digit" data-odometer-d>000</span><span class="odometer-unit">d</span>
              <span class="odometer-digit" data-odometer-h>00</span><span class="odometer-unit">h</span>
              <span class="odometer-digit" data-odometer-m>00</span><span class="odometer-unit">m</span>
              <span class="odometer-digit" data-odometer-s>00</span><span class="odometer-ms" data-odometer-ms>.000</span><span class="odometer-unit">s</span>
            </div>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">UPTIME</span></div>
        </div>

        <div class="header__gauge" data-gauge="visitor">
          <div class="header__gauge-viz gauge-viz--visitor" aria-hidden="true">
            <svg width="36" height="28" viewBox="0 0 36 28" id="visitor-geo-svg">
              <g id="visitor-geo-outline"></g>
              <line id="visitor-radar-sweep" x1="18" y1="14" x2="18" y2="1" stroke="var(--accent-primary)" stroke-width="0.75" opacity="0" transform-origin="18 14" />
              <circle id="visitor-pin" cx="18" cy="14" r="2" fill="var(--accent-primary)" opacity="0" />
            </svg>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">VISITOR</span><span class="header__gauge-value" id="gauge-visitor">Welcome</span></div>
        </div>

        <div class="header__gauge" data-gauge="codebase">
          <div class="header__gauge-viz" aria-hidden="true"><canvas class="gauge-viz gauge-viz--site" width="32" height="32" id="site-cube-canvas"></canvas></div>
          <div class="header__gauge-text"><span class="header__gauge-label">CODEBASE</span><span class="header__gauge-value">{codebaseValue}</span></div>
        </div>

        <div class="header__gauge" data-gauge="signals" data-feed-status={JSON.stringify(signalStatus)}>
          <div class="header__gauge-viz gauge-viz--signals" aria-hidden="true">
            <span class="signal-name" id="signal-current-name">STRAVA</span>
            <span class="signal-status signal-status--synced" id="signal-current-status">● SYNCED</span>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">SIGNALS</span></div>
        </div>

        <div class="header__gauge" data-gauge="footprint">
          <div class="header__gauge-viz gauge-viz--footprint" aria-hidden="true">
            <svg width="32" height="20" viewBox="0 0 32 20">
              <rect id="footprint-block" x="2" y="2" width="28" height="16" rx="1" fill="var(--accent-primary)" opacity="0.15" stroke="var(--accent-primary)" stroke-width="0.5"/>
              <rect id="footprint-compressed" x="2" y="2" width="3" height="16" rx="1" fill="var(--accent-primary)" opacity="0"/>
            </svg>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">FOOTPRINT</span><span class="header__gauge-value">{footprintValue}</span></div>
        </div>

        <div class="header__gauge" data-gauge="activity" data-commits={String(commitStats.weeklyCommits || 0)}>
          <div class="header__gauge-viz gauge-viz--activity" aria-hidden="true">
            <span class="activity-prompt">›</span>
            <span class="activity-text" id="activity-typed"></span>
            <span class="activity-cursor">_</span>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">ACTIVITY</span></div>
        </div>
      </div>

      <div class="header__clock"><AnalogClock /></div>
      <div class="header__utilities">
        <ThemeToggle />
        <button class="cmd-trigger" type="button" aria-label="Open command palette"><span>⌘K</span></button>
        <button class="menu-trigger" type="button" aria-label="Open menu" aria-expanded="false" data-menu-toggle><span></span><span></span><span></span></button>
      </div>
    </div>
  </div>

  <div class="mobile-overlay" data-mobile-menu hidden>
    <nav aria-label="Mobile Primary" class="mobile-nav">
      <ul>{mobileLinks.map((link) => (<li><a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined}>{link.label}</a></li>))}</ul>
    </nav>
    <p class="mobile-kbd-hint">Tip: press <kbd>⌘K</kbd> for command palette</p>
    <p class="mobile-time" data-mobile-time>--:--:--</p>
  </div>
</header>

<script>
  // @ts-nocheck
  import gsap from 'gsap';
  import stateOutlines from '@data/state-outlines.json';
  gsap.fromTo('[data-header]', { y: -12, autoAlpha: 0 }, { y: 0, autoAlpha: 1, duration: 0.35, ease: 'power2.out' });

  const header = document.querySelector('[data-header]');
  const toggle = document.querySelector('[data-menu-toggle]');
  const menu = document.querySelector('[data-mobile-menu]');
  const timeEl = document.querySelector('[data-mobile-time]');
  const gaugeSlot = document.getElementById('gauge-slot');

  if (toggle instanceof HTMLButtonElement && menu instanceof HTMLElement) {
    const closeMenu = () => {
      menu.hidden = true;
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    };
    toggle.addEventListener('click', () => {
      const open = toggle.getAttribute('aria-expanded') === 'true';
      if (open) return closeMenu();
      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      document.body.classList.add('menu-open');
    });
    menu.querySelectorAll('a').forEach((link) => link.addEventListener('click', closeMenu));
  }

  if (timeEl instanceof HTMLElement) {
    const updateTime = () => { timeEl.textContent = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(new Date()); };
    updateTime();
    setInterval(updateTime, 1000);
  }

  if (header instanceof HTMLElement) {
    const updateScrolled = () => header.classList.toggle('scrolled', window.scrollY > 8);
    updateScrolled();
    window.addEventListener('scroll', updateScrolled, { passive: true });
  }

  const gaugeNames = ['updated', 'uptime', 'visitor', 'codebase', 'signals', 'footprint', 'activity'];
  let currentGaugeIndex = 0;
  let gaugeRotationPaused = false;
  let rotationTimer = null;
  let odometerRAF = null;
  let signalsTimer = null;

  const showGauge = (index) => {
    document.querySelectorAll('.header__gauge').forEach((g, i) => g.classList.toggle('active', i === index));
    currentGaugeIndex = index;
  };

  const startRotation = () => {
    if (rotationTimer) clearInterval(rotationTimer);
    rotationTimer = window.setInterval(() => {
      if (gaugeRotationPaused) return;
      showGauge((currentGaugeIndex + 1) % gaugeNames.length);
    }, 5500);
  };

  if (gaugeSlot) {
    gaugeSlot.addEventListener('mouseenter', () => {
      gaugeRotationPaused = true;
    });
    gaugeSlot.addEventListener('mouseleave', () => {
      gaugeRotationPaused = false;
      startRotation();
    });
  }

  const setText = (selector, value) => {
    const el = document.querySelector(selector);
    if (el && el.textContent !== String(value)) el.textContent = String(value);
  };

  const updateUpdatedGauge = () => {
    const el = document.getElementById('gauge-updated');
    const deploy = document.querySelector('[data-gauge="updated"]');
    if (!el || !(deploy instanceof HTMLElement)) return;
    const ts = deploy.dataset.deployTs;
    if (!ts) return;
    const diffSec = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
    if (diffSec < 60) el.textContent = 'just now';
    else if (diffSec < 3600) el.textContent = `${Math.floor(diffSec / 60)}m ago`;
    else if (diffSec < 86400) el.textContent = `${Math.floor(diffSec / 3600)}h ago`;
    else if (diffSec < 604800) el.textContent = `${Math.floor(diffSec / 86400)}d ago`;
    else el.textContent = new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  const updateOdometer = () => {
    const gauge = document.querySelector('[data-gauge="uptime"]');
    if (!(gauge instanceof HTMLElement)) return;
    const launchEpoch = new Date(gauge.dataset.launchEpoch || '');
    const elapsed = Date.now() - launchEpoch.getTime();
    if (Number.isNaN(elapsed) || elapsed < 0) return;
    const years = Math.floor(elapsed / (365.25 * 24 * 60 * 60 * 1000));
    const days = Math.floor((elapsed % (365.25 * 24 * 60 * 60 * 1000)) / (24 * 60 * 60 * 1000));
    const hours = Math.floor((elapsed % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
    const minutes = Math.floor((elapsed % (60 * 60 * 1000)) / (60 * 1000));
    const seconds = Math.floor((elapsed % (60 * 1000)) / 1000);
    const ms = Math.floor(elapsed % 1000);

    setText('[data-odometer-yr]', years);
    setText('[data-odometer-d]', String(days).padStart(3, '0'));
    setText('[data-odometer-h]', String(hours).padStart(2, '0'));
    setText('[data-odometer-m]', String(minutes).padStart(2, '0'));
    setText('[data-odometer-s]', String(seconds).padStart(2, '0'));
    setText('[data-odometer-ms]', `.${String(ms).padStart(3, '0')}`);
  };

  const startOdometerLoop = () => {
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      updateOdometer();
      return;
    }
    const loop = () => {
      updateOdometer();
      odometerRAF = requestAnimationFrame(loop);
    };
    if (!odometerRAF) loop();
  };

  const stopOdometerLoop = () => {
    if (odometerRAF) cancelAnimationFrame(odometerRAF);
    odometerRAF = null;
  };

  const initVisitorGauge = async () => {
    const valueEl = document.getElementById('gauge-visitor');
    const outlineEl = document.getElementById('visitor-geo-outline');
    const sweepEl = document.getElementById('visitor-radar-sweep');
    const pinEl = document.getElementById('visitor-pin');

    const runSweep = () => {
      if (!sweepEl) return;
      sweepEl.setAttribute('opacity', '0.5');
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      sweepEl.animate([{ transform: 'rotate(0deg)', opacity: 0.5 }, { transform: 'rotate(360deg)', opacity: 0 }], { duration: 1500, easing: 'ease-out', fill: 'forwards' });
    };

    const showPin = (x = 18, y = 14) => {
      if (!pinEl) return;
      pinEl.setAttribute('cx', String(Math.max(2, Math.min(34, x))));
      pinEl.setAttribute('cy', String(Math.max(2, Math.min(26, y))));
      pinEl.setAttribute('opacity', '1');
      pinEl.setAttribute('fill', 'var(--accent-primary)');
    };

    try {
      const geo = await fetch('https://ipapi.co/json/').then((r) => r.json());
      const city = geo.city || '';
      const region = geo.region_code || '';
      const country = geo.country_code || '';
      if (valueEl) valueEl.textContent = region ? `${city}, ${region}` : (city || 'Welcome');

      let hasOutline = false;
      if (country === 'US' && region && stateOutlines[region] && outlineEl) {
        const state = stateOutlines[region];
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', state.path);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', 'var(--text-tertiary)');
        path.setAttribute('stroke-width', '0.75');
        path.setAttribute('opacity', '0.5');
        outlineEl.innerHTML = '';
        outlineEl.appendChild(path);
        hasOutline = true;
      }

      runSweep();
      const delay = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 1600;
      setTimeout(() => {
        if (hasOutline && country === 'US' && region && stateOutlines[region]?.bounds && geo.latitude && geo.longitude) {
          const bounds = stateOutlines[region].bounds;
          const x = ((geo.longitude - bounds.minLng) / (bounds.maxLng - bounds.minLng)) * 36;
          const y = ((bounds.maxLat - geo.latitude) / (bounds.maxLat - bounds.minLat)) * 28;
          showPin(x, y);
        } else {
          showPin(18, 14);
        }
      }, delay);
    } catch (err) {
      console.warn('Visitor gauge geo failed:', err);
      if (valueEl) valueEl.textContent = 'Welcome';
      runSweep();
      showPin(18, 14);
    }
  };

  const initSignalsGauge = () => {
    const gaugeEl = document.querySelector('[data-gauge="signals"]');
    if (!(gaugeEl instanceof HTMLElement)) return;

    const feedStatus = JSON.parse(gaugeEl.dataset.feedStatus || '{}');
    const feeds = Object.entries(feedStatus).map(([name, status]) => ({
      name: name.toUpperCase().replace('LASTFM', 'LAST.FM'),
      status
    }));

    if (!feeds.length) return;
    const nameEl = document.getElementById('signal-current-name');
    const statusEl = document.getElementById('signal-current-status');
    if (!nameEl || !statusEl) return;

    let currentIndex = 0;
    const showFeed = (index) => {
      const feed = feeds[index];
      const isSynced = feed.status === 'synced';
      nameEl.style.opacity = '0';
      statusEl.style.opacity = '0';
      setTimeout(() => {
        nameEl.textContent = feed.name;
        statusEl.textContent = isSynced ? '● SYNCED' : '○ AWAITING';
        statusEl.className = `signal-status signal-status--${isSynced ? 'synced' : 'awaiting'}`;
        nameEl.style.opacity = '1';
        statusEl.style.opacity = '1';
        if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          nameEl.classList.remove('signal-entering');
          statusEl.classList.remove('signal-entering');
          void nameEl.offsetWidth;
          nameEl.classList.add('signal-entering');
          statusEl.classList.add('signal-entering');
        }
      }, 300);
    };

    showFeed(0);
    if (signalsTimer) clearInterval(signalsTimer);
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      signalsTimer = window.setInterval(() => {
        currentIndex = (currentIndex + 1) % feeds.length;
        showFeed(currentIndex);
      }, 2500);
    }
  };

  const initFootprintViz = () => {
    const block = document.getElementById('footprint-block');
    const compressed = document.getElementById('footprint-compressed');
    if (!block || !compressed) return;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      block.setAttribute('width', '3');
      compressed.setAttribute('opacity', '0.6');
      return;
    }
    block.animate([{ width: 28, opacity: 0.15 }, { width: 3, opacity: 0.08 }], { duration: 1000, easing: 'ease-in-out', fill: 'forwards', delay: 500 });
    setTimeout(() => compressed.setAttribute('opacity', '0.6'), 1500);
  };

  const initActivityViz = () => {
    const gaugeEl = document.querySelector('[data-gauge="activity"]');
    const textEl = document.getElementById('activity-typed');
    const vizEl = gaugeEl?.querySelector('.gauge-viz--activity');
    if (!(gaugeEl instanceof HTMLElement) || !(textEl instanceof HTMLElement) || !(vizEl instanceof HTMLElement)) return;

    const commitCount = parseInt(gaugeEl.dataset.commits || '0', 10);
    const message = commitCount > 0 ? `${commitCount} commit${commitCount !== 1 ? 's' : ''} this week` : 'quiet this week';
    textEl.textContent = '';
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      textEl.textContent = message;
      return;
    }

    let charIndex = 0;
    const typeChar = () => {
      if (charIndex <= message.length) {
        vizEl.classList.add('typing');
        textEl.textContent = message.substring(0, charIndex);
        charIndex += 1;
        const delay = charIndex === 1 ? 200 : (message[charIndex - 1] === ' ' ? 40 : 60 + Math.random() * 40);
        setTimeout(typeChar, delay);
      } else {
        vizEl.classList.remove('typing');
      }
    };

    setTimeout(typeChar, 500);
  };

  const initSiteCubeViz = () => {
    const canvas = document.getElementById('site-cube-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    let raf = null;
    let angle = 0;
    const draw = () => {
      ctx.clearRect(0, 0, 32, 32);
      ctx.strokeStyle = 'rgba(140,150,170,.5)';
      ctx.strokeRect(8 + Math.sin(angle) * 2, 8, 14, 14);
      ctx.strokeRect(10, 10 + Math.cos(angle) * 2, 14, 14);
      ctx.fillStyle = 'var(--accent-primary)';
      ctx.beginPath(); ctx.arc(16 + Math.sin(angle) * 6, 16 + Math.cos(angle) * 4, 1.5, 0, Math.PI * 2); ctx.fill();
      angle += 0.02;
      raf = requestAnimationFrame(draw);
    };
    const observer = new IntersectionObserver(([entry]) => {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        ctx.clearRect(0, 0, 32, 32);
        ctx.strokeStyle = 'rgba(140,150,170,.5)';
        ctx.strokeRect(8, 8, 14, 14);
        ctx.strokeRect(10, 10, 14, 14);
        return;
      }
      if (entry.isIntersecting) draw();
      else if (raf) cancelAnimationFrame(raf);
    });
    observer.observe(canvas);
  };

  showGauge(0);
  startRotation();
  updateUpdatedGauge();
  updateOdometer();
  initVisitorGauge();
  initSignalsGauge();
  initFootprintViz();
  initActivityViz();
  initSiteCubeViz();
  setInterval(updateUpdatedGauge, 60000);

  const odometerEl = document.querySelector('.gauge-viz--odometer');
  if (odometerEl) {
    const observer = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) startOdometerLoop();
      else stopOdometerLoop();
    });
    observer.observe(odometerEl);
  }
</script>

<style>
  .skip-link { position:absolute; left:-999px; top:0; }
  .skip-link:focus-visible { left:1rem; top:1rem; background:var(--surface-primary); padding:.5rem .75rem; z-index:60; }
  .site-header { position: sticky; top:0; z-index:50; backdrop-filter: blur(8px); background: color-mix(in srgb, var(--surface-primary) 90%, transparent); isolation:isolate; border-bottom:1px solid var(--border); }
  .header-inner { position:relative; z-index:2; display:flex; align-items:center; width:100%; min-height:56px; padding-inline:var(--content-padding); gap:1.5rem; }
  .logotype { flex-shrink:0; font-family:'IBM Plex Mono',monospace; font-weight:700; color:var(--text-primary); text-decoration:none; display:inline-flex; align-items:center; font-size:1.25rem; letter-spacing:.15em; text-transform:uppercase; }
  .desktop-nav{display:none;flex-shrink:0;} .desktop-nav ul{list-style:none;display:flex;gap:1.1rem;padding:0;margin:0;align-items:center;}
  .desktop-nav a, .nav__link{font-family:'IBM Plex Mono',monospace;font-size:.75rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-decoration:none;padding:.35rem 0;border-bottom:2px solid transparent;display:inline-flex;align-items:center;height:100%;}
  .desktop-nav a.active,.desktop-nav a:hover,.nav__link.active,.nav__link:hover{color:var(--text-primary);} .desktop-nav a.active,.nav__link.active{border-bottom-color:var(--accent-primary);}
  .nav__item--dropdown { position: relative; display:flex; align-items:center; }
  .nav__flyout { position:absolute; top:calc(100% + 2px); left:0; display:flex; flex-direction:column; background:var(--surface-primary); border:1px solid var(--border); opacity:0; visibility:hidden; }
  .nav__item--dropdown:hover .nav__flyout,.nav__item--dropdown:focus-within .nav__flyout{opacity:1;visibility:visible;}
  .nav__flyout-link { padding:4px 8px; font-family:'IBM Plex Mono',monospace; font-size:10px; text-transform:uppercase; color:var(--text-secondary); text-decoration:none; }

  .header__instruments {display:flex;align-items:center;gap:12px;margin-left:auto;min-width:0;}
  .header__gauge-slot { position:relative; min-width:360px; height:38px; display:flex; align-items:center; justify-content:flex-end; margin-right:12px; overflow:visible; border:none; background:none; box-shadow:none; padding:0; border-radius:0; }
  .header__gauge { position:absolute; inset:0; display:flex; align-items:center; gap:8px; white-space:nowrap; opacity:0; pointer-events:none; transition:opacity .4s ease; }
  .header__gauge.active { opacity:1; pointer-events:auto; }
  .header__gauge-viz{flex-shrink:0;display:flex;align-items:center;justify-content:center;}
  .header__gauge-text{display:flex;align-items:baseline;gap:6px;}
  .header__gauge-label{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.08em;}
  .header__gauge-value{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:500;color:var(--text-primary);text-transform:none;letter-spacing:.02em;}

  .gauge-viz--odometer{display:flex;align-items:baseline;gap:0;font-family:'IBM Plex Mono',monospace;color:var(--text-primary);font-variant-numeric:tabular-nums;}
  .gauge-viz--odometer .odometer-group{display:flex;align-items:baseline;}
  .gauge-viz--odometer .odometer-digit{font-size:15px;font-weight:700;}
  .gauge-viz--odometer .odometer-unit{font-size:10px;font-weight:400;color:var(--text-tertiary);margin:0 6px 0 1px;}
  .gauge-viz--odometer .odometer-ms{font-size:11px;font-weight:400;color:var(--text-secondary);opacity:.7;min-width:3ch;font-variant-numeric:tabular-nums;}

  .gauge-viz--signals{display:flex;align-items:center;gap:6px;min-width:160px;}
  .signal-name{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;color:var(--text-primary);text-transform:uppercase;letter-spacing:.04em;transition:opacity .4s ease;}
  .signal-status{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:400;letter-spacing:.04em;transition:opacity .4s ease;}
  .signal-status--synced{color:var(--accent-primary);}
  .signal-status--awaiting{color:var(--text-tertiary);opacity:.5;}
  .signal-entering{animation:signalFadeIn .4s ease-out;}
  @keyframes signalFadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}

  .gauge-viz--activity{display:flex;align-items:center;gap:4px;font-family:'IBM Plex Mono',monospace;}
  .activity-prompt{font-size:12px;color:var(--accent-primary);font-weight:700;}
  .activity-text{font-size:12px;font-weight:500;color:var(--text-primary);font-variant-numeric:tabular-nums;}
  .activity-cursor{font-size:13px;font-weight:700;color:var(--accent-primary);animation:cursorBlink 1s step-end infinite;}
  @keyframes cursorBlink{0%,100%{opacity:1;}50%{opacity:0;}}
  .gauge-viz--activity.typing .activity-cursor{animation:none;opacity:1;}

  .header__clock { display:none; }
  .header__utilities { display:flex; align-items:center; gap:8px; }
  .cmd-trigger{display:none;} .menu-trigger{display:inline-flex;flex-direction:column;gap:3px;background:none;border:0;color:inherit;padding:4px;}
  .menu-trigger span{display:block;width:16px;height:1px;background:currentColor;}
  .mobile-overlay{display:none;}

  @media (min-width: 880px){ .desktop-nav{display:block;} .header__clock{display:block;} .menu-trigger{display:none;} .cmd-trigger{display:inline-flex;background:none;border:1px solid var(--border);padding:2px 6px;color:var(--text-secondary);} }
  @media (max-width: 879px){ .header__gauge-slot{display:none;} }

  @media (prefers-reduced-motion: reduce) {
    .gauge-viz canvas, .gauge-viz svg animate, .gauge-viz svg [style*='animation'], .signal-entering, .activity-cursor { animation: none !important; transition: none !important; }
    #visitor-pin { opacity: 1; }
    #footprint-block { width: 3; }
  }
</style>
