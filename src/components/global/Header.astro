---
import ThemeToggle from '@components/global/ThemeToggle.astro';

const pathname = Astro.url.pathname;
const links = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { href: '/work', label: 'Work' },
  { href: '/writing', label: 'Writing' },
  { href: '/now', label: 'Now' }
];

const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  return pathname === href || pathname.startsWith(`${href}/`);
};
---

<a href="#content" class="skip-link">Skip to content</a>
<header class="site-header" data-header>
  <div class="header-inner container-shell max-wide">
    <a href="/" class="monogram" aria-label="Ashton Hawkins home" style="view-transition-name: logo-ah;">
      <span>AH</span>
      <span class="terminal-cursor" aria-hidden="true">_</span>
    </a>

    <nav aria-label="Primary" class="desktop-nav">
      <ul>
        {links.map((link) => (
          <li>
            <a
              href={link.href}
              aria-current={isActive(link.href) ? 'page' : undefined}
              class={isActive(link.href) ? 'active' : undefined}
              style={`view-transition-name: nav-${link.label.toLowerCase()};`}
            >
              {link.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <div class="utility-row">
      <ThemeToggle />
      <button class="cmd-trigger" type="button" aria-label="Open command palette">
        <span>Command</span>
        <kbd>⌘K</kbd>
      </button>
      <button class="menu-trigger" type="button" aria-label="Open menu" aria-expanded="false" data-menu-toggle>
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <div class="mobile-overlay" data-mobile-menu hidden>
    <nav aria-label="Mobile Primary" class="mobile-nav">
      <ul>
        {links.map((link) => (
          <li>
            <a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined}>
              {link.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>
    <p class="mobile-kbd-hint">Tip: press <kbd>⌘K</kbd> for command palette</p>
    <p class="mobile-time" data-mobile-time>--:--:--</p>
  </div>
</header>

<script>
  import gsap from 'gsap';

  gsap.fromTo(
    '[data-header]',
    { y: -16, autoAlpha: 0 },
    { y: 0, autoAlpha: 1, duration: 0.3, ease: 'power2.out' }
  );

  const toggle = document.querySelector('[data-menu-toggle]');
  const menu = document.querySelector('[data-mobile-menu]');
  const timeEl = document.querySelector('[data-mobile-time]');

  if (toggle instanceof HTMLButtonElement && menu instanceof HTMLElement) {
    const closeMenu = () => {
      menu.hidden = true;
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    };

    toggle.addEventListener('click', () => {
      const open = toggle.getAttribute('aria-expanded') === 'true';
      if (open) {
        closeMenu();
        return;
      }

      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      document.body.classList.add('menu-open');
    });

    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', closeMenu);
    });
  }

  if (timeEl instanceof HTMLElement) {
    const updateTime = () => {
      timeEl.textContent = new Intl.DateTimeFormat(undefined, {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(new Date());
    };

    updateTime();
    setInterval(updateTime, 1000);
  }
</script>

<style>
  .skip-link { position:absolute; left:-999px; top:0; }
  .skip-link:focus-visible { left:1rem; top:1rem; background:var(--bg-card); padding:.5rem .75rem; z-index:60; }
  .site-header { position:fixed; inset:0 0 auto 0; z-index:50; backdrop-filter:blur(10px); background:color-mix(in srgb, var(--bg-primary) 78%, transparent); border-bottom:1px solid color-mix(in srgb,var(--border) 75%, transparent); }
  .header-inner { height:4rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; }
  .monogram { font-family:'JetBrains Mono Variable','JetBrains Mono',monospace; font-weight:600; color:var(--text-primary); text-decoration:none; display:flex; align-items:center; gap:.1rem; }
  .monogram:hover { text-shadow:0 0 .55rem var(--accent-glow); }
  .terminal-cursor { opacity:.75; animation:blink 1s steps(2,end) infinite; }
  html[data-theme='light'] .terminal-cursor { display:none; }
  .desktop-nav { display:none; }
  .desktop-nav ul { list-style:none; display:flex; gap:1.25rem; padding:0; margin:0; }
  .desktop-nav a { color:var(--text-secondary); text-decoration:none; padding:.25rem 0; border-bottom:2px solid transparent; }
  .desktop-nav a.active { color:var(--text-primary); border-bottom-color:var(--accent-primary); }
  .utility-row { display:flex; align-items:center; gap:.5rem; }
  .cmd-trigger,.menu-trigger { border:1px solid var(--border); background:var(--bg-card); color:var(--text-secondary); border-radius:.5rem; padding:.4rem .55rem; }
  .cmd-trigger { display:none; align-items:center; gap:.4rem; font-size:.8rem; }
  kbd { font-size:.72rem; border:1px solid var(--border); border-bottom-width:2px; border-radius:.35rem; padding:.1rem .3rem; }
  .menu-trigger span { display:block; width:1rem; height:2px; margin:2px 0; background:var(--text-primary); }
  .mobile-overlay { position:fixed; inset:4rem 0 0 0; background:var(--bg-primary); padding:2rem 1.5rem 1.25rem; display:flex; flex-direction:column; justify-content:space-between; }
  .mobile-nav ul { list-style:none; margin:0; padding:0; display:grid; gap:1rem; }
  .mobile-nav a { font-size:1.5rem; color:var(--text-primary); text-decoration:none; }
  .mobile-kbd-hint { color:var(--text-secondary); }
  .mobile-time { font-family:'JetBrains Mono Variable','JetBrains Mono',monospace; color:var(--text-tertiary); font-size:.85rem; }

  @media (width >= 52rem) {
    .desktop-nav, .cmd-trigger { display:flex; }
    .menu-trigger, .mobile-overlay { display:none; }
  }

  @keyframes blink { 0%,49%{opacity:1;} 50%,100%{opacity:0;} }
</style>
