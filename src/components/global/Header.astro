---
import ThemeToggle from '@components/global/ThemeToggle.astro';
import Cursor from '@components/ui/Cursor.astro';
import NoiseTexture from '@components/ui/NoiseTexture.astro';
import AnalogClock from '@components/ui/AnalogClock.astro';
import siteStats from '@data/site-stats.json';
import buildWeight from '@data/build-weight.json';

const pathname = Astro.url.pathname;
const links = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { href: '/work', label: 'Work' },
  { href: '/ventures', label: 'Ventures' },
  { href: '/travel', label: 'Travel' }
];

const mobileLinks = [
  ...links,
  { href: '/now', label: 'Now' },
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const nowFlyoutLinks = [
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  return pathname === href || pathname.startsWith(`${href}/`);
};

const DEPLOY_DATE = new Date();
const codebaseValue = `${(siteStats.lines / 1000).toFixed(1)}K lines · ${siteStats.components} modules`;
const payloadValue = Number(buildWeight.kb || 0);
---

<a href="#content" class="skip-link">Skip to content</a>
<header class="site-header" data-header>
  <NoiseTexture opacity={0.02} />
  <div class="header__nav-row header-inner container-shell max-wide">
    <a href="/" class="logotype" aria-label="Ashton Hawkins home" style="view-transition-name: logo-ashton-hawkins;">
      <span class="logotype__text">ASHTON HAWKINS</span>
      <Cursor class="logotype__cursor" />
    </a>

    <nav aria-label="Primary" class="desktop-nav">
      <ul>
        {links.map((link) => (
          <li>
            <a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined} class={isActive(link.href) ? 'active' : undefined}>{link.label}</a>
          </li>
        ))}
        <li class="nav__item nav__item--dropdown">
          <a href="/now" class={`nav__link ${isActive('/now') ? 'active' : ''}`.trim()} aria-current={isActive('/now') ? 'page' : undefined}>NOW</a>
          <div class="nav__flyout" aria-label="Now links">
            {nowFlyoutLinks.map((link) => (
              <a href={link.href} class="nav__flyout-link">{link.label}</a>
            ))}
          </div>
        </li>
      </ul>
    </nav>

    <div class="header__instruments">
      <div class="header__gauge-slot" id="gauge-slot" aria-label="Site vitals">
        <div class="header__gauge" data-gauge="updated" data-deploy-ts={DEPLOY_DATE.toISOString()}>
          <div class="header__gauge-viz" aria-hidden="true">
            <svg class="gauge-viz gauge-viz--ping" width="24" height="24" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="2.5" fill="var(--accent-primary)" />
              <circle cx="12" cy="12" r="2.5" fill="none" stroke="var(--accent-primary)" stroke-width="1" opacity="0">
                <animate attributeName="r" values="2.5;11" dur="2s" begin="0s" repeatCount="indefinite" />
                <animate attributeName="opacity" values="0.6;0" dur="2s" begin="0s" repeatCount="indefinite" />
              </circle>
            </svg>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">UPDATED</span><span class="header__gauge-value" id="gauge-updated">just now</span></div>
        </div>

        <div class="header__gauge" data-gauge="codebase">
          <div class="header__gauge-viz" aria-hidden="true"><canvas class="gauge-viz gauge-viz--site" width="32" height="32" id="site-cube-canvas"></canvas></div>
          <div class="header__gauge-text"><span class="header__gauge-label">CODEBASE</span><span class="header__gauge-value">{codebaseValue}</span></div>
        </div>

        <div class="header__gauge" data-gauge="activity" data-commits="3" data-diff-add="added dark mode toggle" data-diff-remove="removed legacy nav">
          <div class="header__gauge-viz gauge-viz--diff" aria-hidden="true">
            <div class="diff-line diff-line--remove"><span class="diff-prefix">-</span><span class="diff-text" id="diff-remove-text"></span></div>
            <div class="diff-line diff-line--add"><span class="diff-prefix">+</span><span class="diff-text" id="diff-add-text"></span></div>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">ACTIVITY</span></div>
        </div>

        <div class="header__gauge" data-gauge="payload" data-weight-kb={String(payloadValue)}>
          <div class="header__gauge-viz gauge-viz--payload" aria-hidden="true">
            <div class="payload-rocket" id="payload-rocket">
              <svg width="12" height="18" viewBox="0 0 12 18">
                <path d="M6,0 C6,0 10,4 10,10 L8,12 L4,12 L2,10 C2,4 6,0 6,0Z" fill="var(--text-secondary)" />
                <path d="M4,12 L5,16 L6,14 L7,16 L8,12Z" fill="var(--accent-primary)" opacity="0.8" class="rocket-flame" />
                <circle cx="6" cy="6" r="1.5" fill="var(--accent-primary)" opacity="0.5" />
              </svg>
            </div>
            <div class="payload-value" id="payload-value"><span class="payload-number">{payloadValue}</span><span class="payload-unit">KB</span></div>
          </div>
          <div class="header__gauge-text"><span class="header__gauge-label">PAYLOAD</span></div>
        </div>
      </div>

      <div class="header__clock"><AnalogClock /></div>
      <div class="header__utilities">
        <ThemeToggle />
        <button class="cmd-trigger" type="button" aria-label="Open command palette"><span>⌘K</span></button>
        <button class="menu-trigger" type="button" aria-label="Open menu" aria-expanded="false" data-menu-toggle><span></span><span></span><span></span></button>
      </div>
    </div>
  </div>

  <div class="mobile-overlay" data-mobile-menu hidden>
    <nav aria-label="Mobile Primary" class="mobile-nav">
      <ul>{mobileLinks.map((link) => (<li><a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined}>{link.label}</a></li>))}</ul>
    </nav>
    <p class="mobile-kbd-hint">Tip: press <kbd>⌘K</kbd> for command palette</p>
    <p class="mobile-time" data-mobile-time>--:--:--</p>
  </div>
</header>

<script>
  // @ts-nocheck
  import gsap from 'gsap';
  gsap.fromTo('[data-header]', { y: -12, autoAlpha: 0 }, { y: 0, autoAlpha: 1, duration: 0.35, ease: 'power2.out' });

  const header = document.querySelector('[data-header]');
  const toggle = document.querySelector('[data-menu-toggle]');
  const menu = document.querySelector('[data-mobile-menu]');
  const timeEl = document.querySelector('[data-mobile-time]');
  const gaugeSlot = document.getElementById('gauge-slot');

  if (toggle instanceof HTMLButtonElement && menu instanceof HTMLElement) {
    const closeMenu = () => {
      menu.hidden = true;
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    };
    toggle.addEventListener('click', () => {
      const open = toggle.getAttribute('aria-expanded') === 'true';
      if (open) return closeMenu();
      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      document.body.classList.add('menu-open');
    });
    menu.querySelectorAll('a').forEach((link) => link.addEventListener('click', closeMenu));
  }

  if (timeEl instanceof HTMLElement) {
    const updateTime = () => { timeEl.textContent = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(new Date()); };
    updateTime();
    setInterval(updateTime, 1000);
  }

  if (header instanceof HTMLElement) {
    const updateScrolled = () => header.classList.toggle('scrolled', window.scrollY > 8);
    updateScrolled();
    window.addEventListener('scroll', updateScrolled, { passive: true });
  }

  const gaugeNames = ['updated', 'codebase', 'activity', 'payload'];
  let currentGaugeIndex = 0;
  let gaugeRotationPaused = false;
  let rotationTimer = null;

  const showGauge = (index) => {
    document.querySelectorAll('.header__gauge').forEach((g, i) => g.classList.toggle('active', i === index));
    currentGaugeIndex = index;
  };

  const startRotation = () => {
    if (rotationTimer) clearInterval(rotationTimer);
    rotationTimer = window.setInterval(() => {
      if (gaugeRotationPaused) return;
      showGauge((currentGaugeIndex + 1) % gaugeNames.length);
    }, 6000);
  };

  if (gaugeSlot) {
    gaugeSlot.addEventListener('mouseenter', () => {
      gaugeRotationPaused = true;
    });
    gaugeSlot.addEventListener('mouseleave', () => {
      gaugeRotationPaused = false;
      startRotation();
    });
  }

  const updateUpdatedGauge = () => {
    const el = document.getElementById('gauge-updated');
    const deploy = document.querySelector('[data-gauge="updated"]');
    if (!el || !(deploy instanceof HTMLElement)) return;
    const ts = deploy.dataset.deployTs;
    if (!ts) return;
    const diffSec = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
    if (diffSec < 60) el.textContent = 'just now';
    else if (diffSec < 3600) el.textContent = `${Math.floor(diffSec / 60)}m ago`;
    else if (diffSec < 86400) el.textContent = `${Math.floor(diffSec / 3600)}h ago`;
    else if (diffSec < 604800) el.textContent = `${Math.floor(diffSec / 86400)}d ago`;
    else el.textContent = new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  const initDiffGauge = () => {
    const gaugeEl = document.querySelector('[data-gauge="activity"]');
    if (!(gaugeEl instanceof HTMLElement)) return;

    const addText = gaugeEl.dataset.diffAdd || 'new feature';
    const removeText = gaugeEl.dataset.diffRemove || 'old code';
    const removeTextEl = document.getElementById('diff-remove-text');
    const addTextEl = document.getElementById('diff-add-text');
    if (!removeTextEl || !addTextEl) return;

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      removeTextEl.textContent = removeText;
      addTextEl.textContent = addText;
      return;
    }

    const typeText = (el, text, delay) => new Promise((resolve) => {
      let i = 0;
      const type = () => {
        if (i <= text.length) {
          el.textContent = text.substring(0, i);
          i += 1;
          setTimeout(type, 35 + Math.random() * 25);
        } else {
          resolve(undefined);
        }
      };
      setTimeout(type, delay);
    });

    typeText(removeTextEl, removeText, 600).then(() => typeText(addTextEl, addText, 400));
  };

  const initPayloadGauge = () => {
    const gaugeEl = document.querySelector('[data-gauge="payload"]');
    if (!(gaugeEl instanceof HTMLElement)) return;

    const weightKB = gaugeEl.dataset.weightKb || '0';
    const rocketEl = document.getElementById('payload-rocket');
    const valueEl = document.getElementById('payload-value');
    const numberEl = valueEl?.querySelector('.payload-number');
    if (numberEl) numberEl.textContent = Number(weightKB).toLocaleString();

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      if (valueEl) valueEl.classList.add('payload-value--visible');
      return;
    }

    setTimeout(() => {
      if (rocketEl) rocketEl.classList.add('payload-rocket--launched');
      setTimeout(() => {
        if (valueEl) valueEl.classList.add('payload-value--visible');
      }, 500);
    }, 800);
  };

  const initSiteCubeViz = () => {
    const canvas = document.getElementById('site-cube-canvas');
    if (!(canvas instanceof HTMLCanvasElement)) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    let raf = null;
    let angle = 0;
    const draw = () => {
      ctx.clearRect(0, 0, 32, 32);
      ctx.strokeStyle = 'rgba(140,150,170,.5)';
      ctx.strokeRect(8 + Math.sin(angle) * 2, 8, 14, 14);
      ctx.strokeRect(10, 10 + Math.cos(angle) * 2, 14, 14);
      ctx.fillStyle = 'var(--accent-primary)';
      ctx.beginPath(); ctx.arc(16 + Math.sin(angle) * 6, 16 + Math.cos(angle) * 4, 1.5, 0, Math.PI * 2); ctx.fill();
      angle += 0.02;
      raf = requestAnimationFrame(draw);
    };
    const observer = new IntersectionObserver(([entry]) => {
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        ctx.clearRect(0, 0, 32, 32);
        ctx.strokeStyle = 'rgba(140,150,170,.5)';
        ctx.strokeRect(8, 8, 14, 14);
        ctx.strokeRect(10, 10, 14, 14);
        return;
      }
      if (entry.isIntersecting) draw();
      else if (raf) cancelAnimationFrame(raf);
    });
    observer.observe(canvas);
  };

  showGauge(0);
  startRotation();
  updateUpdatedGauge();
  initDiffGauge();
  initPayloadGauge();
  initSiteCubeViz();
  setInterval(updateUpdatedGauge, 60000);
</script>

<style>
  .skip-link { position:absolute; left:-999px; top:0; }
  .skip-link:focus-visible { left:1rem; top:1rem; background:var(--surface-primary); padding:.5rem .75rem; z-index:60; }
  .site-header { position: sticky; top:0; z-index:50; backdrop-filter: blur(8px); background: color-mix(in srgb, var(--surface-primary) 90%, transparent); isolation:isolate; border-bottom:1px solid var(--border); }
  .header-inner { position:relative; z-index:2; display:flex; align-items:center; width:100%; min-height:56px; padding-inline:var(--content-padding); gap:1.5rem; }
  .logotype { flex-shrink:0; font-family:'IBM Plex Mono',monospace; font-weight:700; color:var(--text-primary); text-decoration:none; display:inline-flex; align-items:center; font-size:1.25rem; letter-spacing:.15em; text-transform:uppercase; }
  .desktop-nav{display:none;flex-shrink:0;} .desktop-nav ul{list-style:none;display:flex;gap:1.1rem;padding:0;margin:0;align-items:center;}
  .desktop-nav a, .nav__link{font-family:'IBM Plex Mono',monospace;font-size:.75rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-decoration:none;padding:.35rem 0;border-bottom:2px solid transparent;display:inline-flex;align-items:center;height:100%;}
  .desktop-nav a.active,.desktop-nav a:hover,.nav__link.active,.nav__link:hover{color:var(--text-primary);} .desktop-nav a.active,.nav__link.active{border-bottom-color:var(--accent-primary);}
  .nav__item--dropdown { position: relative; display:flex; align-items:center; }
  .nav__flyout { position:absolute; top:calc(100% + 2px); left:0; display:flex; flex-direction:column; background:var(--surface-primary); border:1px solid var(--border); opacity:0; visibility:hidden; }
  .nav__item--dropdown:hover .nav__flyout,.nav__item--dropdown:focus-within .nav__flyout{opacity:1;visibility:visible;}
  .nav__flyout-link { padding:4px 8px; font-family:'IBM Plex Mono',monospace; font-size:10px; text-transform:uppercase; color:var(--text-secondary); text-decoration:none; }

  .header__instruments {display:flex;align-items:center;gap:12px;margin-left:auto;min-width:0;}
  .header__gauge-slot { position:relative; min-width:360px; height:38px; display:flex; align-items:center; justify-content:flex-end; margin-right:12px; overflow:visible; border:none; background:none; box-shadow:none; padding:0; border-radius:0; }
  .header__gauge { position:absolute; inset:0; display:flex; align-items:center; gap:8px; white-space:nowrap; opacity:0; pointer-events:none; transition:opacity .4s ease; }
  .header__gauge.active { opacity:1; pointer-events:auto; }
  .header__gauge-viz{flex-shrink:0;display:flex;align-items:center;justify-content:center;}
  .header__gauge-text{display:flex;align-items:baseline;gap:6px;}
  .header__gauge-label{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.08em;}
  .header__gauge-value{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:500;color:var(--text-primary);text-transform:none;letter-spacing:.02em;}

  .gauge-viz--diff{display:flex;flex-direction:column;gap:1px;font-family:'IBM Plex Mono',monospace;font-size:10px;line-height:1.3;}
  .diff-line{display:flex;align-items:center;gap:4px;white-space:nowrap;overflow:hidden;}
  .diff-prefix{font-weight:700;flex-shrink:0;width:10px;text-align:center;}
  .diff-line--add .diff-prefix,.diff-line--add .diff-text{color:#4ade80;}
  .diff-line--remove .diff-prefix,.diff-line--remove .diff-text{color:#f87171;}
  .diff-line .diff-text{opacity:.7;}
  :root[data-theme="light"] .diff-line--add .diff-prefix,:root[data-theme="light"] .diff-line--add .diff-text{color:#16a34a;}
  :root[data-theme="light"] .diff-line--remove .diff-prefix,:root[data-theme="light"] .diff-line--remove .diff-text{color:#dc2626;}

  .gauge-viz--payload{display:flex;align-items:center;gap:8px;position:relative;min-height:24px;}
  .payload-rocket{position:relative;transition:transform .6s cubic-bezier(.36,.07,.19,.97),opacity .4s ease;}
  .payload-rocket--launched{transform:translateY(-30px);opacity:0;}
  .rocket-flame{animation:flameFlicker .15s ease-in-out infinite alternate;}
  @keyframes flameFlicker{from{opacity:.6;transform:scaleY(.9);}to{opacity:1;transform:scaleY(1.1);}}
  .payload-value{display:flex;align-items:baseline;gap:4px;opacity:0;transform:translateY(4px);transition:opacity .5s ease,transform .5s ease;}
  .payload-value--visible{opacity:1;transform:translateY(0);}
  .payload-number{font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:700;color:var(--text-primary);font-variant-numeric:tabular-nums;}
  .payload-unit{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:400;color:var(--text-tertiary);text-transform:uppercase;}

  .header__clock { display:none; }
  .header__utilities { display:flex; align-items:center; gap:8px; }
  .cmd-trigger{display:none;} .menu-trigger{display:inline-flex;flex-direction:column;gap:3px;background:none;border:0;color:inherit;padding:4px;}
  .menu-trigger span{display:block;width:16px;height:1px;background:currentColor;}
  .mobile-overlay{display:none;}

  @media (min-width: 880px){ .desktop-nav{display:block;} .header__clock{display:block;} .menu-trigger{display:none;} .cmd-trigger{display:inline-flex;background:none;border:1px solid var(--border);padding:2px 6px;color:var(--text-secondary);} }
  @media (max-width: 879px){ .header__gauge-slot{display:none;} }

  @media (prefers-reduced-motion: reduce) {
    .gauge-viz canvas, .gauge-viz svg animate, .gauge-viz svg [style*='animation'] { animation: none !important; transition: none !important; }
    .payload-rocket { display:none; }
    .payload-value { opacity:1; transform:none; }
    .rocket-flame { animation:none; }
  }
</style>
