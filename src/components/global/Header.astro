---
import ThemeToggle from '@components/global/ThemeToggle.astro';
import Cursor from '@components/ui/Cursor.astro';
import NoiseTexture from '@components/ui/NoiseTexture.astro';
import AnalogClock from '@components/ui/AnalogClock.astro';
import feedCache from '@data/feeds-cache.json';
import ouraReadiness from '@data/oura/readiness.json';
import stravaActivities from '@data/strava/activities.json';
import { existsSync, readdirSync, readFileSync } from 'node:fs';
import path from 'node:path';

const pathname = Astro.url.pathname;
const links = [
  { href: '/', label: 'Home' },
  { href: '/about', label: 'About' },
  { href: '/work', label: 'Work' },
  { href: '/ventures', label: 'Ventures' },
  { href: '/travel', label: 'Travel' }
];

const mobileLinks = [
  ...links,
  { href: '/now', label: 'Now' },
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const nowFlyoutLinks = [
  { href: '/writing', label: 'Writing' },
  { href: '/photos', label: 'Photos' },
  { href: '/quotes', label: 'Quotes' }
];

const DEPLOY_TIMESTAMP = '2026.02.23 ¬∑ 18:53 UTC';
const DEPLOY_DATE = new Date('2026-02-23T18:53:37.418Z');

const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  return pathname === href || pathname.startsWith(`${href}/`);
};

const formatNumber = (value: number) => new Intl.NumberFormat('en-US').format(value);
const compactLines = (value: number) => (value >= 1000 ? `${(value / 1000).toFixed(1)}K` : formatNumber(value));

const collectStats = (dir: string): { files: number; lines: number } => {
  const stack = [dir];
  let files = 0;
  let lines = 0;
  const exts = new Set(['.astro', '.ts', '.tsx', '.css', '.js']);

  while (stack.length > 0) {
    const current = stack.pop();
    if (!current) continue;
    for (const entry of readdirSync(current, { withFileTypes: true })) {
      if (entry.name.startsWith('.')) continue;
      const fullPath = path.join(current, entry.name);
      if (entry.isDirectory()) {
        if (entry.name === 'dist' || entry.name === 'node_modules') continue;
        stack.push(fullPath);
        continue;
      }
      if (!exts.has(path.extname(entry.name))) continue;
      files += 1;
      const content = readFileSync(fullPath, 'utf8');
      lines += content.split('\n').length;
    }
  }

  return { files, lines };
};

const srcRoot = path.resolve(process.cwd(), 'src');
const buildStatsRaw = existsSync(srcRoot) ? collectStats(srcRoot) : { files: 14, lines: 2850 };
const buildStatLabel = `${formatNumber(buildStatsRaw.files)} COMP ¬∑ ${compactLines(buildStatsRaw.lines)} LN`;
const buildDensityPct = Math.min(100, Math.round((buildStatsRaw.lines / 15000) * 100));

const gaugeFeeds = [
  { name: 'strava', active: Array.isArray(stravaActivities) && stravaActivities.length > 0 },
  { name: 'lastfm', active: ((feedCache as any)?.items?.lastfm?.length ?? 0) > 0 },
  { name: 'letterboxd', active: ((feedCache as any)?.items?.letterboxd?.length ?? 0) > 0 },
  { name: 'oura', active: Array.isArray(ouraReadiness) && ouraReadiness.length > 0 },
  { name: 'goodreads', active: ((feedCache as any)?.items?.goodreads?.length ?? 0) > 0 },
  { name: 'github', active: ((feedCache as any)?.items?.x?.length ?? 0) > 0 }
];
const activeFeedCount = gaugeFeeds.filter((feed) => feed.active).length;

const approximateWeightKb = Math.round((buildStatsRaw.lines * 44) / 1024);
const weightGaugeValue = Number.isFinite(approximateWeightKb) ? approximateWeightKb : 0;
const weightPct = Math.min(100, Math.round((weightGaugeValue / 1500) * 100));
const weightClass = weightGaugeValue < 500 ? 'lean' : weightGaugeValue < 1000 ? 'moderate' : 'heavy';

const cacheUpdatedAt = (feedCache as any)?.updatedAt ? new Date((feedCache as any).updatedAt) : new Date();
const cacheHoursAgo = Math.max(0, Math.floor((Date.now() - cacheUpdatedAt.getTime()) / (1000 * 60 * 60)));
const cacheState = cacheHoursAgo < 4 ? 'fresh' : cacheHoursAgo <= 12 ? 'aging' : 'stale';
const cacheLabel = `${cacheState.toUpperCase()} ¬∑ ${cacheHoursAgo}H`;

const packageJson = JSON.parse(readFileSync(path.resolve(process.cwd(), 'package.json'), 'utf8'));
const astroVersion = String(packageJson?.dependencies?.astro ?? packageJson?.devDependencies?.astro ?? '5').replace(/^[^\d]*/, '').split('.')[0] || '5';
const tsVersion = String(packageJson?.devDependencies?.typescript ?? packageJson?.dependencies?.typescript ?? '5').replace(/^[^\d]*/, '').split('.')[0] || '5';
const nodeVersion = process.versions.node.split('.')[0] || '20';
---

<a href="#content" class="skip-link">Skip to content</a>
<header class="site-header" data-header>
  <NoiseTexture opacity={0.02} />
  <div class="header__nav-row header-inner container-shell max-wide">
    <a href="/" class="logotype" aria-label="Ashton Hawkins home" style="view-transition-name: logo-ashton-hawkins;">
      <span class="logotype__text">ASHTON HAWKINS</span>
      <Cursor class="logotype__cursor" />
    </a>

    <nav aria-label="Primary" class="desktop-nav">
      <ul>
        {links.map((link) => (
          <li>
            <a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined} class={isActive(link.href) ? 'active' : undefined}>{link.label}</a>
          </li>
        ))}
        <li class="nav__item nav__item--dropdown">
          <a href="/now" class={`nav__link ${isActive('/now') ? 'active' : ''}`.trim()} aria-current={isActive('/now') ? 'page' : undefined}>NOW</a>
          <div class="nav__flyout" aria-label="Now links">
            {nowFlyoutLinks.map((link) => (
              <a href={link.href} class="nav__flyout-link">{link.label}</a>
            ))}
          </div>
        </li>
      </ul>
    </nav>

    <div class="header__instruments">
      <div class="header__gauge-slot" id="gauge-slot" aria-label="Site vitals">
        <div class="header__gauge header__gauge--deploy" data-gauge="deploy" data-deploy-ts={DEPLOY_DATE.toISOString()}>
          <span class="header__gauge-label">DEPLOY</span>
          <span class="gauge-icon gauge-icon--deploy" aria-hidden="true">‚óâ</span>
          <span class="header__gauge-value" id="gauge-deploy">{DEPLOY_TIMESTAMP}</span>
        </div>

        <div class="header__gauge header__gauge--live" data-gauge="live">
          <span class="header__gauge-label">LIVE</span>
          <span class="gauge-icon gauge-icon--live" aria-hidden="true"></span>
          <span class="header__gauge-value header__gauge-value--live" id="gauge-live">0</span>
          <span class="header__gauge-unit">SEC</span>
        </div>

        <div class="header__gauge header__gauge--signal" data-gauge="signal">
          <span class="header__gauge-label">SIGNAL</span>
          <span class="gauge-icon gauge-icon--signal" aria-hidden="true">üìç</span>
          <span class="header__gauge-signal-geo" id="gauge-signal-geo">US</span>
          <span class="header__gauge-value" id="gauge-signal-text">--</span>
        </div>

        <div class="header__gauge header__gauge--weather" data-gauge="weather">
          <span class="header__gauge-label">WEATHER</span>
          <span class="header__gauge-weather-icon" id="gauge-weather-icon" aria-hidden="true">‚òÄ</span>
          <span class="header__gauge-value" id="gauge-weather-temp">--¬∞</span>
          <span class="header__gauge-weather-cond" id="gauge-weather-cond">LOADING</span>
        </div>

        <div class="header__gauge header__gauge--build" data-gauge="build">
          <span class="header__gauge-label">BUILD</span>
          <span class="gauge-icon gauge-icon--build" aria-hidden="true">&lt;/&gt;</span>
          <span class="header__gauge-value" id="gauge-build">{buildStatLabel}</span>
          <span class="header__gauge-bar" id="gauge-build-bar"><span class="header__gauge-bar-fill" style={`--bar-target:${buildDensityPct}%`}></span></span>
        </div>

        <div class="header__gauge header__gauge--feeds" data-gauge="feeds">
          <span class="header__gauge-label">FEEDS</span>
          <span class="header__gauge-dots" id="gauge-feed-dots">
            {gaugeFeeds.map((feed) => (
              <span class={`header__gauge-dot header__gauge-dot--${feed.active ? 'active' : 'inactive'}`} title={feed.name}></span>
            ))}
          </span>
          <span class="header__gauge-value" id="gauge-feed-count">{activeFeedCount}/{gaugeFeeds.length}</span>
        </div>

        <div class={`header__gauge header__gauge--weight ${weightClass}`} data-gauge="weight">
          <span class="header__gauge-label">WEIGHT</span>
          <span class="header__gauge-value"><span id="gauge-weight-number">{formatNumber(weightGaugeValue)}</span><span class="header__gauge-unit">KB</span></span>
          <span class="header__gauge-meter" id="gauge-weight-meter"><span class="header__gauge-meter-fill" id="gauge-weight-fill" style={`--weight-target:${weightPct}%`}></span></span>
        </div>

        <div class={`header__gauge header__gauge--cache ${cacheState}`} data-gauge="cache" data-cache-updated={cacheUpdatedAt.toISOString()}>
          <span class="header__gauge-label">CACHE</span>
          <span class="header__gauge-cache-indicator" id="gauge-cache-indicator" aria-hidden="true"></span>
          <span class="header__gauge-value" id="gauge-cache-value">{cacheLabel}</span>
        </div>

        <div class="header__gauge header__gauge--commits" data-gauge="commits">
          <span class="header__gauge-label">COMMITS</span>
          <span class="header__gauge-value" id="gauge-commits-count">-- THIS WEEK</span>
          <span class="header__gauge-sparkline" id="gauge-commits-sparkline"></span>
        </div>

        <div class="header__gauge header__gauge--stack" data-gauge="stack">
          <span class="header__gauge-label">STACK</span>
          <span class="header__gauge-pills">
            <span class="header__gauge-pill" id="gauge-stack-astro">ASTRO {astroVersion}</span>
            <span class="header__gauge-pill" id="gauge-stack-node">NODE {nodeVersion}</span>
            <span class="header__gauge-pill" id="gauge-stack-ts">TS {tsVersion}</span>
          </span>
        </div>
      </div>

      <div class="header__clock">
        <AnalogClock />
      </div>

      <div class="header__utilities">
        <ThemeToggle />
        <button class="cmd-trigger" type="button" aria-label="Open command palette"><span>‚åòK</span></button>
        <button class="menu-trigger" type="button" aria-label="Open menu" aria-expanded="false" data-menu-toggle><span></span><span></span><span></span></button>
      </div>
    </div>
  </div>

  <div class="mobile-overlay" data-mobile-menu hidden>
    <nav aria-label="Mobile Primary" class="mobile-nav">
      <ul>
        {mobileLinks.map((link) => (
          <li><a href={link.href} aria-current={isActive(link.href) ? 'page' : undefined}>{link.label}</a></li>
        ))}
      </ul>
    </nav>
    <p class="mobile-kbd-hint">Tip: press <kbd>‚åòK</kbd> for command palette</p>
    <p class="mobile-time" data-mobile-time>--:--:--</p>
  </div>

</header>

<script>
  // @ts-nocheck
  import gsap from 'gsap';
  gsap.fromTo('[data-header]', { y: -12, autoAlpha: 0 }, { y: 0, autoAlpha: 1, duration: 0.35, ease: 'power2.out' });

  const header = document.querySelector('[data-header]');
  const toggle = document.querySelector('[data-menu-toggle]');
  const menu = document.querySelector('[data-mobile-menu]');
  const timeEl = document.querySelector('[data-mobile-time]');

  const updateScrolled = () => {
    if (!(header instanceof HTMLElement)) return;
    header.classList.toggle('scrolled', window.scrollY > 8);
  };

  updateScrolled();
  window.addEventListener('scroll', updateScrolled, { passive: true });

  if (toggle instanceof HTMLButtonElement && menu instanceof HTMLElement) {
    const closeMenu = () => {
      menu.hidden = true;
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('menu-open');
    };

    toggle.addEventListener('click', () => {
      const open = toggle.getAttribute('aria-expanded') === 'true';
      if (open) return closeMenu();
      menu.hidden = false;
      toggle.setAttribute('aria-expanded', 'true');
      document.body.classList.add('menu-open');
    });

    menu.querySelectorAll('a').forEach((link) => link.addEventListener('click', closeMenu));
  }

  if (timeEl instanceof HTMLElement) {
    const updateTime = () => {
      timeEl.textContent = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' }).format(new Date());
    };
    updateTime();
    setInterval(updateTime, 1000);
  }

  const liveEl = document.getElementById('gauge-live');
  const signalTextEl = document.getElementById('gauge-signal-text');
  const signalGeoEl = document.getElementById('gauge-signal-geo');
  const deployGauge = document.querySelector('[data-gauge="deploy"]');
  const weatherGauge = document.querySelector('[data-gauge="weather"]');
  const weatherIconEl = document.getElementById('gauge-weather-icon');
  const weatherTempEl = document.getElementById('gauge-weather-temp');
  const weatherCondEl = document.getElementById('gauge-weather-cond');
  const commitsCountEl = document.getElementById('gauge-commits-count');
  const commitsSparklineEl = document.getElementById('gauge-commits-sparkline');
  const cacheGauge = document.querySelector('[data-gauge="cache"]');
  const cacheValueEl = document.getElementById('gauge-cache-value');
  const gaugeSlot = document.getElementById('gauge-slot');
  const LAUNCH_DATE = new Date('2025-02-19T00:00:00Z');
  const GAUGE_ORDER = ['deploy', 'live', 'signal', 'weather', 'build', 'feeds', 'weight', 'cache', 'commits', 'stack'];
  const ROTATION_INTERVAL = 5500;
  let currentGaugeIndex = 0;
  let rotationTimer = null;

  const updateLive = () => {
    if (!liveEl) return;
    const seconds = Math.floor((Date.now() - LAUNCH_DATE.getTime()) / 1000);
    liveEl.textContent = seconds.toLocaleString();
  };

  const detectBrowser = () => {
    const ua = navigator.userAgent;
    if (/Edg\//.test(ua)) return 'EDGE';
    if (/Firefox\//.test(ua)) return 'FIREFOX';
    if (/Chrome\//.test(ua) && !/Edg\//.test(ua)) return 'CHROME';
    if (/Safari\//.test(ua) && !/Chrome\//.test(ua)) return 'SAFARI';
    return 'UNKNOWN';
  };

  const showGauge = (index) => {
    const gauges = document.querySelectorAll('.header__gauge');
    gauges.forEach((g, i) => g.classList.toggle('active', i === index));
    currentGaugeIndex = index;
  };

  const advanceGauge = () => showGauge((currentGaugeIndex + 1) % GAUGE_ORDER.length);
  const startRotation = () => {
    if (rotationTimer) clearInterval(rotationTimer);
    rotationTimer = window.setInterval(advanceGauge, ROTATION_INTERVAL);
  };
  const stopRotation = () => {
    if (!rotationTimer) return;
    clearInterval(rotationTimer);
    rotationTimer = null;
  };

  const renderStateOutline = (abbr) => {
    const states = {
      CA: 'M2,10 L4,2 L8,1 L10,4 L9,8 L11,13 L8,15 L3,14 L1,11 Z',
      NY: 'M2,6 L5,3 L11,4 L13,7 L10,8 L7,11 L3,10 Z',
      TX: 'M3,2 L8,2 L10,5 L14,6 L12,10 L8,12 L6,15 L2,12 L1,7 Z',
      FL: 'M2,3 L9,3 L12,6 L10,8 L11,11 L8,13 L6,10 L4,9 L3,6 Z'
    };
    const d = states[abbr];
    if (!d) return null;
    return `<svg viewBox="0 0 16 16" aria-hidden="true"><path d="${d}"/></svg>`;
  };

  const updateSignalFromGeo = (geo = {}) => {
    if (signalTextEl) {
      const city = String(geo.city || 'UNKNOWN').toUpperCase();
      signalTextEl.textContent = `${city} ¬∑ ${detectBrowser()}`;
    }
    if (signalGeoEl) {
      const country = String(geo.country_code || 'US').toUpperCase();
      const region = String(geo.region_code || '').toUpperCase();
      if (country === 'US') {
        const svg = renderStateOutline(region);
        signalGeoEl.innerHTML = svg || region || 'US';
      } else {
        signalGeoEl.textContent = country;
      }
    }
  };

  const updateCacheAge = () => {
    if (!(cacheGauge instanceof HTMLElement) || !(cacheValueEl instanceof HTMLElement)) return;
    const raw = cacheGauge.dataset.cacheUpdated;
    if (!raw) return;
    const hours = Math.max(0, Math.floor((Date.now() - new Date(raw).getTime()) / (1000 * 60 * 60)));
    const state = hours < 4 ? 'fresh' : hours <= 12 ? 'aging' : 'stale';
    cacheGauge.classList.remove('fresh', 'aging', 'stale');
    cacheGauge.classList.add(state);
    cacheValueEl.textContent = `${state.toUpperCase()} ¬∑ ${hours}H`;
  };

  const WEATHER_CODE_MAP = {
    clear: { icon: '‚òÄ', cond: 'CLEAR', className: 'sunny' },
    cloudy: { icon: '‚òÅ', cond: 'CLOUDY', className: 'cloudy' },
    rainy: { icon: '‚òÇ', cond: 'RAIN', className: 'rainy' },
    snowy: { icon: '‚ùÑ', cond: 'SNOW', className: 'snowy' }
  };

  const classifyWeather = (code) => {
    if (code === 0) return WEATHER_CODE_MAP.clear;
    if ([1, 2, 3, 45, 48].includes(code)) return WEATHER_CODE_MAP.cloudy;
    if ([61, 63, 65, 80, 81, 82, 51, 53, 55].includes(code)) return WEATHER_CODE_MAP.rainy;
    if ([71, 73, 75, 77, 85, 86].includes(code)) return WEATHER_CODE_MAP.snowy;
    return WEATHER_CODE_MAP.cloudy;
  };

  const renderCommits = (days) => {
    if (!(commitsSparklineEl instanceof HTMLElement)) return;
    commitsSparklineEl.innerHTML = '';
    const max = Math.max(...days, 1);
    days.forEach((count, idx) => {
      const col = document.createElement('span');
      col.className = `header__gauge-spark-col ${idx === days.length - 1 ? 'today' : ''}`;
      col.style.setProperty('--spark-height', `${Math.max(1, Math.round((count / max) * 12))}px`);
      commitsSparklineEl.append(col);
    });
  };

  const loadCommits = async () => {
    const cached = sessionStorage.getItem('header-commit-activity');
    if (cached) {
      const parsed = JSON.parse(cached);
      commitsCountEl && (commitsCountEl.textContent = `${parsed.total} THIS WEEK`);
      renderCommits(parsed.days);
      return;
    }
    try {
      const res = await fetch('https://api.github.com/repos/ashtonhawkins/ashtonhawkins.github.io/stats/commit_activity');
      const data = await res.json();
      const lastWeek = Array.isArray(data) ? data.at(-1) : null;
      const days = Array.isArray(lastWeek?.days) ? lastWeek.days : [0, 0, 0, 0, 0, 0, 0];
      const total = days.reduce((sum, n) => sum + n, 0);
      commitsCountEl && (commitsCountEl.textContent = `${total} THIS WEEK`);
      renderCommits(days);
      sessionStorage.setItem('header-commit-activity', JSON.stringify({ days, total }));
    } catch {
      commitsCountEl && (commitsCountEl.textContent = 'N/A THIS WEEK');
      renderCommits([1, 1, 1, 1, 1, 1, 1]);
    }
  };

  const loadGeoAndWeather = async () => {
    const cached = sessionStorage.getItem('header-geo-weather');
    if (cached) {
      const parsed = JSON.parse(cached);
      updateSignalFromGeo(parsed.geo);
      if (weatherTempEl) weatherTempEl.textContent = parsed.temp;
      if (weatherCondEl) weatherCondEl.textContent = parsed.cond;
      if (weatherIconEl) {
        weatherIconEl.textContent = parsed.icon;
        weatherIconEl.className = `header__gauge-weather-icon gauge-icon--${parsed.className}`;
      }
      weatherGauge?.classList.remove('sunny', 'cloudy', 'rainy', 'snowy');
      weatherGauge?.classList.add(parsed.className);
      return;
    }
    try {
      const geoRes = await fetch('https://ipapi.co/json/');
      const geo = await geoRes.json();
      updateSignalFromGeo(geo);
      const units = String(geo.country_code || '').toUpperCase() === 'US' ? 'fahrenheit' : 'celsius';
      const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${geo.latitude}&longitude=${geo.longitude}&current=temperature_2m,weather_code&temperature_unit=${units}`);
      const weather = await wRes.json();
      const tempNum = Math.round(weather?.current?.temperature_2m ?? 0);
      const weatherInfo = classifyWeather(Number(weather?.current?.weather_code));
      const temp = `${tempNum}¬∞${units === 'fahrenheit' ? 'F' : 'C'}`;
      if (weatherTempEl) weatherTempEl.textContent = temp;
      if (weatherCondEl) weatherCondEl.textContent = weatherInfo.cond;
      if (weatherIconEl) {
        weatherIconEl.textContent = weatherInfo.icon;
        weatherIconEl.className = `header__gauge-weather-icon gauge-icon--${weatherInfo.className}`;
      }
      weatherGauge?.classList.remove('sunny', 'cloudy', 'rainy', 'snowy');
      weatherGauge?.classList.add(weatherInfo.className);
      sessionStorage.setItem('header-geo-weather', JSON.stringify({ geo, temp, cond: weatherInfo.cond, icon: weatherInfo.icon, className: weatherInfo.className }));
    } catch {
      updateSignalFromGeo({ city: 'UNKNOWN', country_code: 'US' });
      if (weatherTempEl) weatherTempEl.textContent = '--¬∞';
      if (weatherCondEl) weatherCondEl.textContent = 'OFFLINE';
    }
  };

  const deployTs = deployGauge instanceof HTMLElement ? deployGauge.dataset.deployTs : null;
  if (deployGauge instanceof HTMLElement && deployTs) {
    const deployTime = new Date(deployTs).getTime();
    if (Number.isFinite(deployTime) && (Date.now() - deployTime) <= 60 * 60 * 1000) {
      deployGauge.classList.add('fresh');
    }
  }

  showGauge(0);
  startRotation();
  if (gaugeSlot) {
    gaugeSlot.addEventListener('mouseenter', stopRotation);
    gaugeSlot.addEventListener('mouseleave', startRotation);
  }

  updateLive();
  updateCacheAge();
  loadGeoAndWeather();
  loadCommits();
  setInterval(updateLive, 1000);
  setInterval(updateCacheAge, 60 * 1000);
</script>

<style>
  .skip-link { position:absolute; left:-999px; top:0; }
  .skip-link:focus-visible { left:1rem; top:1rem; background:var(--surface-primary); padding:.5rem .75rem; z-index:60; }
  .site-header { position: sticky; top:0; z-index:50; backdrop-filter: blur(8px); background: color-mix(in srgb, var(--surface-primary) 90%, transparent); isolation:isolate; border-bottom:1px solid var(--border); }
  .site-header.scrolled { border-bottom-color: var(--border); }
  .header-inner { position:relative; z-index:2; display:flex; align-items:center; width:100%; min-height:56px; padding-inline:var(--content-padding); gap:1.5rem; }
  .logotype { flex-shrink:0; font-family:'IBM Plex Mono',monospace; font-weight:700; color:var(--text-primary); text-decoration:none; display:inline-flex; align-items:center; font-size:1.25rem; letter-spacing:.15em; text-transform:uppercase; }
  .logotype__cursor { margin-left:.15rem; }
  .desktop-nav{display:none;flex-shrink:0;} .desktop-nav ul{list-style:none;display:flex;gap:1.1rem;padding:0;margin:0;align-items:center;}
  .desktop-nav a, .nav__link{font-family:'IBM Plex Mono',monospace;font-size:.75rem;font-weight:500;letter-spacing:.08em;text-transform:uppercase;color:var(--text-secondary);text-decoration:none;padding:.35rem 0;border-bottom:2px solid transparent;display:inline-flex;align-items:center;height:100%;}
  .desktop-nav a.active,.desktop-nav a:hover,.nav__link.active,.nav__link:hover{color:var(--text-primary);} .desktop-nav a.active,.nav__link.active{border-bottom-color:var(--accent-primary);} 
  .nav__item--dropdown { position: relative; display:flex; align-items:center; }
  .nav__flyout {
    position: absolute;
    top: calc(100% + 2px);
    left: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    min-width: max-content;
    background: var(--surface-primary);
    border: 1px solid var(--border);
    padding: 2px 0;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-2px);
    transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
    z-index: 100;
  }
  .nav__item--dropdown:hover .nav__flyout,
  .nav__item--dropdown:focus-within .nav__flyout {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }
  .nav__flyout-link {
    display: block;
    padding: 4px 8px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.1s ease, background 0.1s ease;
    white-space: nowrap;
  }
  .nav__flyout-link:hover { color: var(--text-primary); background: rgba(255, 255, 255, 0.03); }
  [data-theme="light"] .nav__flyout-link:hover,
  .light .nav__flyout-link:hover { background: rgba(0, 0, 0, 0.03); }

  .header__instruments {display:flex;align-items:center;gap:12px;margin-left:auto;min-width:0;}
  .header__gauge-slot {
    position: relative;
    min-width: 220px;
    max-width: 320px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    margin-right: 12px;
    overflow: visible;
  }
  .header__gauge {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 4px 12px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.04);
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
  }
  .header__gauge.active {
    opacity: 1;
    pointer-events: auto;
  }
  .header__gauge-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 8px;
    font-weight: 400;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--text-tertiary);
    line-height: 1;
    opacity: 0.6;
  }
  .header__gauge-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.03em;
    color: var(--text-secondary);
    line-height: 1;
    white-space: nowrap;
  }
  .header__gauge-value--live {
    color: var(--accent-primary);
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }
  .header__gauge-unit {
    font-size: 7px;
    color: var(--text-tertiary);
    opacity: 0.5;
    margin-left: 2px;
  }
  .gauge-icon--deploy {
    display:inline-block;
    width:12px;
    height:12px;
    margin-right:4px;
    opacity:.65;
    font-size:11px;
    line-height:1;
  }
  .header__gauge--deploy.active .gauge-icon--deploy { animation: icon-spin 1s ease-out 1; }
  .header__gauge--deploy.fresh.active .gauge-icon--deploy,
  .header__gauge--deploy.fresh.active .header__gauge-value {
    color: #4ade80;
    text-shadow: 0 0 8px rgba(74, 222, 128, 0.45);
    animation: deploy-fresh-glow 0.9s ease-out 1;
  }
  @keyframes icon-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes deploy-fresh-glow { 0% { opacity: .7; } 100% { opacity: 1; } }
  .gauge-icon--live {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #ef4444;
    box-shadow: 0 0 4px rgba(239, 68, 68, 0.6);
    animation: live-pulse 1.5s ease-in-out infinite;
    margin-right: 6px;
    flex-shrink: 0;
  }
  @keyframes live-pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.85); }
  }

  .header__gauge-signal-geo {
    width: 18px;
    height: 14px;
    flex-shrink: 0;
    opacity: 0.6;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 8px;
    color: var(--text-tertiary);
  }
  .header__gauge-signal-geo svg { width: 100%; height: 100%; fill: none; stroke: var(--text-tertiary); stroke-width: 1; }
  .gauge-icon--signal { font-size: 12px; opacity: .75; margin-right: 2px; }
  .header__gauge--signal.active .header__gauge-value {
    animation: signal-type 0.8s steps(20) 1;
    overflow: hidden;
    white-space: nowrap;
  }
  @keyframes signal-type {
    from { max-width: 0; }
    to { max-width: 300px; }
  }

  .header__gauge-weather-icon { font-size: 16px; line-height: 1; display:inline-block; }
  .header__gauge--weather .gauge-icon--sunny { animation: sun-rotate 8s linear infinite; }
  .header__gauge--weather .gauge-icon--cloudy { animation: cloud-drift 4s ease-in-out infinite; }
  .header__gauge--weather .gauge-icon--rainy { animation: rain-bounce 1.8s ease-in-out infinite; }
  .header__gauge--weather .gauge-icon--snowy { animation: cloud-drift 5s ease-in-out infinite; }
  @keyframes sun-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  @keyframes cloud-drift { 0%,100% { transform: translateX(0); } 50% { transform: translateX(3px); } }
  @keyframes rain-bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(1px); } }
  .header__gauge-weather-cond { font-family: 'IBM Plex Mono', monospace; font-size: 8px; letter-spacing: 0.08em; color: var(--text-tertiary); text-transform: uppercase; }
  .header__gauge--weather.sunny .header__gauge-weather-icon { color: #fbbf24; }
  .header__gauge--weather.cloudy .header__gauge-weather-icon { color: #94a3b8; }
  .header__gauge--weather.rainy .header__gauge-weather-icon { color: #60a5fa; }
  .header__gauge--weather.snowy .header__gauge-weather-icon { color: #e2e8f0; }

  .header__gauge-bar { width: 24px; height: 3px; border-radius: 1.5px; background: rgba(255,255,255,.08); overflow: hidden; }
  .gauge-icon--build { font-size: 10px; opacity: .7; }
  .header__gauge-bar-fill { display:block; height:100%; border-radius:1.5px; background:var(--accent-primary); opacity:.5; width:0; }
  .header__gauge--build.active .header__gauge-bar-fill { animation: bar-fill .5s ease-out .2s forwards; }
  @keyframes bar-fill { to { width: var(--bar-target, 65%); } }
  .header__gauge-dots {
    display: flex;
    gap: 3px;
    align-items: center;
  }
  .header__gauge-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .header__gauge-dot--active {
    background: #4ade80;
    box-shadow: 0 0 3px rgba(74, 222, 128, 0.4);
  }
  .header__gauge-dot--active:nth-child(1) { animation: dot-pulse 3s ease-in-out 0s infinite; }
  .header__gauge-dot--active:nth-child(2) { animation: dot-pulse 3s ease-in-out .3s infinite; }
  .header__gauge-dot--active:nth-child(3) { animation: dot-pulse 3s ease-in-out .6s infinite; }
  .header__gauge-dot--active:nth-child(4) { animation: dot-pulse 3s ease-in-out .9s infinite; }
  .header__gauge-dot--active:nth-child(5) { animation: dot-pulse 3s ease-in-out 1.2s infinite; }
  .header__gauge-dot--active:nth-child(6) { animation: dot-pulse 3s ease-in-out 1.5s infinite; }
  .header__gauge-dot--inactive {
    background: rgba(255, 255, 255, 0.15);
  }
  @keyframes dot-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .header__gauge-meter { width: 32px; height:4px; border-radius:2px; background:rgba(255,255,255,.08); overflow:hidden; }
  .header__gauge-meter-fill { display:block; height:100%; border-radius:2px; width:0; }
  .header__gauge--weight.active .header__gauge-meter-fill { animation: weight-fill .5s ease-out forwards; }
  @keyframes weight-fill { to { width: var(--weight-target, 50%); } }
  .header__gauge--weight.lean .header__gauge-meter-fill { background:#4ade80; }
  .header__gauge--weight.moderate .header__gauge-meter-fill { background:#fbbf24; }
  .header__gauge--weight.heavy .header__gauge-meter-fill { background:#f87171; }

  .header__gauge-cache-indicator { width:7px;height:7px;border-radius:50%;display:inline-block;opacity:.2; }
  .header__gauge--cache.fresh .header__gauge-cache-indicator { background:#4ade80; }
  .header__gauge--cache.aging .header__gauge-cache-indicator { background:#fbbf24; }
  .header__gauge--cache.stale .header__gauge-cache-indicator { background:#f87171; }
  .header__gauge--cache.active .header__gauge-cache-indicator { animation: cache-dot-in .35s ease-out 1; opacity:1; }
  @keyframes cache-dot-in { from { transform: scale(.6); opacity:0; } to { transform: scale(1); opacity:1; } }
  .header__gauge--cache.stale .header__gauge-value { opacity:.6; }

  .header__gauge-sparkline { display:flex; align-items:flex-end; gap:1px; height:12px; }
  .header__gauge-spark-col { width:3px; border-radius:1px 1px 0 0; background:var(--accent-primary); opacity:.4; min-height:1px; height:0; }
  .header__gauge--commits.active .header__gauge-spark-col { animation: spark-grow .4s ease-out forwards; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(1) { animation-delay: 0s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(2) { animation-delay: .05s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(3) { animation-delay: .1s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(4) { animation-delay: .15s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(5) { animation-delay: .2s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(6) { animation-delay: .25s; }
  .header__gauge--commits.active .header__gauge-spark-col:nth-child(7) { animation-delay: .3s; }
  @keyframes spark-grow { to { height: var(--spark-height); } }
  .header__gauge-spark-col.today { opacity:.8; }

  .header__gauge-pills { display:flex; gap:3px; align-items:center; }
  .header__gauge-pill {
    font-family:'IBM Plex Mono',monospace;
    font-size:7px;
    letter-spacing:.06em;
    color:var(--text-tertiary);
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.06);
    border-radius:2px;
    padding:1px 4px;
    line-height:1.2;
  }
  .header__gauge-pill:nth-child(1) { background: rgba(99,102,241,.14); }
  .header__gauge-pill:nth-child(2) { background: rgba(20,184,166,.14); }
  .header__gauge-pill:nth-child(3) { background: rgba(244,114,182,.14); }
  .header__gauge--stack.active .header__gauge-pill { animation: stack-pill-in .4s ease-out both; }
  .header__gauge--stack.active .header__gauge-pill:nth-child(2) { animation-delay: .06s; }
  .header__gauge--stack.active .header__gauge-pill:nth-child(3) { animation-delay: .12s; }
  @keyframes stack-pill-in { from { transform: translateX(6px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  .header__clock{display:flex;justify-content:center;align-items:center;}
  .header__utilities{flex-shrink:0;display:flex;align-items:center;gap:.5rem;}
  .cmd-trigger,.menu-trigger{border:1px solid var(--border);background:var(--surface-primary);color:var(--text-secondary);border-radius:999px;padding:.4rem .6rem;}
  .cmd-trigger{display:none;align-items:center;font-family:'IBM Plex Mono',monospace;font-size:.72rem;letter-spacing:.06em;text-transform:uppercase;}
  .menu-trigger{border-radius:.5rem;} .menu-trigger span{display:block;width:1rem;height:2px;margin:2px 0;background:var(--text-secondary);} 
  .mobile-overlay{position:fixed;inset:4.25rem 0 0 0;background:var(--surface-primary);padding:2rem 1.5rem 1.25rem;display:flex;flex-direction:column;justify-content:space-between;border-top:1px solid var(--border);} 
  .mobile-nav ul{list-style:none;margin:0;padding:0;display:grid;gap:1rem;} .mobile-nav a{font-family:'IBM Plex Mono',monospace;font-size:1rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-primary);text-decoration:none;}
  .mobile-kbd-hint{color:var(--text-secondary);} .mobile-time{font-family:'IBM Plex Mono',monospace;color:var(--text-tertiary);font-size:.85rem;}

  [data-theme="light"] .header__gauge,
  .light .header__gauge {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.05);
  }
  [data-theme="light"] .header__gauge-bar,
  [data-theme="light"] .header__gauge-meter,
  .light .header__gauge-bar,
  .light .header__gauge-meter { background: rgba(0,0,0,.08); }
  [data-theme="light"] .header__gauge-dot--inactive,
  .light .header__gauge-dot--inactive {
    background: rgba(0, 0, 0, 0.15);
  }
    [data-theme="light"] .header__gauge-pill,
  .light .header__gauge-pill { background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.06); }

  @media (width >= 52rem) {
    .desktop-nav, .cmd-trigger { display:flex; }
    .menu-trigger, .mobile-overlay { display:none; }
    .logotype { font-size:1.5rem; }
  }
  @media (max-width: 768px) {
    .header__gauge-slot { display:none; }
  }
  @media (prefers-reduced-motion: reduce) {
    .header__gauge { transition: none; }
    .gauge-icon--live,
    .header__gauge-weather-icon,
    .header__gauge--signal.active .header__gauge-value,
    .header__gauge--build.active .header__gauge-bar-fill,
    .header__gauge--weight.active .header__gauge-meter-fill,
    .header__gauge--cache.active .header__gauge-cache-indicator,
    .header__gauge--commits.active .header__gauge-spark-col,
    .header__gauge--stack.active .header__gauge-pill,
    .header__gauge-dot--active,
    .header__gauge--deploy.active .gauge-icon--deploy { animation: none; }
  }
</style>
