---
import feedCache from '@data/feeds-cache.json';
import quotes from '@data/quotes.json';

const deployStamp = '2026.02.20 — 00:40:16 UTC';
const letterboxd = (feedCache as any)?.items?.letterboxd ?? [];
const listening = (feedCache as any)?.items?.lastfm ?? [];
const tickerData = {
  deployStamp,
  quote: quotes[0] ?? null,
  listened: listening[0] ?? null,
  watched: letterboxd[0] ?? null
};
---

<div class="header-ticker" aria-live="polite" data-nav-ticker data-ticker={JSON.stringify(tickerData)}>
  <div class="header-ticker__content" data-ticker-content>Loading signal…</div>
</div>

<style>
  .header-ticker {
    display: flex;
    align-items: center;
    min-width: 0;
    width: 100%;
  }

  .header-ticker__content {
    opacity: 1;
    transition: opacity 0.4s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-tertiary);
  }

  .header-ticker__content.is-fading {
    opacity: 0;
  }

  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    min-width: 0;
  }

  .ticker-item__label,
  .ticker-item__author {
    color: var(--text-tertiary);
  }

  .ticker-item__value,
  .ticker-item__number,
  .ticker-item__content,
  .ticker-item__text {
    color: var(--text-secondary);
  }

  .ticker-item__number {
    color: var(--accent-primary);
    font-variant-numeric: tabular-nums;
  }

  .ticker-item__text {
    font-style: italic;
    text-transform: none;
  }

  .ticker-item__suffix {
    font-size: 9px;
    opacity: 0.85;
  }

  .ticker-item--signal svg {
    flex-shrink: 0;
  }
</style>

<script>
  // @ts-nocheck
  const root = document.querySelector('[data-nav-ticker]');
  const content = document.querySelector('[data-ticker-content]');
  const launchDate = new Date('2025-02-19T00:00:00Z').getTime();
  const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  const browserIcon = (name) => {
    const stroke = 'var(--text-secondary)';
    const icons = {
      CHROME: `<svg width="12" height="12" style="display:inline-block;vertical-align:middle;max-width:12px;max-height:12px;" viewBox="0 0 14 14" aria-hidden="true"><circle cx="7" cy="7" r="6" fill="none" stroke="${stroke}"/><circle cx="7" cy="7" r="2" fill="none" stroke="${stroke}"/><path d="M7 1 L12 4" stroke="${stroke}"/><path d="M2 4 L7 13" stroke="${stroke}"/><path d="M12 4 L7 13" stroke="${stroke}"/></svg>`,
      SAFARI: `<svg width="12" height="12" style="display:inline-block;vertical-align:middle;max-width:12px;max-height:12px;" viewBox="0 0 14 14" aria-hidden="true"><circle cx="7" cy="7" r="6" fill="none" stroke="${stroke}"/><path d="M7 2 L8.5 8.5 L2 7 Z" fill="none" stroke="${stroke}"/></svg>`,
      FIREFOX: `<svg width="12" height="12" style="display:inline-block;vertical-align:middle;max-width:12px;max-height:12px;" viewBox="0 0 14 14" aria-hidden="true"><path d="M7 1.5 C10.2 1.5 12.5 3.9 12.5 7 C12.5 10.2 10 12.5 7 12.5 C4 12.5 1.5 10.2 1.5 7 C1.5 4.5 2.7 2.8 4.8 2.2 C4.2 3.5 4.4 4.8 5.5 5.3 C5.9 3.8 6.7 2.4 8.6 2" fill="none" stroke="${stroke}"/></svg>`,
      EDGE: `<svg width="12" height="12" style="display:inline-block;vertical-align:middle;max-width:12px;max-height:12px;" viewBox="0 0 14 14" aria-hidden="true"><path d="M12 8.2 C11.8 10.9 9.6 12.5 7 12.5 C3.9 12.5 1.5 10.2 1.5 7 C1.5 3.8 3.9 1.5 7 1.5 C9.6 1.5 11.4 2.9 12.2 5.2 C10.8 4.4 8.7 4.2 6.8 4.9 C5 5.5 3.9 6.8 3.9 8.4 C3.9 9.9 5.1 11 6.7 11 C8.2 11 9.4 10.2 9.8 8.9" fill="none" stroke="${stroke}"/></svg>`
    };
    return icons[name] ?? '';
  };

  const miniMapSvg = (x, y) => `<svg width="34" height="16" style="display:inline-block;vertical-align:middle;max-width:34px;max-height:16px;" viewBox="0 0 40 20" aria-hidden="true"><path d="M2 6 L8 5 L10 7 L14 6 L17 8 L20 7 L23 9 L27 8 L31 10 L34 12 L30 14 L24 13 L20 14 L14 12 L10 13 L7 11 L4 10 Z" fill="none" stroke="currentColor" stroke-width="0.7" opacity="0.35"/><circle cx="${x}" cy="${y}" r="1.5" fill="var(--accent-primary)"/></svg>`;

  const detectBrowser = () => {
    const ua = navigator.userAgent;
    if (/Edg\//.test(ua)) return 'EDGE';
    if (/Firefox\//.test(ua)) return 'FIREFOX';
    if (/Chrome\//.test(ua) && !/Edg\//.test(ua)) return 'CHROME';
    if (/Safari\//.test(ua) && !/Chrome\//.test(ua)) return 'SAFARI';
    return 'UNKNOWN';
  };

  if (root instanceof HTMLElement && content instanceof HTMLElement) {
    const payload = JSON.parse(root.dataset.ticker ?? '{}');
    let geoMap = '';

    const secondsLive = () => Math.max(0, Math.floor((Date.now() - launchDate) / 1000)).toLocaleString();

    const items = [
      () => `<span class="ticker-item"><span class="ticker-item__label">Last Site Deployment:</span><span class="ticker-item__value">${payload.deployStamp}</span></span>`,
      () => `<span class="ticker-item"><span class="ticker-item__number">${secondsLive()}</span><span class="ticker-item__suffix">seconds live</span></span>`,
      () => `<span class="ticker-item"><span class="ticker-item__label">♫</span><span class="ticker-item__content">${payload.listened?.artist ?? 'Artist'} — ${payload.listened?.title ?? payload.listened?.name ?? 'Track Title'}</span></span>`,
      () => `<span class="ticker-item"><span class="ticker-item__label">▶</span><span class="ticker-item__content">${payload.watched?.title ?? 'Film Title'}</span></span>`,
      () => `<span class="ticker-item"><span class="ticker-item__text">"${payload.quote?.text ?? 'Simplicity is the ultimate sophistication.'}"</span><span class="ticker-item__author">— ${payload.quote?.author ?? 'Leonardo da Vinci'}</span></span>`,
      () => `<span class="ticker-item ticker-item--signal">Visitor Signal ${browserIcon(detectBrowser())} ${detectBrowser()} ${geoMap}</span>`
    ];

    let index = 0;
    let secondsInterval;

    const renderItem = (nextIndex) => {
      if (reducedMotion) {
        content.innerHTML = items[nextIndex % items.length]();
        return;
      }

      content.classList.add('is-fading');
      setTimeout(() => {
        content.innerHTML = items[nextIndex % items.length]();
        content.classList.remove('is-fading');
      }, 200);
    };

    const showSecondsIfNeeded = () => {
      if ((index - 1 + items.length) % items.length === 1) {
        content.innerHTML = items[1]();
      }
    };

    renderItem(index);
    index += 1;

    setInterval(() => {
      renderItem(index);
      if (index % items.length === 1 && secondsInterval) {
        clearInterval(secondsInterval);
      }
      if (index % items.length === 2) {
        secondsInterval = setInterval(showSecondsIfNeeded, 1000);
      }
      index += 1;
    }, 16000);

    fetch('https://ipapi.co/json/').then((res) => res.json()).then((geo) => {
      const lat = Number(geo?.latitude);
      const lon = Number(geo?.longitude);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      const clampedLat = Math.max(-85, Math.min(85, lat));
      const x = ((lon + 180) / 360) * 40;
      const latRad = (clampedLat * Math.PI) / 180;
      const mercN = Math.log(Math.tan(Math.PI / 4 + latRad / 2));
      const y = 10 - (20 * mercN) / (2 * Math.PI);
      geoMap = miniMapSvg(Math.max(1.5, Math.min(38.5, x)), Math.max(1.5, Math.min(18.5, y)));
    }).catch(() => {});
  }
</script>
