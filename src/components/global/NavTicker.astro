---
import feedCache from '@data/feeds-cache.json';
import quotes from '@data/quotes.json';

const deployStamp = '2026.02.20 — 00:40:16 UTC';
const letterboxd = (feedCache as any)?.items?.letterboxd ?? [];
const listening = (feedCache as any)?.items?.lastfm ?? [];
const tickerData = {
  deployStamp,
  quote: quotes[0] ?? null,
  listened: listening[0] ?? null,
  watched: letterboxd[0] ?? null
};
---

<div class="ticker" aria-live="polite" data-nav-ticker data-ticker={JSON.stringify(tickerData)}>
  <div class="container-shell max-wide ticker__inner">
    <div class="ticker__content" data-ticker-content>Loading signal…</div>
  </div>
</div>

<style>
  .ticker {
    height: 40px;
    background: var(--surface-secondary);
    overflow: hidden;
    display: flex;
    align-items: center;
    padding: 0 var(--content-padding);
    border-bottom: 1px solid var(--border);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .ticker__inner{width:100%;}
  .ticker__content { display:flex; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .ticker-item--pill { border: 1px solid var(--border); border-radius: 9999px; padding: 2px 12px; display: inline-flex; gap: 6px; }
  .ticker-item--pill .ticker-item__label { color: var(--text-tertiary); }
  .ticker-item--pill .ticker-item__value { color: var(--text-primary); font-weight: 500; }

  .ticker-item--counter .ticker-item__number { color: var(--accent-primary); font-weight: 700; font-size: 13px; }
  .ticker-item--counter .ticker-item__suffix { color: var(--text-tertiary); font-size: 9px; margin-left: 6px; }

  .ticker-item--media .ticker-item__icon { color: var(--text-tertiary); margin-right: 6px; }
  .ticker-item--media .ticker-item__content { color: var(--text-primary); }

  .ticker-item--quote .ticker-item__text { font-family: 'IBM Plex Sans', sans-serif; font-style: italic; text-transform: none; color: var(--text-primary); }
  .ticker-item--quote .ticker-item__author { color: var(--text-secondary); margin-left: 6px; font-family: 'IBM Plex Mono', monospace; text-transform: uppercase; font-size: 9px; }
  .ticker-item--signal{display:inline-flex;align-items:center;gap:6px;color:var(--text-secondary)}
</style>

<script>
  // @ts-nocheck
  const root = document.querySelector('[data-nav-ticker]');
  const content = document.querySelector('[data-ticker-content]');
  const launchDate = new Date('2025-02-19T00:00:00Z').getTime();

  const browserIcon = (name) => {
    const stroke = 'var(--text-secondary)';
    const icons = {
      CHROME: `<svg width="14" height="14" style="display:inline-block;vertical-align:middle;max-width:14px;max-height:14px;" viewBox="0 0 14 14" aria-hidden="true"><circle cx="7" cy="7" r="6" fill="none" stroke="${stroke}"/><circle cx="7" cy="7" r="2" fill="none" stroke="${stroke}"/><path d="M7 1 L12 4" stroke="${stroke}"/><path d="M2 4 L7 13" stroke="${stroke}"/><path d="M12 4 L7 13" stroke="${stroke}"/></svg>`,
      SAFARI: `<svg width="14" height="14" style="display:inline-block;vertical-align:middle;max-width:14px;max-height:14px;" viewBox="0 0 14 14" aria-hidden="true"><circle cx="7" cy="7" r="6" fill="none" stroke="${stroke}"/><path d="M7 2 L8.5 8.5 L2 7 Z" fill="none" stroke="${stroke}"/></svg>`,
      FIREFOX: `<svg width="14" height="14" style="display:inline-block;vertical-align:middle;max-width:14px;max-height:14px;" viewBox="0 0 14 14" aria-hidden="true"><path d="M7 1.5 C10.2 1.5 12.5 3.9 12.5 7 C12.5 10.2 10 12.5 7 12.5 C4 12.5 1.5 10.2 1.5 7 C1.5 4.5 2.7 2.8 4.8 2.2 C4.2 3.5 4.4 4.8 5.5 5.3 C5.9 3.8 6.7 2.4 8.6 2" fill="none" stroke="${stroke}"/></svg>`,
      EDGE: `<svg width="14" height="14" style="display:inline-block;vertical-align:middle;max-width:14px;max-height:14px;" viewBox="0 0 14 14" aria-hidden="true"><path d="M12 8.2 C11.8 10.9 9.6 12.5 7 12.5 C3.9 12.5 1.5 10.2 1.5 7 C1.5 3.8 3.9 1.5 7 1.5 C9.6 1.5 11.4 2.9 12.2 5.2 C10.8 4.4 8.7 4.2 6.8 4.9 C5 5.5 3.9 6.8 3.9 8.4 C3.9 9.9 5.1 11 6.7 11 C8.2 11 9.4 10.2 9.8 8.9" fill="none" stroke="${stroke}"/></svg>`
    };
    return icons[name] ?? '';
  };

  const miniMapSvg = (x, y) => `<svg width="40" height="20" style="display:inline-block;vertical-align:middle;max-width:40px;max-height:20px;" viewBox="0 0 40 20" aria-hidden="true"><path d="M2 6 L8 5 L10 7 L14 6 L17 8 L20 7 L23 9 L27 8 L31 10 L34 12 L30 14 L24 13 L20 14 L14 12 L10 13 L7 11 L4 10 Z" fill="none" stroke="currentColor" stroke-width="0.7" opacity="0.35"/><circle cx="${x}" cy="${y}" r="1.5" fill="var(--accent-primary)"/></svg>`;

  const detectBrowser = () => {
    const ua = navigator.userAgent;
    if (/Edg\//.test(ua)) return 'EDGE';
    if (/Firefox\//.test(ua)) return 'FIREFOX';
    if (/Chrome\//.test(ua) && !/Edg\//.test(ua)) return 'CHROME';
    if (/Safari\//.test(ua) && !/Chrome\//.test(ua)) return 'SAFARI';
    return 'UNKNOWN';
  };

  if (root instanceof HTMLElement && content instanceof HTMLElement) {
    const payload = JSON.parse(root.dataset.ticker ?? '{}');
    let geoMap = '';

    const secondsLive = () => Math.max(0, Math.floor((Date.now() - launchDate) / 1000)).toLocaleString();

    const items = [
      () => `<span class="ticker-item ticker-item--pill"><span class="ticker-item__label">Last Site Deployment:</span><span class="ticker-item__value">${payload.deployStamp}</span></span>`,
      () => `<span class="ticker-item ticker-item--counter"><span class="ticker-item__number">${secondsLive()}</span><span class="ticker-item__suffix">seconds live</span></span>`,
      () => `<span class="ticker-item ticker-item--media"><span class="ticker-item__icon">♫</span><span class="ticker-item__content">${payload.listened?.artist ?? 'Artist'} — ${payload.listened?.title ?? payload.listened?.name ?? 'Track Title'}</span></span>`,
      () => `<span class="ticker-item ticker-item--media"><span class="ticker-item__icon">▶</span><span class="ticker-item__content">${payload.watched?.title ?? 'Film Title'}</span></span>`,
      () => `<span class="ticker-item ticker-item--quote"><span class="ticker-item__text">"${payload.quote?.text ?? 'Simplicity is the ultimate sophistication.'}"</span><span class="ticker-item__author">— ${payload.quote?.author ?? 'Leonardo da Vinci'}</span></span>`,
      () => `<span class="ticker-item ticker-item--signal">Visitor Signal ${browserIcon(detectBrowser())} ${detectBrowser()} ${geoMap}</span>`
    ];

    let index = 0;
    const render = () => {
      content.innerHTML = items[index % items.length]();
      index += 1;
    };

    render();
    setInterval(() => {
      if ((index - 1) % items.length === 1) {
        content.innerHTML = items[1]();
        return;
      }
      render();
    }, 9000);
    setInterval(() => {
      if ((index - 1) % items.length === 1) content.innerHTML = items[1]();
    }, 1000);

    fetch('https://ipapi.co/json/').then((res) => res.json()).then((geo) => {
      const lat = Number(geo?.latitude);
      const lon = Number(geo?.longitude);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      const clampedLat = Math.max(-85, Math.min(85, lat));
      const x = ((lon + 180) / 360) * 40;
      const latRad = (clampedLat * Math.PI) / 180;
      const mercN = Math.log(Math.tan(Math.PI / 4 + latRad / 2));
      const y = 10 - (20 * mercN) / (2 * Math.PI);
      geoMap = miniMapSvg(Math.max(1.5, Math.min(38.5, x)), Math.max(1.5, Math.min(18.5, y)));
    }).catch(() => {});
  }
</script>
