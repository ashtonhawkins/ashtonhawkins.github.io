---
import quotes from '../../data/quotes.json';
import dailyColors from '../../data/daily-colors.json';
import dailyWords from '../../data/daily-words.json';

const deployTimestampUtc = new Date().toISOString();

const buildNumber = 1;
const componentCount = 14;
const lineCount = 2850;

const co2PerView = '0.04g';
const pageWeight = '~300 KB';
const cleanerThan = '92%';
---

<div class="ticker" role="marquee" aria-label="Status ticker">
  <div class="ticker__track" id="ticker-track">
    <div class="ticker__item" data-ticker-item data-ticker-deploy>
      <span class="ticker__pill">
        <svg class="ticker-viz" width="16" height="16" viewBox="0 0 20 20" style="margin-right: 8px;">
          <circle cx="10" cy="10" r="8" fill="none" stroke="var(--border)" stroke-width="2"/>
          <circle
            cx="10"
            cy="10"
            r="8"
            fill="none"
            stroke="var(--accent-primary)"
            stroke-width="2"
            stroke-dasharray="50.27 50.27"
            stroke-dashoffset="0.1"
            stroke-linecap="round"
            transform="rotate(-90 10 10)"
            opacity="0.8"
          />
        </svg>
        <span class="t-label">Last Deploy:</span>
        <span class="t-value" data-ticker-deploy-time={deployTimestampUtc}>{deployTimestampUtc.replace('T', ' — ').slice(0, 19)} UTC</span>
        <span class="t-sep">·</span>
        <span class="t-value">99.8% Uptime</span>
      </span>
    </div>

    <div class="ticker__item" data-ticker-item data-ticker-seconds>
      <svg class="ticker-viz" width="12" height="12" viewBox="0 0 12 12" style="margin-right: 8px;">
        <circle cx="6" cy="6" r="3" fill="var(--accent-primary)">
          <animate attributeName="r" values="2;4;2" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="1;0.4;1" dur="2s" repeatCount="indefinite"/>
        </circle>
      </svg>
      <span class="t-accent" id="seconds-live-ticker">31,622,000</span>
      <span class="t-label" style="margin-left: 8px;">seconds live</span>
    </div>

    {quotes.slice(0, 5).map((q: { text: string; author: string }) => (
      <div class="ticker__item ticker__item--quote" data-ticker-item data-is-quote>
        <span class="t-quote">"{q.text}"</span>
        <span class="t-author">— {q.author}</span>
      </div>
    ))}

    <div class="ticker__item" data-ticker-item data-ticker-signal>
      <span class="t-label">Your Signal:</span>
      <span id="ticker-browser-icon" style="margin: 0 6px; display: inline-flex; align-items: center;"></span>
      <span class="t-value" id="ticker-browser-info">detecting…</span>
      <span id="ticker-minimap" style="margin-left: 8px; display: inline-flex; align-items: center;"></span>
      <span class="t-sep">·</span>
      <span class="t-label" id="ticker-visitor-city"></span>
    </div>

    <div class="ticker__item" data-ticker-item data-ticker-carbon>
      <svg class="ticker-viz" width="60" height="14" viewBox="0 0 60 14" style="margin-right: 10px;">
        <polyline
          points="0,10 6,11 12,9 18,10 24,7 30,8 36,5 42,6 48,4 54,3 60,2"
          fill="none"
          stroke="var(--accent-primary)"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          opacity="0.6"
        />
        <polygon
          points="0,14 0,10 6,11 12,9 18,10 24,7 30,8 36,5 42,6 48,4 54,3 60,2 60,14"
          fill="var(--accent-primary)"
          opacity="0.08"
        />
      </svg>
      <span class="t-value">{co2PerView} CO₂</span>
      <span class="t-sep">·</span>
      <span class="t-value">{pageWeight}</span>
      <span class="t-sep">·</span>
      <span class="t-label">Cleaner than {cleanerThan} of sites</span>
    </div>

    <div class="ticker__item" data-ticker-item data-ticker-build>
      <span class="ticker-viz ticker-viz--ascii" style="margin-right: 10px; font-size: 12px; letter-spacing: 1px; color: var(--accent-primary); opacity: 0.45;">
        ▊▎▌▋▊▍▏▊▌▎
      </span>
      <span class="t-label">Build</span>
      <span class="t-value" style="margin-left: 4px;">#{buildNumber}</span>
      <span class="t-sep">·</span>
      <span class="t-value">{componentCount} Components</span>
      <span class="t-sep">·</span>
      <span class="t-value">{lineCount.toLocaleString()} Lines</span>
    </div>

    <div class="ticker__item" data-ticker-item data-ticker-color>
      <svg class="ticker-viz" width="14" height="14" viewBox="0 0 14 14" style="margin-right: 10px;">
        <rect x="1" y="1" width="12" height="12" rx="2" id="color-swatch-rect" fill="var(--text-tertiary)" stroke="var(--border)" stroke-width="0.5"/>
      </svg>
      <span class="t-value" id="color-hex">—</span>
      <span class="t-sep">·</span>
      <span class="t-label" id="color-name">—</span>
    </div>

    <div class="ticker__item" data-ticker-item data-ticker-word>
      <span class="t-label" style="margin-right: 8px;">▸</span>
      <span class="t-value" id="word-of-day" style="letter-spacing: 0.12em;">—</span>
    </div>
  </div>
</div>

<style>
  .ticker {
    height: 40px;
    background: var(--surface-secondary);
    overflow: hidden;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ticker__track {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  .ticker__item {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
    white-space: nowrap;
    gap: 0;
  }

  .ticker__item--active {
    opacity: 1;
    pointer-events: auto;
  }

  .t-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    font-weight: 400;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .t-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .t-accent {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--accent-primary);
    font-variant-numeric: tabular-nums;
  }

  .t-sep {
    font-size: 9px;
    color: var(--text-tertiary);
    margin: 0 8px;
    user-select: none;
  }

  .t-quote {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 12px;
    font-weight: 400;
    font-style: italic;
    color: var(--text-primary);
    text-transform: none;
  }

  .t-author {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    font-weight: 400;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-left: 10px;
  }

  .ticker-viz {
    display: inline-flex;
    align-items: center;
    flex-shrink: 0;
    vertical-align: middle;
  }

  .ticker__pill {
    border: 1px solid var(--border);
    border-radius: 9999px;
    padding: 3px 16px;
    display: inline-flex;
    align-items: center;
    gap: 0;
  }

  .ticker__pill .t-label {
    margin-right: 8px;
  }

  .ticker__item :global(svg) {
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
  }
</style>

<script define:vars={{ dailyColors, dailyWords }}>
  // @ts-nocheck
  const allItems = document.querySelectorAll('[data-ticker-item]');

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  const dataItems = [
    document.querySelector('[data-ticker-deploy]'),
    document.querySelector('[data-ticker-seconds]'),
    document.querySelector('[data-ticker-signal]'),
    document.querySelector('[data-ticker-carbon]'),
    document.querySelector('[data-ticker-build]'),
    document.querySelector('[data-ticker-color]'),
    document.querySelector('[data-ticker-word]')
  ].filter(Boolean);

  const quoteItems = [...document.querySelectorAll('[data-is-quote]')];
  const selectedQuotes = shuffle(quoteItems).slice(0, 2);

  const rotation = [];
  if (dataItems[0]) rotation.push(dataItems[0]);
  if (dataItems[1]) rotation.push(dataItems[1]);
  if (selectedQuotes[0]) rotation.push(selectedQuotes[0]);
  if (dataItems[2]) rotation.push(dataItems[2]);
  if (dataItems[3]) rotation.push(dataItems[3]);
  if (selectedQuotes[1]) rotation.push(selectedQuotes[1]);
  if (dataItems[4]) rotation.push(dataItems[4]);
  if (dataItems[5]) rotation.push(dataItems[5]);
  if (dataItems[6]) rotation.push(dataItems[6]);

  let currentIndex = 0;

  function showItem(index) {
    allItems.forEach((item) => item.classList.remove('ticker__item--active'));
    if (rotation[index]) {
      rotation[index].classList.add('ticker__item--active');
    }
  }

  if (rotation.length) {
    showItem(0);

    setInterval(() => {
      currentIndex = (currentIndex + 1) % rotation.length;
      showItem(currentIndex);
    }, 8000);
  }

  const deployEl = document.querySelector('[data-ticker-deploy-time]');
  if (deployEl) {
    const utcString = deployEl.dataset.tickerDeployTime;
    const deployDate = new Date(utcString);
    const formatted = deployDate.toLocaleString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false,
      timeZoneName: 'short'
    });
    deployEl.textContent = formatted;
  }

  const LAUNCH_DATE = new Date('2025-02-19T00:00:00Z');
  const counterEl = document.getElementById('seconds-live-ticker');

  function updateSecondsLive() {
    if (!counterEl) return;
    const now = new Date();
    const seconds = Math.floor((now.getTime() - LAUNCH_DATE.getTime()) / 1000);
    counterEl.textContent = seconds.toLocaleString();
  }

  updateSecondsLive();
  setInterval(updateSecondsLive, 1000);

  const browserIconEl = document.getElementById('ticker-browser-icon');
  const browserInfoEl = document.getElementById('ticker-browser-info');
  const minimapEl = document.getElementById('ticker-minimap');

  const ua = navigator.userAgent;
  let browserName = 'Browser';
  if (ua.includes('Arc/')) browserName = 'Arc';
  else if (ua.includes('Edg/')) browserName = 'Edge';
  else if (ua.includes('Chrome/')) browserName = 'Chrome';
  else if (ua.includes('Safari/') && !ua.includes('Chrome')) browserName = 'Safari';
  else if (ua.includes('Firefox/')) browserName = 'Firefox';

  let osName = 'Unknown';
  if (ua.includes('Mac')) osName = 'macOS';
  else if (ua.includes('Windows')) osName = 'Windows';
  else if (ua.includes('Linux')) osName = 'Linux';
  else if (ua.includes('Android')) osName = 'Android';
  else if (ua.includes('iPhone') || ua.includes('iPad')) osName = 'iOS';

  const resolution = `${screen.width}×${screen.height}`;

  if (browserInfoEl) {
    browserInfoEl.textContent = `${browserName} / ${osName} / ${resolution}`;
    browserInfoEl.classList.add('t-value');
  }

  const BROWSER_ICONS = {
    Chrome: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="2.5" y1="17" x2="7.5" y2="14"/><line x1="21.5" y1="17" x2="16.5" y2="14"/></svg>`,
    Safari: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88" fill="var(--text-tertiary)"/></svg>`,
    Firefox: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 2c-1 3 0 5 2 6 2 1 4 3 4 6"/></svg>`,
    Edge: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 8c2.2 0 4 1.8 4 4h-8"/></svg>`,
    Arc: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M8 14a5 5 0 0 1 8 0"/></svg>`,
    Browser: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/></svg>`
  };

  if (browserIconEl) {
    browserIconEl.innerHTML = BROWSER_ICONS[browserName] || BROWSER_ICONS.Browser;
  }

  const cityEl = document.getElementById('ticker-visitor-city');

  if (minimapEl) {
    const mapSvg = `<svg width="60" height="24" viewBox="0 0 200 100" fill="none" style="max-width:60px;max-height:24px;">
      <path d="M30,25 L45,20 L55,25 L50,40 L35,45 L25,35 Z" fill="var(--text-secondary)" opacity="0.35"/>
      <path d="M55,55 L65,50 L75,60 L70,80 L55,75 Z" fill="var(--text-secondary)" opacity="0.35"/>
      <path d="M85,20 L120,15 L130,25 L125,50 L100,55 L85,40 Z" fill="var(--text-secondary)" opacity="0.35"/>
      <path d="M130,30 L170,25 L180,40 L175,55 L160,60 L140,50 L130,40 Z" fill="var(--text-secondary)" opacity="0.35"/>
      <path d="M140,65 L170,60 L175,80 L150,85 L140,75 Z" fill="var(--text-secondary)" opacity="0.35"/>
      <circle id="visitor-dot" cx="0" cy="0" r="5" fill="var(--accent-primary)" opacity="0">
        <animate attributeName="r" values="3;5;3" dur="2s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
      </circle>
    </svg>`;
    minimapEl.innerHTML = mapSvg;

    fetch('https://ipapi.co/json/')
      .then((r) => r.json())
      .then((data) => {
        if (data.latitude && data.longitude) {
          const x = ((data.longitude + 180) / 360) * 200;
          const latRad = (data.latitude * Math.PI) / 180;
          const y = 50 - (Math.log(Math.tan(Math.PI / 4 + latRad / 2)) / Math.PI) * 50;
          const dot = minimapEl.querySelector('#visitor-dot');
          if (dot) {
            dot.setAttribute('cx', String(Math.max(5, Math.min(195, x))));
            dot.setAttribute('cy', String(Math.max(5, Math.min(95, y))));
            dot.setAttribute('opacity', '1');
          }
        }

        if (data.city && cityEl) {
          cityEl.textContent = data.city;
        }
      })
      .catch(() => {
      });
  }

  const today = new Date();
  const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);

  const todayColor = dailyColors[dayOfYear % dailyColors.length];
  const swatchRect = document.getElementById('color-swatch-rect');
  const hexEl = document.getElementById('color-hex');
  const nameEl = document.getElementById('color-name');

  if (todayColor) {
    if (swatchRect) swatchRect.setAttribute('fill', todayColor.hex);
    if (hexEl) hexEl.textContent = todayColor.hex;
    if (nameEl) nameEl.textContent = todayColor.name;
  }

  const wordEl = document.getElementById('word-of-day');
  const todayWord = dailyWords[dayOfYear % dailyWords.length];
  if (wordEl && todayWord) wordEl.textContent = todayWord;
</script>
