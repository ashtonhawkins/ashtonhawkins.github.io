---
import quotes from '../../data/quotes.json';

const deployTimestamp = new Date().toISOString().replace('T', ' — ').slice(0, 22) + ' UTC';

const buildNumber = 1;
const componentCount = 14;
const lineCount = 2850;

const co2PerView = '0.04g';
const pageWeight = '~300 KB';
const cleanerThan = '92%';
---

<div class="ticker" role="marquee" aria-label="Status ticker">
  <div class="ticker__track" id="ticker-track">
    <div class="ticker__item" data-ticker-item>
      <span class="ticker__pill">
        <span class="t-label">Last Site Deployment:</span>
        <span class="t-value">{deployTimestamp}</span>
        <span class="t-sep">·</span>
        <span class="t-value">99.8% Uptime</span>
      </span>
    </div>

    <div class="ticker__item" data-ticker-item>
      <span class="t-accent" id="seconds-live-ticker">31,622,000</span>
      <span class="t-label" style="margin-left: 8px;">seconds live</span>
    </div>

    {quotes.map((q: { text: string; author: string }) => (
      <div class="ticker__item ticker__item--quote" data-ticker-item data-is-quote>
        <span class="t-quote">"{q.text}"</span>
        <span class="t-author">— {q.author}</span>
      </div>
    ))}

    <div class="ticker__item" data-ticker-item id="ticker-signal-item">
      <span class="t-label">Signal:</span>
      <span id="ticker-browser-icon" style="margin: 0 4px; display: inline-flex; align-items: center;"></span>
      <span class="t-value" id="ticker-browser-info">detecting…</span>
      <span id="ticker-minimap" style="margin-left: 8px; display: inline-flex; align-items: center;"></span>
    </div>

    <div class="ticker__item" data-ticker-item>
      <span class="t-value">{co2PerView} CO₂</span>
      <span class="t-sep">·</span>
      <span class="t-value">{pageWeight}</span>
      <span class="t-sep">·</span>
      <span class="t-label">Cleaner than {cleanerThan} of sites</span>
    </div>

    <div class="ticker__item" data-ticker-item>
      <span class="t-label">Build</span>
      <span class="t-value">#{buildNumber}</span>
      <span class="t-sep">·</span>
      <span class="t-value">{componentCount} Components</span>
      <span class="t-sep">·</span>
      <span class="t-value">{lineCount.toLocaleString()} Lines</span>
    </div>
  </div>
</div>

<style>
  .ticker {
    height: 40px;
    background: var(--surface-secondary);
    overflow: hidden;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .ticker__track {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }

  .ticker__item {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
    white-space: nowrap;
    gap: 0;
  }

  .ticker__item--active {
    opacity: 1;
    pointer-events: auto;
  }

  .t-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    font-weight: 400;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .t-value {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .t-accent {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--accent-primary);
    font-variant-numeric: tabular-nums;
  }

  .t-sep {
    font-size: 9px;
    color: var(--text-tertiary);
    margin: 0 8px;
  }

  .t-quote {
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 12px;
    font-weight: 400;
    font-style: italic;
    color: var(--text-primary);
    text-transform: none;
  }

  .t-author {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    font-weight: 400;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-left: 8px;
  }

  .ticker__pill {
    border: 1px solid var(--border);
    border-radius: 9999px;
    padding: 3px 16px;
    display: inline-flex;
    align-items: center;
    gap: 0;
  }

  .ticker__pill .t-label {
    margin-right: 8px;
  }

  .ticker__item :global(svg) {
    display: inline-block;
    vertical-align: middle;
    flex-shrink: 0;
  }
</style>

<script>
  // @ts-nocheck
  const allItems = document.querySelectorAll('[data-ticker-item]');
  if (!allItems.length) {
    console.warn('Ticker: No items found');
  }

  const nonQuoteItems = [];
  const quoteItems = [];

  allItems.forEach((item) => {
    if (item.hasAttribute('data-is-quote')) {
      quoteItems.push(item);
    } else {
      nonQuoteItems.push(item);
    }
  });

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  const selectedQuotes = shuffle(quoteItems).slice(0, Math.min(3, quoteItems.length));

  const dataItems = [...nonQuoteItems];
  const rotation = [];

  let qi = 0;
  for (let i = 0; i < dataItems.length; i++) {
    rotation.push(dataItems[i]);
    if ((i + 1) % 2 === 0 && qi < selectedQuotes.length) {
      rotation.push(selectedQuotes[qi]);
      qi++;
    }
  }

  while (qi < selectedQuotes.length) {
    rotation.push(selectedQuotes[qi]);
    qi++;
  }

  let currentIndex = 0;

  function showItem(index) {
    allItems.forEach((item) => item.classList.remove('ticker__item--active'));
    if (rotation[index]) {
      rotation[index].classList.add('ticker__item--active');
    }
  }

  showItem(0);

  setInterval(() => {
    currentIndex = (currentIndex + 1) % rotation.length;
    showItem(currentIndex);
  }, 8000);

  const LAUNCH_DATE = new Date('2025-02-19T00:00:00Z');
  const counterEl = document.getElementById('seconds-live-ticker');

  function updateSecondsLive() {
    if (!counterEl) return;
    const now = new Date();
    const seconds = Math.floor((now.getTime() - LAUNCH_DATE.getTime()) / 1000);
    counterEl.textContent = seconds.toLocaleString();
  }

  updateSecondsLive();
  setInterval(updateSecondsLive, 1000);

  const browserIconEl = document.getElementById('ticker-browser-icon');
  const browserInfoEl = document.getElementById('ticker-browser-info');
  const minimapEl = document.getElementById('ticker-minimap');

  const ua = navigator.userAgent;
  let browserName = 'Browser';
  if (ua.includes('Arc/')) browserName = 'Arc';
  else if (ua.includes('Edg/')) browserName = 'Edge';
  else if (ua.includes('Chrome/')) browserName = 'Chrome';
  else if (ua.includes('Safari/') && !ua.includes('Chrome')) browserName = 'Safari';
  else if (ua.includes('Firefox/')) browserName = 'Firefox';

  let osName = 'Unknown';
  if (ua.includes('Mac')) osName = 'macOS';
  else if (ua.includes('Windows')) osName = 'Windows';
  else if (ua.includes('Linux')) osName = 'Linux';
  else if (ua.includes('Android')) osName = 'Android';
  else if (ua.includes('iPhone') || ua.includes('iPad')) osName = 'iOS';

  const resolution = `${screen.width}×${screen.height}`;

  if (browserInfoEl) {
    browserInfoEl.textContent = `${browserName} / ${osName} / ${resolution}`;
    browserInfoEl.classList.add('t-value');
  }

  const BROWSER_ICONS = {
    Chrome: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="10"/><line x1="12" y1="2" x2="12" y2="8"/><line x1="2.5" y1="17" x2="7.5" y2="14"/><line x1="21.5" y1="17" x2="16.5" y2="14"/></svg>`,
    Safari: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88" fill="var(--text-tertiary)"/></svg>`,
    Firefox: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 2c-1 3 0 5 2 6 2 1 4 3 4 6"/></svg>`,
    Edge: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M12 8c2.2 0 4 1.8 4 4h-8"/></svg>`,
    Arc: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M8 14a5 5 0 0 1 8 0"/></svg>`,
    Browser: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/></svg>`
  };

  if (browserIconEl) {
    browserIconEl.innerHTML = BROWSER_ICONS[browserName] || BROWSER_ICONS.Browser;
  }

  if (minimapEl) {
    const mapSvg = `<svg width="40" height="20" viewBox="0 0 200 100" fill="none" style="max-width:40px;max-height:20px;">
      <path d="M30,25 L45,20 L55,25 L50,40 L35,45 L25,35 Z" fill="var(--text-tertiary)" opacity="0.25"/>
      <path d="M55,55 L65,50 L75,60 L70,80 L55,75 Z" fill="var(--text-tertiary)" opacity="0.25"/>
      <path d="M85,20 L120,15 L130,25 L125,50 L100,55 L85,40 Z" fill="var(--text-tertiary)" opacity="0.25"/>
      <path d="M130,30 L170,25 L180,40 L175,55 L160,60 L140,50 L130,40 Z" fill="var(--text-tertiary)" opacity="0.25"/>
      <path d="M140,65 L170,60 L175,80 L150,85 L140,75 Z" fill="var(--text-tertiary)" opacity="0.25"/>
      <circle id="visitor-dot" cx="0" cy="0" r="4" fill="var(--accent-primary)" opacity="0">
        <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
      </circle>
    </svg>`;
    minimapEl.innerHTML = mapSvg;

    fetch('https://ipapi.co/json/')
      .then((r) => r.json())
      .then((data) => {
        if (data.latitude && data.longitude) {
          const x = ((data.longitude + 180) / 360) * 200;
          const latRad = (data.latitude * Math.PI) / 180;
          const y = 50 - (Math.log(Math.tan(Math.PI / 4 + latRad / 2)) / Math.PI) * 50;
          const dot = minimapEl.querySelector('#visitor-dot');
          if (dot) {
            dot.setAttribute('cx', String(Math.max(5, Math.min(195, x))));
            dot.setAttribute('cy', String(Math.max(5, Math.min(95, y))));
            dot.setAttribute('opacity', '1');
          }
        }
      })
      .catch(() => {
      });
  }
</script>
