---
interface Ring {
  label: string;
  value: number;
  goal?: number;
  colorClass?: string;
  hint?: string;
}

interface Props {
  rings: Ring[];
  centerTitle?: string;
  centerSubtitle?: string;
  size?: number;
  ariaLabel?: string;
}

const {
  rings = [],
  centerTitle = "",
  centerSubtitle = "",
  size = 320,
  ariaLabel = "System dial",
} = Astro.props;

const clamp = (value: number) => Math.min(Math.max(value, 0), 1);
const strokeWidth = 12;
const gap = 12;
const radiusBase = size / 2 - 18;
const processed = rings.map((ring, idx) => {
  const radius = radiusBase - idx * (strokeWidth + gap);
  const percent = clamp(ring.value ?? 0);
  const circumference = 2 * Math.PI * radius;
  const dash = Math.max(percent * circumference, 4);
  return { ...ring, radius, percent, circumference, dash };
});
---
<div class="relative" style={`width:${size}px`} role="figure" aria-label={ariaLabel}>
  <div class="relative aspect-square">
    <svg viewBox={`0 0 ${size} ${size}`} class="h-full w-full" role="presentation">
      <defs>
        <filter id="dialGlow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur" />
          <feMerge>
            <feMergeNode in="blur" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>
      <circle
        cx={size / 2}
        cy={size / 2}
        r={radiusBase - processed.length * 2}
        class="fill-surface/60 stroke-border/80"
        strokeWidth="1.5"
      />
      {processed.map((ring) => (
        <g key={ring.label} class="group/ring cursor-pointer" aria-label={`${ring.label} ring`} tabindex="0">
          <title>{`${ring.label}: ${Math.round(ring.percent * 100)}%${ring.hint ? ` · ${ring.hint}` : ""}`}</title>
          <circle
            cx={size / 2}
            cy={size / 2}
            r={ring.radius}
            class="stroke-border/60"
            strokeWidth={strokeWidth}
            fill="none"
          />
          <circle
            cx={size / 2}
            cy={size / 2}
            r={ring.radius}
            class={`origin-center fill-none ${ring.colorClass ?? "text-primary"} transition-all duration-300 motion-reduce:transition-none group-hover/ring:stroke-[13px] group-focus-visible/ring:stroke-[13px]`}
            strokeWidth={strokeWidth + 1.5}
            strokeLinecap="round"
            strokeDasharray={`${ring.dash} ${ring.circumference}`}
            strokeDashoffset="28"
            pathLength="1"
            stroke="currentColor"
            opacity="0.85"
            filter="url(#dialGlow)"
          />
          <text
            x={size / 2}
            y={size / 2 - ring.radius + strokeWidth + 6}
            text-anchor="middle"
            class="fill-current text-[11px] font-semibold text-text-secondary opacity-0 transition-opacity duration-200 group-hover/ring:opacity-100 group-focus-visible/ring:opacity-100"
          >
            {ring.label}
          </text>
        </g>
      ))}
    </svg>
    <div class="pointer-events-none absolute inset-0 flex items-center justify-center">
      <div class="flex min-w-[140px] flex-col items-center gap-1 rounded-2xl border border-border/80 bg-surface/80 px-4 py-3 text-center shadow-sm">
        <p class="text-[11px] uppercase tracking-[0.14em] text-text-tertiary">{centerTitle}</p>
        <p class="text-base font-semibold text-text-primary">{centerSubtitle}</p>
        <p class="text-[11px] text-text-secondary">Sensors online · steady</p>
      </div>
    </div>
  </div>
  <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-text-secondary">
    {processed.map((ring) => (
      <div class="flex items-center justify-between rounded-xl border border-border/60 bg-surface/70 px-3 py-2">
        <div class="flex items-center gap-2">
          <span class={`h-2.5 w-2.5 rounded-full ${ring.colorClass ?? "bg-primary"} bg-current`} aria-hidden="true" />
          <span class="font-medium text-text-primary">{ring.label}</span>
        </div>
        <span class="text-[11px] uppercase tracking-[0.08em] text-text-tertiary">{ring.hint}</span>
      </div>
    ))}
  </div>
</div>
