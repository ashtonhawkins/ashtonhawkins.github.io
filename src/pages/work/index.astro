---
import Page from '@layouts/Page.astro';
import { getCollection } from 'astro:content';

const caseStudies = (await getCollection('work', ({ data }) => !data.draft)).sort(
  (a, b) => Number(b.data.year) - Number(a.data.year)
);
---

<Page title="Work" description="Selected projects, anonymized where necessary.">
  <section class="container-shell max-grid mx-auto px-6 py-16 md:py-24">
    <header class="mb-12 space-y-4 md:mb-16">
      <h1
        class="font-semibold text-text-primary"
        data-scramble
        data-text="Work"
      >
        Work
      </h1>
      <p class="max-w-2xl text-lg text-text-secondary">Selected projects, anonymized where necessary.</p>
    </header>

    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
      {
        caseStudies.map((study, index) => (
          <article
            class="case-card rounded-xl border border-border bg-bg-card/80 p-6 transition-colors duration-200 hover:border-accent-primary/60"
            style={`transition-delay: ${index * 60}ms;`}
            data-reveal
          >
            <a href={`/work/${study.slug}/`} class="block space-y-4 no-underline">
              <div class="flex items-start justify-between gap-4">
                <h2 class="text-xl font-semibold text-text-primary">{study.data.title}</h2>
                <span class="rounded-full border border-border px-3 py-1 text-xs uppercase tracking-wide text-text-secondary">
                  {study.data.year}
                </span>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <span class="rounded-full bg-accent-primary/10 px-3 py-1 text-xs font-medium tracking-wide text-accent-primary">
                  {study.data.employer}
                </span>
                {
                  study.data.category.map((tag) => (
                    <span class="rounded-full border border-border px-3 py-1 text-xs text-text-secondary">{tag}</span>
                  ))
                }
              </div>

              <p class="text-sm text-text-secondary md:text-base">{study.data.description}</p>
            </a>
          </article>
        ))
      }
    </div>
  </section>
</Page>

<script>
  const scrambleTarget = document.querySelector('[data-scramble]');

  if (scrambleTarget instanceof HTMLElement) {
    const finalText = scrambleTarget.dataset.text ?? scrambleTarget.textContent ?? '';
    const glyphs = '!<>-_\\/[]{}â€”=+*^?#________';
    let frame = 0;

    const update = () => {
      const nextText = finalText
        .split('')
        .map((char, index) => {
          if (char === ' ') return ' ';
          if (index < frame) return char;
          return glyphs[Math.floor(Math.random() * glyphs.length)] ?? char;
        })
        .join('');

      scrambleTarget.textContent = nextText;
      frame += 0.35;

      if (frame <= finalText.length) {
        requestAnimationFrame(update);
      } else {
        scrambleTarget.textContent = finalText;
      }
    };

    update();
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) return;
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      });
    },
    { threshold: 0.2 }
  );

  document.querySelectorAll('[data-reveal]').forEach((element) => observer.observe(element));
</script>

<style>
  [data-reveal] {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 450ms ease, transform 450ms ease;
  }

  [data-reveal].is-visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>
