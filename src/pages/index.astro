---
import Base from '@layouts/Base.astro';
import '@styles/coming-soon.css';
---

<Base
  title="Ashton Hawkins — Personal Operating System"
  description="Connection logged. Ashton Hawkins — digital infrastructure, growth systems, and platform operations."
  robots="noindex"
>
  <main class="os-root">
    <div class="os-container">
      <div id="terminal" class="os-terminal"></div>
    </div>
  </main>
</Base>

<script is:inline>
  (() => {
    const terminal = document.getElementById('terminal');
    if (!(terminal instanceof HTMLElement)) return;

    const DIVIDER = '————————————————————————————————';
    const EPOCH_MS = Date.parse('2025-01-15T00:00:00Z');
    const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const instantBoot = reducedMotion || sessionStorage.getItem('ah-booted') === '1';

    const state = {
      subjectId: '',
      detect: null,
      bootNodes: [],
      commandNodes: [],
      history: [],
      historyIndex: -1,
      uptimeEl: null,
      promptWrap: null,
      queryInput: null,
      uptimeTimer: null
    };

    const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
    const random = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    const line = (text = '', cls = 'os-line') => {
      const el = document.createElement('div');
      el.className = cls;
      el.textContent = text;
      return el;
    };

    const appendBootNode = (node) => {
      state.bootNodes.push(node);
      terminal.appendChild(node);
      return node;
    };

    const appendCommandNode = (node) => {
      state.commandNodes.push(node);
      terminal.insertBefore(node, state.promptWrap);
      return node;
    };

    const scrollToPrompt = () => {
      state.promptWrap?.scrollIntoView({ block: 'end', behavior: instantBoot ? 'auto' : 'smooth' });
    };

    const typeInto = async (node, text, min = 20, max = 20) => {
      if (instantBoot) {
        node.textContent = text;
        return;
      }
      for (const ch of text) {
        node.textContent += ch;
        await delay(random(min, max));
      }
    };

    const updateUptime = () => {
      if (!state.uptimeEl) return;
      const seconds = Math.max(0, Math.floor((Date.now() - EPOCH_MS) / 1000));
      state.uptimeEl.textContent = seconds.toLocaleString();
    };

    const parseUA = (ua) => {
      const upper = ua.toUpperCase();
      const pick = (re) => (ua.match(re)?.[1] || '').trim();
      let browser = 'UNKNOWN';
      let engine = 'UNKNOWN';
      if (upper.includes('FIREFOX')) {
        browser = `FIREFOX ${pick(/FIREFOX\/(\d+)/i)}`.trim();
        engine = 'GECKO';
      } else if (upper.includes('EDG/')) {
        browser = `EDGE ${pick(/EDG\/(\d+)/i)}`.trim();
        engine = 'BLINK';
      } else if (upper.includes('CHROME')) {
        browser = `CHROME ${pick(/CHROME\/(\d+)/i)}`.trim();
        engine = 'BLINK';
      } else if (upper.includes('SAFARI')) {
        browser = `SAFARI ${pick(/VERSION\/(\d+)/i)}`.trim();
        engine = 'WEBKIT';
      }
      let os = 'UNKNOWN';
      if (upper.includes('MAC')) os = 'MACOS';
      else if (upper.includes('WINDOWS')) os = 'WINDOWS';
      else if (upper.includes('ANDROID')) os = 'ANDROID';
      else if (upper.includes('IPHONE') || upper.includes('IPAD')) os = 'IOS';
      else if (upper.includes('LINUX')) os = 'LINUX';
      return { browserOs: `${browser} / ${os}`, engine };
    };

    const detectVisitor = async () => {
      const ua = parseUA(navigator.userAgent || '');
      const display = `${innerWidth} × ${innerHeight} @ ${String(devicePixelRatio || 1).replace(/\.0$/, '')}X / ${screen.colorDepth}-BIT`;

      let renderer = 'UNAVAILABLE';
      let webgl = 'NONE';
      let maxTexture = 'N/A';
      try {
        const c = document.createElement('canvas');
        const gl2 = c.getContext('webgl2');
        const gl = gl2 || c.getContext('webgl');
        if (gl) {
          webgl = gl2 ? '2.0' : '1.0';
          const ext = gl.getExtension('WEBGL_debug_renderer_info');
          const raw = ext ? gl.getParameter(ext.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);
          renderer = `${String(raw).toUpperCase().replace(/\s+/g, ' ').split(',')[0]} [WEBGL ${webgl}]`;
          maxTexture = String(gl.getParameter(gl.MAX_TEXTURE_SIZE));
        }
      } catch {}

      let battery = null;
      if (typeof navigator.getBattery === 'function') {
        try {
          const b = await navigator.getBattery();
          battery = `${Math.round((b.level || 0) * 100)}% [${b.charging ? 'CHARGING' : 'DISCHARGING'}]`;
        } catch {}
      }

      const conn = navigator.connection;
      const network = conn?.effectiveType
        ? `${String(conn.effectiveType).toUpperCase()} / ~${conn.rtt || '?'}MS RTT`
        : 'UNRESOLVED';

      return {
        ...ua,
        display,
        renderer,
        processing: navigator.hardwareConcurrency ? `${navigator.hardwareConcurrency} LOGICAL CORES` : 'UNKNOWN',
        network,
        battery,
        color: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'DARK MODE ENABLED' : 'LIGHT MODE ENABLED',
        input: (navigator.maxTouchPoints || 0) > 0 ? 'TOUCH / POINTER HYBRID' : 'POINTER / NO TOUCH DETECTED',
        locale: (navigator.language || 'UNSET').toUpperCase(),
        languages: (navigator.languages || []).map((l) => l.toUpperCase()).join(' / ') || 'UNSET',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UNSET',
        platform: navigator.platform || 'UNSET',
        cookies: navigator.cookieEnabled ? 'ENABLED' : 'DISABLED',
        dnt: navigator.doNotTrack || 'UNSET',
        screenNative: `${screen.width} × ${screen.height}`,
        colorDepth: `${screen.colorDepth}-BIT`,
        webgl,
        maxTexture
      };
    };

    const renderPrompt = () => {
      const wrap = document.createElement('div');
      wrap.className = 'os-query-inline';
      if (!instantBoot) {
        wrap.style.opacity = '0';
        wrap.style.transition = 'opacity 300ms ease';
      }
      wrap.innerHTML = `<span class="os-prompt-label">QUERY //</span>
        <input class="os-query-input" type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" placeholder="TYPE 'CATALOG' FOR COMMAND DIRECTORY" />
        <span class="os-cursor">▮</span>`;

      const input = wrap.querySelector('input');
      if (!(input instanceof HTMLInputElement)) return;
      if (matchMedia('(max-width: 640px)').matches) {
        input.placeholder = "'CATALOG' FOR COMMANDS";
      }
      terminal.appendChild(wrap);
      state.promptWrap = wrap;
      state.queryInput = input;
      requestAnimationFrame(() => {
        wrap.style.opacity = '1';
        input.focus();
      });
    };

    const runIntakeBlock = async (boot = false) => {
      const append = boot ? appendBootNode : appendCommandNode;
      const incoming = line('', 'os-line c-head');
      append(incoming);
      await typeInto(incoming, 'INCOMING CONNECTION LOGGED', 30, 40);
      if (!instantBoot) await delay(200);

      state.subjectId = `AH-${new Date().getFullYear()}-${random(10000, 99999)}`;
      const subjectLine = line('', 'os-line c-sub');
      const prefix = document.createElement('span');
      prefix.textContent = `SUBJECT ID: AH-${new Date().getFullYear()}-`;
      const digits = document.createElement('span');
      subjectLine.append(prefix, digits);
      append(subjectLine);

      const finalDigits = state.subjectId.split('-').at(-1) || '';
      if (instantBoot) {
        digits.textContent = finalDigits;
      } else {
        for (let i = 0; i < random(8, 10); i += 1) {
          digits.textContent = String(random(10000, 99999));
          await delay(80);
        }
        digits.textContent = finalDigits;
        digits.classList.add('anim-flash');
      }

      append(line('', 'os-blank'));
      if (!instantBoot) await delay(300);

      const scanBlock = document.createElement('div');
      append(scanBlock);
      const pairs = [
        ['BROWSER IDENT', state.detect.browserOs],
        ['DISPLAY CONFIG', state.detect.display],
        ['GPU SUBSYSTEM', state.detect.renderer],
        ['PROCESSING', state.detect.processing],
        ['NETWORK CLASS', state.detect.network],
        ...(state.detect.battery ? [['POWER STATUS', state.detect.battery]] : []),
        ['COLOR PREF', state.detect.color],
        ['INPUT METHOD', state.detect.input],
        ['LOCALE', state.detect.locale]
      ];

      for (const [k, v] of pairs) {
        const row = line('', 'os-line');
        const ks = document.createElement('span');
        ks.className = 'c-dim';
        ks.textContent = k.padEnd(18, ' ');
        const vs = document.createElement('span');
        vs.className = 'c-val';
        row.append(ks, vs);
        scanBlock.appendChild(row);
        await typeInto(vs, v, 30, 30);
        if (!instantBoot) await delay(random(100, 150));
      }

      if (!instantBoot) {
        scanBlock.classList.add('anim-scan');
        await delay(300);
      }

      append(line(DIVIDER, 'os-divider'));
      if (!instantBoot) await delay(600);

      const grant = line('CONNECTION PERMITTED — READ-ONLY ACCESS GRANTED', 'os-line c-status crt-glow');
      if (!instantBoot) grant.classList.add('anim-flash');
      append(grant);
    };

    const runBoot = async () => {
      const today = new Date();
      const build = `${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;

      const header = line('', 'os-line c-head');
      header.dataset.hover = '1';
      appendBootNode(header);
      await typeInto(header, 'ASHTON HAWKINS — PERSONAL OPERATING SYSTEM          ', 50, 50);

      const buildLine = line('', 'os-line c-sub');
      appendBootNode(buildLine);
      await typeInto(buildLine, `BUILD [${build}] — REV 847                        `, 50, 50);

      if (!instantBoot) await delay(600);

      const classLine = line('', 'os-line');
      classLine.innerHTML = '<span class="c-dim">CLASSIFICATION: </span>';
      const value = document.createElement('span');
      classLine.appendChild(value);
      appendBootNode(classLine);

      if (instantBoot) {
        value.className = 'c-accent';
        value.textContent = 'UNRESTRICTED';
      } else {
        const vals = [
          ['CLASSIFIED', 'c-warn'],
          ['RESTRICTED', 'c-warn'],
          ['EYES ONLY', 'c-warn'],
          ['DECLASSIFYING...', 'c-sub']
        ];
        value.classList.add('anim-glitch');
        for (let i = 0; i < 4; i += 1) {
          const [txt, cls] = vals[i];
          value.className = `${cls} anim-glitch`;
          value.textContent = txt;
          await delay(300);
        }
        value.className = 'c-accent anim-flash';
        value.textContent = 'UNRESTRICTED';
      }

      if (!instantBoot) await delay(400);
      appendBootNode(line(DIVIDER, 'os-divider'));
      if (!instantBoot) await delay(500);

      await runIntakeBlock(true);
      if (!instantBoot) await delay(500);

      const uptimeRow = line('', 'os-line');
      const k = document.createElement('span');
      k.className = 'c-dim';
      k.textContent = 'SYS UPTIME'.padEnd(18, ' ');
      const v = document.createElement('span');
      v.className = 'c-accent';
      state.uptimeEl = v;
      uptimeRow.append(k, v, document.createTextNode('S'));
      appendBootNode(uptimeRow);
      updateUptime();
      state.uptimeTimer = window.setInterval(updateUptime, 1000);

      if (!instantBoot) await delay(200);
      const badge = document.createElement('div');
      badge.className = 'os-status-badge';
      badge.innerHTML = `<span class="c-dim">STATUS //</span>
        <span class="c-head"> SITE RECONSTRUCTION IN PROGRESS</span>
        <br>
        <span class="c-dim">[</span><span class="progress-bar">████████████</span><span class="progress-track">████████</span><span class="c-dim">]</span>
        <span class="c-sub"> 60%</span>
        <br>
        <span class="c-dim">NEW SYSTEM ONLINE // 2026</span>`;
      if (!instantBoot) {
        badge.style.opacity = '0';
        badge.style.transition = 'opacity 400ms ease';
      }
      appendBootNode(badge);
      requestAnimationFrame(() => {
        badge.style.opacity = '1';
      });

      if (!instantBoot) await delay(400);
      renderPrompt();
      scrollToPrompt();
      sessionStorage.setItem('ah-booted', '1');
    };

    const outputLines = async (rows, cls = 'c-val') => {
      for (const row of rows) {
        const l = line('', 'os-line');
        const span = document.createElement('span');
        span.className = row.cls || cls;
        l.appendChild(span);
        appendCommandNode(l);
        await typeInto(span, row.text, 20, 20);
      }
    };

    const runCommand = async (raw) => {
      const input = raw.trim();
      if (!input) return;
      appendCommandNode(line(`> ${input}`, 'os-line c-dim'));
      const cmd = input.toLowerCase();

      if (cmd === 'clear') {
        for (const n of state.commandNodes) n.remove();
        state.commandNodes = [];
        window.scrollTo({ top: 0, behavior: 'auto' });
        return;
      }

      if (cmd === 'catalog') {
        await outputLines([
          { text: DIVIDER, cls: 'c-border' },
          { text: 'AVAILABLE QUERIES', cls: 'c-head' },
          { text: DIVIDER, cls: 'c-border' },
          { text: 'CATALOG      THIS DIRECTORY' },
          { text: 'SUBJECT      CONNECTION INTAKE REPORT' },
          { text: 'DOSSIER      PERSONNEL FILE: HAWKINS, A.' },
          { text: 'MANIFEST     PROJECT FILE INDEX' },
          { text: 'SYSREPORT    SYSTEM DIAGNOSTIC' },
          { text: 'NETCHECK     NETWORK SUBSYSTEM AUDIT' },
          { text: 'RESCAN       RE-EXECUTE CONNECTION INTAKE' },
          { text: 'CLEAR        PURGE TERMINAL OUTPUT' },
          { text: DIVIDER, cls: 'c-border' }
        ]);
      } else if (cmd === 'subject') {
        const d = state.detect;
        await outputLines([
          { text: DIVIDER, cls: 'c-border' },
          { text: 'SUBJECT INTAKE REPORT', cls: 'c-head' },
          { text: `ID: ${state.subjectId}`, cls: 'c-sub' },
          { text: DIVIDER, cls: 'c-border' },
          { text: `BROWSER IDENT    ${d.browserOs}` },
          { text: `ENGINE           ${d.engine}` },
          { text: `DISPLAY CONFIG   ${d.display}` },
          { text: `SCREEN NATIVE    ${d.screenNative}` },
          { text: `COLOR DEPTH      ${d.colorDepth}` },
          { text: `GPU SUBSYSTEM    ${d.renderer}` },
          { text: `PROCESSING       ${d.processing}` },
          { text: `NETWORK CLASS    ${d.network}` },
          { text: `POWER STATUS     ${d.battery || 'UNAVAILABLE'}` },
          { text: `COLOR PREF       ${d.color}` },
          { text: `INPUT METHOD     ${d.input}` },
          { text: `LOCALE           ${d.locale}` },
          { text: `LANGUAGES        ${d.languages}` },
          { text: `TIMEZONE         ${d.timezone}` },
          { text: `PLATFORM         ${d.platform}` },
          { text: `COOKIES          ${d.cookies}` },
          { text: `DO NOT TRACK     ${d.dnt}` },
          { text: `WEBGL VERSION    ${d.webgl}` },
          { text: `MAX TEXTURE      ${d.maxTexture}` },
          { text: DIVIDER, cls: 'c-border' }
        ]);
      } else if (cmd === 'dossier') {
        await outputLines([
          { text: DIVIDER, cls: 'c-border' },
          { text: 'PERSONNEL FILE — RESTRICTED', cls: 'c-head' },
          { text: DIVIDER, cls: 'c-border' },
          { text: 'SURNAME          HAWKINS' },
          { text: 'GIVEN            ASHTON' },
          { text: 'CLASSIFICATION   LEVEL 4 — SYSTEMS OPERATOR' },
          { text: 'DOMAIN           DIGITAL INFRASTRUCTURE &' },
          { text: '                 GROWTH SYSTEMS' },
          { text: '' },
          { text: 'CORE FUNCTIONS   CONVERSION ARCHITECTURE' },
          { text: '                 ORGANIC ACQUISITION SYSTEMS' },
          { text: '                 INFORMATION TOPOLOGY' },
          { text: '                 BEHAVIORAL ANALYTICS' },
          { text: '                 PLATFORM OPERATIONS' },
          { text: '' },
          { text: 'DEPLOYMENT       ENTERPRISE ECOMMERCE — FORTUNE 1' },
          { text: 'HISTORY          HEALTHCARE SYSTEMS' },
          { text: '                 CONSULTING OPERATIONS' },
          { text: '                 INDEPENDENT CONTRACTS' },
          { text: '' },
          { text: 'METHODOLOGY      COMPOUND GROWTH THROUGH' },
          { text: '                 SYSTEMATIC OPTIMIZATION' }
        ]);
        const status = line('STATUS           ████████ ACCEPTING ENGAGEMENTS ████████', 'os-line c-accent anim-flash');
        appendCommandNode(status);
        await outputLines([{ text: DIVIDER, cls: 'c-border' }]);
      } else if (cmd === 'manifest') {
        const l = [
          `${DIVIDER}`,
          'PROJECT MANIFEST — ashtonhawkins.com',
          `${DIVIDER}`,
          'FILE                  STATUS      PRIORITY',
          'index.astro           [LIVE]      —',
          'about.astro           [WIP]       HIGH',
          'writing.astro         [WIP]       HIGH',
          'work.astro            [WIP]       MEDIUM',
          'cycling.astro         [WIP]       MEDIUM',
          'now.astro             [WIP]       LOW',
          'travel.astro          [WIP]       LOW',
          DIVIDER,
          'TOTAL: 7 FILES — 1 LIVE / 6 IN PROGRESS',
          DIVIDER
        ];
        for (const t of l) {
          const row = line('', 'os-line');
          const span = document.createElement('span');
          span.className = t.includes('[LIVE]') ? 'c-accent' : t.includes('[WIP]') ? 'c-dim' : 'c-val';
          row.appendChild(span);
          appendCommandNode(row);
          await typeInto(span, t, 20, 20);
        }
      } else if (cmd === 'sysreport') {
        const up = Math.max(0, Math.floor((Date.now() - EPOCH_MS) / 1000)).toLocaleString();
        await outputLines([
          { text: DIVIDER, cls: 'c-border' },
          { text: 'SYSTEM DIAGNOSTIC', cls: 'c-head' },
          { text: DIVIDER, cls: 'c-border' },
          { text: `UPTIME           ${up}S` },
          { text: 'FRAMEWORK        ASTRO 5 + TYPESCRIPT' },
          { text: 'HOST             GITHUB PAGES' },
          { text: 'BUILD SYSTEM     GITHUB ACTIONS' },
          { text: 'DATA PIPELINE    CRON — 6H INTERVAL' },
          { text: 'INTEGRATIONS     STRAVA · LAST.FM · OURA · LETTERBOXD' },
          { text: 'API STATUS       4/4 NOMINAL' },
          { text: 'LAST DEPLOY      2026-02-23' },
          { text: 'REVISION         847' },
          { text: DIVIDER, cls: 'c-border' }
        ]);
      } else if (cmd === 'netcheck') {
        await outputLines([
          { text: DIVIDER, cls: 'c-border' },
          { text: 'NETWORK SUBSYSTEM AUDIT', cls: 'c-head' },
          { text: DIVIDER, cls: 'c-border' }
        ]);
        const names = ['STRAVA', 'LAST.FM', 'OURA', 'LETTERBOXD'];
        let timeout = false;
        for (const name of names) {
          const row = line('', 'os-line c-val');
          appendCommandNode(row);
          const head = document.createElement('span');
          head.textContent = `PINGING ${name} `;
          row.appendChild(head);
          const dots = document.createElement('span');
          row.appendChild(dots);
          for (let i = 0; i < 13; i += 1) {
            dots.textContent += '.';
            await delay(40);
          }
          const t = Math.random() < 0.1;
          timeout = timeout || t;
          const tail = document.createElement('span');
          tail.className = t ? 'c-warn' : 'c-accent';
          tail.textContent = t ? ` [TIMEOUT]` : ` [${random(15, 120)}MS] [OK]`;
          row.appendChild(tail);
          await delay(random(400, 700));
        }
        await outputLines([
          { text: timeout ? 'PARTIAL DEGRADATION DETECTED' : 'ALL SUBSYSTEMS NOMINAL', cls: timeout ? 'c-warn' : 'c-accent' },
          { text: DIVIDER, cls: 'c-border' }
        ]);
      } else if (cmd === 'rescan') {
        await runIntakeBlock(false);
      } else if (cmd.startsWith('sudo')) {
        await outputLines([{ text: 'ACCESS DENIED — CLEARANCE INSUFFICIENT. THIS INCIDENT HAS BEEN LOGGED.', cls: 'c-warn' }]);
      } else if (cmd === 'exit') {
        await outputLines([{ text: 'SESSION TERMINATED.', cls: 'c-warn' }]);
        await delay(2000);
        await outputLines([{ text: 'SESSION CANNOT BE TERMINATED FROM THIS INTERFACE.', cls: 'c-sub' }]);
      } else if (['hello', 'hi', 'hey'].includes(cmd)) {
        await outputLines([{ text: "THIS IS NOT A CONVERSATIONAL INTERFACE. TYPE 'CATALOG' FOR AVAILABLE QUERIES.", cls: 'c-sub' }]);
      } else {
        await outputLines([{ text: `UNRECOGNIZED QUERY: ${input.toUpperCase()}. TYPE 'CATALOG' FOR DIRECTORY.`, cls: 'c-dim' }]);
      }
      scrollToPrompt();
    };

    const bindInput = () => {
      if (!state.queryInput) return;
      state.queryInput.addEventListener('keydown', async (event) => {
        if (event.key === 'Enter') {
          const value = state.queryInput.value;
          state.queryInput.value = '';
          state.history.push(value);
          if (state.history.length > 20) state.history.shift();
          state.historyIndex = state.history.length;
          await runCommand(value);
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          state.historyIndex = Math.max(0, state.historyIndex - 1);
          state.queryInput.value = state.history[state.historyIndex] || '';
        } else if (event.key === 'ArrowDown') {
          event.preventDefault();
          state.historyIndex = Math.min(state.history.length, state.historyIndex + 1);
          state.queryInput.value = state.history[state.historyIndex] || '';
        }
      });
    };

    (async () => {
      state.detect = await detectVisitor();
      await runBoot();
      bindInput();
      scrollToPrompt();
    })();
  })();
</script>
