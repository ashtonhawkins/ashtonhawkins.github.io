---
import AppShell from "../layouts/AppShell.astro";
import SEO from "../components/SEO.astro";
import Hero from "../components/resume/Hero.astro";
import ConfidentialToggle from "../components/resume/ConfidentialToggle.astro";
import BeforeAfter from "../components/resume/BeforeAfter.astro";
import ExperimentGallery from "../components/resume/ExperimentGallery.astro";
import ImpactTapestry from "../components/resume/ImpactTapestry.astro";
import CaseStudyGrid from "../components/resume/CaseStudyGrid.astro";
import ExperienceTimeline from "../components/resume/ExperienceTimeline.astro";
import CapabilitiesMap from "../components/resume/CapabilitiesMap.astro";
import ActionDock from "../components/resume/ActionDock.astro";
import resume from "../data/resume.json";
import printStyles from "../styles/print.css?url";

const searchParams = Astro.url.searchParams;
const modeParam = searchParams.get("mode");
const isConfidentialInitial = modeParam ? modeParam !== "public" : true;

const formatRange = (start: string, end: string) => {
  const startDate = new Date(start);
  const endDate = new Date(end);
  const formatter = new Intl.DateTimeFormat("en", { month: "short", year: "numeric" });
  return `${formatter.format(startDate)} â€“ ${formatter.format(endDate)}`;
};

const experiences = resume.experience.map((experience) => {
  const caseStudyRefs = experience.caseStudyIds
    ? experience.caseStudyIds
        .map((id) => resume.caseStudies.find((caseStudy) => caseStudy.id === id))
        .filter(Boolean)
        .map((caseStudy) => ({
          id: caseStudy!.id,
          title: caseStudy!.title,
          sensitive: caseStudy!.sensitive ?? false
        }))
    : [];
  return {
    ...experience,
    rangePublic: formatRange(experience.start, experience.end),
    rangeConfidential: `~${experience.durationYears.toFixed(1)} years`,
    caseStudies: caseStudyRefs
  };
});

const email = "hello@ashtonhawkins.com";
const title = "Ashton Hawkins Â· Resume";
const description = resume.hero.subhead;
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : Astro.url.href;

const textExport = [
  resume.hero.headline,
  resume.hero.subhead,
  "",
  "Key Metrics:",
  ...resume.kpis.map((kpi) => `${kpi.label}: ${kpi.value}${kpi.suffix ?? ""}`),
  "",
  "Experiences:",
  ...experiences.map((experience) => `${experience.role_public} @ ${experience.org_public}`)
].join("\n");
---
<AppShell>
  <SEO slot="head" title={title} description={description} ogTitle={title} canonical={canonicalUrl} />
  <link rel="stylesheet" href={printStyles} media="print" />
  <style is:inline>
    :root {
      --ink: #0b1120;
      --ink-2: rgba(11, 17, 32, 0.7);
      --surface: #f7f7f9;
      --surface-alt: #ffffff;
      --accent: #0f7bf2;
      --r-2: 0.75rem;
      --r-3: 1rem;
      --r-4: 1.5rem;
    }
    body {
      background: radial-gradient(circle at 0 0, rgba(15, 123, 242, 0.08), transparent 50%), radial-gradient(circle at 100% 0, rgba(15, 123, 242, 0.08), transparent 50%), var(--surface);
    }
    main {
      position: relative;
    }
    main::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(var(--surface), var(--surface)),
        conic-gradient(from 90deg, rgba(12, 20, 32, 0.04) 0deg, rgba(12, 20, 32, 0.04) 90deg, transparent 90deg, transparent 180deg);
      background-size: 100% 100%, 48px 48px;
      mix-blend-mode: multiply;
      opacity: 0.6;
      z-index: -1;
    }
    [data-confidential-root][data-confidential-state="confidential"] .public-only {
      display: none !important;
    }
    [data-confidential-root][data-confidential-state="public"] .confidential-only {
      display: none !important;
    }
    [data-toast-root] {
      position: fixed;
      bottom: 1.5rem;
      right: clamp(1rem, 6vw, 6rem);
      z-index: 50;
      padding: 0.75rem 1.25rem;
      border-radius: var(--r-2);
      background: var(--ink);
      color: var(--surface);
      font-size: 0.875rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.2s var(--motion-ease, cubic-bezier(.2,.8,.2,1)), transform 0.2s var(--motion-ease, cubic-bezier(.2,.8,.2,1));
      pointer-events: none;
    }
    [data-toast-root][data-state="visible"] {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
  <article
    class="flex flex-col gap-12"
    data-confidential-root
    data-confidential-state={isConfidentialInitial ? "confidential" : "public"}
  >
    <Hero hero={resume.hero} kpis={resume.kpis}>
      <ConfidentialToggle slot="mode-toggle" isConfidential={isConfidentialInitial} />
    </Hero>
    <BeforeAfter items={resume.beforeAfter} />
    <ExperimentGallery items={resume.experiments} />
    <ImpactTapestry items={resume.tapestry} />
    <CaseStudyGrid caseStudies={resume.caseStudies} />
    <ExperienceTimeline experiences={experiences} />
    <CapabilitiesMap capabilities={resume.capabilities} />
  </article>
  <ActionDock email={email} bio={resume.bioShort} jsonExport={resume} textExport={textExport} />
  <div aria-live="polite" data-toast-root></div>
  <script type="module">
const storageKey = 'resume_confidential';
const root = document.querySelector<HTMLElement>('[data-confidential-root]');
const toggle = document.querySelector<HTMLButtonElement>('[data-confidential-toggle]');
const url = new URL(window.location.href);
const modeParam = url.searchParams.get('mode');
let state = root?.getAttribute('data-confidential-state') !== 'public';
if (modeParam) {
  state = modeParam !== 'public';
  localStorage.setItem(storageKey, state ? 'true' : 'false');
} else {
  const stored = localStorage.getItem(storageKey);
  if (stored !== null) {
    state = stored !== 'false';
  }
}
const apply = () => {
  if (!root || !toggle) return;
  root.setAttribute('data-confidential-state', state ? 'confidential' : 'public');
  toggle.dataset.state = state ? 'confidential' : 'public';
  const icon = toggle.querySelector('[data-icon]');
  const label = toggle.querySelector('[data-label]');
  if (icon) icon.textContent = state ? 'ðŸ”’' : 'ðŸ”“';
  if (label) label.textContent = state ? 'Confidential' : 'Public';
};
apply();
if (toggle) {
  toggle.addEventListener('click', () => {
    state = !state;
    localStorage.setItem(storageKey, state ? 'true' : 'false');
    if (state) {
      url.searchParams.set('mode', 'confidential');
    } else {
      url.searchParams.set('mode', 'public');
    }
    history.replaceState(history.state, '', url.toString());
    apply();
  });
}
  </script>
</AppShell>
