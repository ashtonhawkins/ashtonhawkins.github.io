---
import AppShell from "../layouts/AppShell.astro";
import SEO from "../components/SEO.astro";
import Hero from "../components/resume/Hero.astro";
import ImpactTapestry from "../components/resume/ImpactTapestry.astro";
import ExperienceTimeline from "../components/resume/ExperienceTimeline.astro";
import CaseStudyGrid from "../components/resume/CaseStudyGrid.astro";
import KeywordChips from "../components/resume/KeywordChips.astro";
import ConfidentialToggle from "../components/resume/ConfidentialToggle.astro";
import ActionDock from "../components/resume/ActionDock.astro";
import resume from "../data/resume.json";
import { formatPreciseRange, formatApproxRange } from "../utils/confidential";
import { parseTags } from "../utils/filters";
import printStyles from "../styles/print.css?url";

const searchParams = Astro.url.searchParams;
const modeParam = searchParams.get("mode");
const isConfidential = modeParam ? modeParam !== "public" : true;
const activeTags = parseTags(searchParams.get("tags"));

const caseStudyMap = new Map(resume.caseStudies.map((item) => [item.id, item]));

const experiences = resume.experience.map((item) => ({
  ...item,
  rangePublic: formatPreciseRange(item.start, item.end),
  rangeConfidential: formatApproxRange(item.start, item.end),
  caseStudies: item.caseStudyIds
    .map((id) => caseStudyMap.get(id))
    .filter(Boolean)
    .map((caseStudy) => ({
      id: caseStudy!.id,
      title: caseStudy!.title,
      url: caseStudy!.url,
      sensitive: caseStudy!.sensitive ?? false
    }))
}));

const email = "hello@ashtonhawkins.com";
const title = "Ashton Hawkins Â· Resume";
const description = resume.hero.subhead;
const canonicalUrl = Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : Astro.url.href;
const initialTagsLiteral = JSON.stringify(activeTags);
---

<AppShell>
  <SEO slot="head" title={title} description={description} ogTitle={title} canonical={canonicalUrl} />
  <link rel="stylesheet" href={printStyles} media="print" />
  <style is:inline>
    [data-confidential-root][data-confidential-state="confidential"] .public-only {
      display: none;
    }
    [data-confidential-root][data-confidential-state="public"] .confidential-only {
      display: none;
    }
    [data-toast] {
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 180ms ease, transform 180ms ease;
    }
    [data-toast][data-state="visible"] {
      opacity: 1;
      transform: translateY(0);
    }
    article[data-confidential-root] {
      --resume-surface-odd: color-mix(in srgb, var(--surface) 88%, transparent);
      --resume-surface-even: color-mix(in srgb, var(--surface) 80%, transparent);
    }
  </style>
  <article
    class="flex flex-col gap-16"
    data-confidential-root
    data-confidential-state={isConfidential ? "confidential" : "public"}
  >
    <Hero hero={resume.hero} email={email} metrics={resume.metrics} bio={resume.bioShort}>
      <ConfidentialToggle slot="mode-toggle" isConfidential={isConfidential} />
    </Hero>
    <ImpactTapestry items={resume.tapestry} />
    <ExperienceTimeline experiences={experiences} />
    <CaseStudyGrid caseStudies={resume.caseStudies} />
    <section class="rounded-3xl border border-border/60 bg-[color:var(--resume-surface-even)] p-6 shadow-soft">
      <span class="text-xs font-semibold uppercase tracking-[0.32em] text-text-muted">Focus areas</span>
      <KeywordChips keywords={resume.keywords} activeTags={activeTags} />
    </section>
  </article>
  <ActionDock email={email} bio={resume.bioShort} />
  <div aria-live="polite" data-toast class="pointer-events-none fixed bottom-24 right-6 z-50 rounded-full bg-text-primary px-4 py-2 text-sm font-medium text-background shadow-soft"></div>
  <script type="module">
import { parseTags, serializeTags } from '../utils/filters.ts';

const initialTags = {initialTagsLiteral};
let activeTags = new Set(initialTags);
let printBound = false;

const applyFilters = () => {
  const tags = Array.from(activeTags);
  document.querySelectorAll('[data-keyword-chip]').forEach((chip) => {
    const tag = chip.getAttribute('data-tag');
    const isActive = tag ? tags.includes(tag) : false;
    chip.setAttribute('data-active', isActive ? 'true' : 'false');
    chip.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
  document.querySelectorAll('[data-experience-item]').forEach((item) => {
    const tagAttr = item.getAttribute('data-tags') ?? '';
    const tagList = tagAttr
      .split(',')
      .map((tag) => tag.trim().toLowerCase())
      .filter(Boolean);
    const visible = tags.length === 0 || tagList.some((tag) => tags.includes(tag));
    if (!visible) {
      item.setAttribute('hidden', 'true');
    } else {
      item.removeAttribute('hidden');
    }
    const details = item.querySelector('[data-experience-card]');
    if (details) {
      details.setAttribute('aria-hidden', visible ? 'false' : 'true');
      if (!visible) {
        details.setAttribute('hidden', 'true');
        details.removeAttribute('open');
      } else {
        details.removeAttribute('hidden');
      }
    }
  });
  document.querySelectorAll('[data-case-study-card]').forEach((card) => {
    const tagAttr = card.getAttribute('data-tags') ?? '';
    const tagList = tagAttr
      .split(',')
      .map((tag) => tag.trim().toLowerCase())
      .filter(Boolean);
    const visible = tags.length === 0 || tagList.some((tag) => tags.includes(tag));
    card.setAttribute('aria-hidden', visible ? 'false' : 'true');
    if (!visible) {
      card.setAttribute('hidden', 'true');
    } else {
      card.removeAttribute('hidden');
    }
  });
};

const updateUrl = () => {
  const url = new URL(window.location.href);
  if (activeTags.size > 0) {
    url.searchParams.set('tags', serializeTags(Array.from(activeTags)));
  } else {
    url.searchParams.delete('tags');
  }
  history.replaceState(history.state, '', url.toString());
};

const bindKeywordChips = () => {
  document.querySelectorAll('[data-keyword-chip]').forEach((chip) => {
    if (chip.dataset.bound === 'true') return;
    chip.dataset.bound = 'true';
    chip.addEventListener('click', () => {
      const tag = chip.getAttribute('data-tag');
      if (!tag) return;
      if (activeTags.has(tag)) {
        activeTags.delete(tag);
      } else {
        activeTags.add(tag);
      }
      applyFilters();
      updateUrl();
    });
  });
};

const bindPrintExpansion = () => {
  if (printBound) return;
  let previousState = new Map();
  window.addEventListener('beforeprint', () => {
    previousState = new Map();
    document.querySelectorAll('[data-experience-card]').forEach((detail) => {
      previousState.set(detail, detail.hasAttribute('open'));
      detail.setAttribute('open', 'true');
    });
  });
  window.addEventListener('afterprint', () => {
    previousState.forEach((wasOpen, detail) => {
      if (!wasOpen) {
        detail.removeAttribute('open');
      }
    });
  });
  printBound = true;
};

const initialize = () => {
  bindKeywordChips();
  bindPrintExpansion();
  applyFilters();
};

initialize();

document.addEventListener('astro:page-load', () => {
  const url = new URL(window.location.href);
  activeTags = new Set(parseTags(url.searchParams.get('tags')));
  bindKeywordChips();
  applyFilters();
});
  </script>
</AppShell>
