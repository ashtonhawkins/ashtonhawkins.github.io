---
import { getCollection } from 'astro:content';
import Page from '../layouts/Page.astro';
import Nucleus from '../components/home/Nucleus.astro';
import SignalBar from '../components/ui/SignalBar.astro';
import ConsumptionSection from '../components/home/ConsumptionSection.astro';
import WordsSection from '../components/home/WordsSection.astro';
import TravelSection from '../components/home/TravelSection.astro';
import CyclingSection from '../components/home/CyclingSection.astro';
import BiometricsSection from '../components/home/BiometricsSection.astro';

const writingData = await (async () => {
  try {
    const posts = await getCollection('writing', ({ data }) => !data.draft);
    const latestPost = posts.sort((a, b) => {
      const aDate = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
      const bDate = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
      return bDate - aDate;
    })[0];

    if (!latestPost) return null;

    const tags = latestPost.data.description
      ? latestPost.data.description
        .split(',')
        .map((tag) => tag.trim())
        .filter(Boolean)
      : [];

    return {
      title: latestPost.data.title,
      category: tags[0] || 'Essay',
      tags,
      date: latestPost.data.pubDate ? new Date(latestPost.data.pubDate).toISOString() : new Date().toISOString(),
      slug: latestPost.slug,
      wordCount: latestPost.body.trim().split(/\s+/).filter(Boolean).length,
      paragraphCount: latestPost.body.split(/\n\n+/).map((paragraph) => paragraph.trim()).filter(Boolean).length
    };
  } catch (error) {
    console.error('[Nucleus] Failed to load writing collection:', error);
    return null;
  }
})();
---

<Page title="Ashton Hawkins">
  <script define:vars={{ writingData }}>
    window.__nucleusWritingData = writingData;
  </script>
  <Nucleus />
  <div class="dashboard container-shell max-wide">
    <SignalBar />
    <ConsumptionSection />
    <SignalBar />
    <WordsSection />
    <SignalBar />
    <TravelSection />
    <SignalBar />
    <CyclingSection />
    <SignalBar />
    <BiometricsSection />
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bars = document.querySelectorAll('[data-signal-bar]');
      if (!bars.length) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          const el = entry.target;
          if (!(el instanceof HTMLElement)) return;
          if (entry.isIntersecting && !el.dataset.pulsed) {
            el.style.height = '2px';
            el.style.backgroundColor = 'var(--accent-primary)';
            el.style.boxShadow = '0 0 8px var(--accent-primary)';

            setTimeout(() => {
              el.style.height = '1px';
              el.style.backgroundColor = 'var(--border)';
              el.style.boxShadow = 'none';
              el.dataset.pulsed = 'true';
            }, 800);
          }
        });
      }, { threshold: 0.5 });

      bars.forEach((bar) => observer.observe(bar));
    });
  </script>
</Page>

<style>
  .dashboard { display:grid; gap:.2rem; margin-top:0; padding-top:0; }
  .dashboard > .signal-bar:first-child { margin-top:1rem; }
</style>
